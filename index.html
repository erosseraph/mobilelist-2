<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.0.0</title>
    
    <!-- PWA é…ç½® -->
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ­Œå…å®šåˆ¶">
    
    <!-- å†…è” PWA Manifest é…ç½® -->
    <script type="application/manifest+json">
    {
      "name": "å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…",
      "short_name": "æ­Œå…å®šåˆ¶",
      "description": "ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#1a2a6c",
      "theme_color": "#1a2a6c",
      "orientation": "portrait",
      "scope": "/",
      "lang": "zh-CN",
      "categories": ["music", "entertainment", "shopping"],
      
      "icons": [
        {
          "src": "/icons/icon-72.png",
          "sizes": "72x72",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-96.png",
          "sizes": "96x96",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-128.png",
          "sizes": "128x128",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-144.png",
          "sizes": "144x144",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-152.png",
          "sizes": "152x152",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-192.png",
          "sizes": "192x192",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-384.png",
          "sizes": "384x384",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-512.png",
          "sizes": "512x512",
          "type": "image/png",
          "purpose": "any maskable"
        }
      ]
    }
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    
    <style>
        /* æ‰€æœ‰CSSæ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* å…¶ä»–æ‰€æœ‰CSSæ ·å¼ä¿æŒä¸å˜... */
        
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç™»å½• / æ³¨å†Œ</h2>
                <button class="close-btn" id="close-login">&times;</button>
            </div>
            
            <div class="login-methods">
                <button class="login-method-btn" id="email-login-btn">
                    ğŸ“§ é‚®ç®±ç™»å½•/æ³¨å†Œ
                </button>
                <button class="login-method-btn" id="google-login-btn">
                    ğŸ”µ Google ç™»å½•
                </button>
            </div>
            
            <div class="login-form" id="email-login-form">
                <div class="form-input-group">
                    <input type="email" id="email-input" placeholder="é‚®ç®±åœ°å€" required>
                    <input type="password" id="password-input" placeholder="å¯†ç " required>
                </div>
                <div class="form-actions">
                    <button class="form-btn login-submit" id="email-login-submit">ç™»å½•</button>
                    <button class="form-btn register-submit" id="email-register-submit">æ³¨å†Œ</button>
                </div>
                <button class="back-to-methods">â† è¿”å›ç™»å½•æ–¹å¼</button>
            </div>
            
            <div id="login-loading" style="display: none; text-align: center; padding: 20px;">
                å¤„ç†ä¸­...
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="logo">
                ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.0.0
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ğŸµ ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ğŸ’° ä»·æ ¼é…å¥—</button>
                <div class="admin-section" id="admin-section">
                    <a href="admin.html" class="admin-link">ğŸ‘‘ ç®¡ç†é¢æ¿</a>
                </div>
            </div>
            
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-email" id="user-email">ç”¨æˆ·</span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
            </div>
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- ç‚¹æ­Œç³»ç»Ÿé¡µé¢ -->
            <div id="karaoke-page">
                <div class="songs-section">
                    <div class="charts-container">
                        <div class="chart-category active" data-category="chinese-pop">åè¯­æµè¡Œ</div>
                        <div class="chart-category" data-category="western-pop">æ¬§ç¾æµè¡Œ</div>
                        <div class="chart-category" data-category="chinese-dj">ä¸­æ–‡DJ</div>
                        <div class="chart-category" data-category="chinese-artists">åè¯­æ­Œæ‰‹</div>
                        <div class="chart-category" data-category="western-artists">æ¬§ç¾æ­Œæ‰‹</div>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" class="search-input" id="search-input" placeholder="æœç´¢æ­Œæ›²åç§°ã€æ­Œæ‰‹...">
                        <button class="search-btn" id="search-btn">æœç´¢</button>
                        <button class="clear-btn" id="clear-btn">æ¸…ç©º</button>
                    </div>
                    
                    <div class="songs-container" id="songs-container">
                        <div class="loading">æ­£åœ¨åŠ è½½æ­Œæ›²...</div>
                    </div>
                </div>
                
                <div class="playlist-section">
                    <div class="playlist-header">
                        <div class="playlist-count">æˆ‘çš„æ­Œå• <span id="playlist-count">(0)</span></div>
                        <button class="share-btn" id="share-btn">åˆ†äº«æ­Œå•</button>
                    </div>
                    
                    <div class="playlist-items" id="playlist-items">
                        <div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>
                    </div>
                    
                    <div class="playlist-pagination" id="playlist-pagination"></div>
                </div>
            </div>
            
            <!-- ä»·æ ¼é…å¥—é¡µé¢ -->
            <div id="pricing-page">
                <div class="pricing-container">
                    <div class="pricing-card">
                        <div class="plan-name">åŸºç¡€ç‰ˆ</div>
                        <div class="price">RM 29</div>
                        <div class="song-range">1 - 20 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">æ ‡å‡†ç‰ˆ</div>
                        <div class="price">RM 49</div>
                        <div class="song-range">21 - 50 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card popular">
                        <div class="popular-badge">æœ€å—æ¬¢è¿</div>
                        <div class="plan-name">è¿›é˜¶ç‰ˆ</div>
                        <div class="price">RM 69</div>
                        <div class="song-range">51 - 100 é¦–æ­Œæ›²</div>
                        <button class="select-btn popular-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">è±ªåç‰ˆ</div>
                        <div class="price">RM 89</div>
                        <div class="song-range">101 - 200 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">ä¸“ä¸šç‰ˆ</div>
                        <div class="price">RM 109</div>
                        <div class="song-range">201 - 300 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">æ——èˆ°ç‰ˆ</div>
                        <div class="price">RM 129</div>
                        <div class="song-range">301 - 400 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">è‡³å°Šç‰ˆ</div>
                        <div class="price">RM 159</div>
                        <div class="song-range">401 - 500 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card custom">
                        <div class="plan-name">è‡ªå®šä¹‰ç‰ˆ</div>
                        <div class="price">RM 0.30/æ¯é¦–</div>
                        <div class="song-range">501+ é¦–æ­Œæ›²</div>
                        <button class="select-btn custom-btn">è”ç³»å®šåˆ¶</button>
                    </div>
                </div>
                
                <!-- é…é€ä¿¡æ¯ -->
                <div class="shipping-info">
                    <h3 style="text-align: center; margin: 30px 0 20px 0; color: white;">é…é€ä¿¡æ¯</h3>
                    <div class="shipping-options">
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">è¥¿é©¬</span>
                                <span class="shipping-price">å…è´¹é…é€</span>
                            </div>
                            <div class="shipping-desc">é¢„è®¡ 5-7 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">ä¸œé©¬</span>
                                <span class="shipping-price">RM 8.00</span>
                            </div>
                            <div class="shipping-desc">é¢„è®¡ 7-10 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                    </div>
                    <div class="shipping-note">
                        * æ‰€æœ‰é…å¥—å‡åŒ…å«å®Œæ•´çš„æŠ€æœ¯æ”¯æŒå’Œå”®åæœåŠ¡
                    </div>
                </div>
            </div>
            
            <!-- è®¢å•é¡µé¢ -->
            <div id="order-page">
                <h2 style="margin-bottom: 20px;">æäº¤è®¢å•</h2>
                
                <div class="order-form">
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="è¯·è¾“å…¥å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç”µè¯ *</label>
                        <input type="tel" class="form-input" id="customer-phone" placeholder="+60xxxxxxxx" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é‚®ç®± *</label>
                        <input type="email" class="form-input" id="customer-email" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ‰€åœ¨å·å± *</label>
                        <select class="form-select" id="customer-state" required>
                            <option value="">è¯·é€‰æ‹©å·å±</option>
                            <option value="west">è¥¿é©¬</option>
                            <option value="east">ä¸œé©¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">è¯¦ç»†åœ°å€ *</label>
                        <input type="text" class="form-input" id="customer-address" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€" required>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h3 style="margin-bottom: 15px;">è®¢å•æ‘˜è¦</h3>
                    <div id="order-playlist-preview">
                        <!-- æ­Œå•é¢„è§ˆå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="price-summary" id="price-summary">
                        <!-- ä»·æ ¼æ‘˜è¦å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="cancel-btn" id="cancel-order">å–æ¶ˆ</button>
                    <button class="submit-btn" id="submit-order">æäº¤è®¢å•</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯æµ®åŠ¨æ­Œå•æŒ‰é’® -->
    <button class="mobile-playlist-fab" id="mobile-playlist-fab">
        ğŸµ
        <div class="mobile-playlist-badge" id="mobile-playlist-badge">0</div>
    </button>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-bottom-bar">
        <button class="mobile-bottom-btn active" data-page="karaoke">
            <span style="font-size: 1.2rem;">ğŸ¤</span>
            <span>ç‚¹æ­Œ</span>
        </button>
        <button class="mobile-bottom-btn" data-page="pricing">
            <span style="font-size: 1.2rem;">ğŸ’°</span>
            <span>ä»·æ ¼</span>
        </button>
        <button class="mobile-bottom-btn" onclick="showOrderPage()">
            <span style="font-size: 1.2rem;">ğŸ›’</span>
            <span>è®¢å•</span>
        </button>
    </div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player hidden" id="audio-player">
        <div class="audio-info" id="audio-info">è¯•å¬ä¸­...</div>
        <div class="audio-controls">
            <button id="play-pause-btn">â¸ï¸</button>
            <button id="stop-btn">â¹ï¸</button>
        </div>
    </div>

    <script>
        // ==================== Firebase é…ç½® ====================
        function getFirebaseConfig() {
            return {
                apiKey: "AIzaSyAMn7EOOUDpIGXzA8EhPBtLWw7BwyU2Rdc",
                authDomain: "karaoke-customizer.firebaseapp.com",
                projectId: "karaoke-customizer",
                storageBucket: "karaoke-customizer.firebasestorage.app",
                messagingSenderId: "593643512892",
                appId: "1:593643512892:web:c21ec4ce7c2d286fed4f39",
                measurementId: "G-D791D33Y6R"
            };
        }

        // ==================== åº”ç”¨çŠ¶æ€å˜é‡ ====================
        let firebaseApp, auth, firestore, analytics;
        let currentUser = null;
        let currentSongs = [];
        let playlist = [];
        let currentAudio = null;
        let isPlaying = false;
        let isSearchResultsView = false;
        let currentPlaylistPage = 1;
        const SONGS_PER_PAGE = 10;

        // ==================== Firebase åˆå§‹åŒ– ====================
        function initializeFirebase() {
            try {
                const firebaseConfig = getFirebaseConfig();
                console.log('ğŸ”§ Firebase é…ç½®:', firebaseConfig);
                
                // ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬åˆå§‹åŒ–
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                analytics = firebaseApp.analytics();
                
                console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬
                auth.onAuthStateChanged(handleAuthStateChange);
                
                // è®°å½•åˆ†æäº‹ä»¶
                analytics.logEvent('app_initialized');
                
            } catch (error) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ==================== è®¤è¯çŠ¶æ€ç®¡ç† ====================
        function handleAuthStateChange(user) {
            if (user) {
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.email);
                currentUser = user;
                updateUserUI();
                loadUserPlaylistFromFirestore();
                checkAdminAccess(user);
            } else {
                console.log('âŒ ç”¨æˆ·å·²é€€å‡º');
                currentUser = null;
                updateUserUI();
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                
                const adminSection = document.getElementById('admin-section');
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
            }
        }

        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const userAvatar = document.getElementById('user-avatar');
            const loginBtn = document.getElementById('login-btn');
            
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                
                if (userAvatar) userAvatar.textContent = initial;
                if (userEmail) userEmail.textContent = displayName;
                if (userInfo) userInfo.style.display = 'flex';
                if (loginBtn) loginBtn.style.display = 'none';
            } else {
                if (userInfo) userInfo.style.display = 'none';
                if (loginBtn) loginBtn.style.display = 'block';
            }
        }

        // ==================== ç®¡ç†å‘˜æƒé™æ£€æŸ¥ ====================
        function checkAdminAccess(user) {
            const adminEmails = [
                'admin@karaoke.com',
                'erosseraph@gmail.com'
            ];
            
            const adminSection = document.getElementById('admin-section');
            if (adminSection && adminEmails.includes(user.email)) {
                adminSection.style.display = 'block';
                console.log('ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²æˆäºˆ');
            } else if (adminSection) {
                adminSection.style.display = 'none';
            }
        }

        // ==================== è®¤è¯åŠŸèƒ½ ====================
        async function handleEmailLogin() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                showMessage(`æ¬¢è¿å›æ¥ï¼Œ${result.user.email}`);
                document.getElementById('login-modal').style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±ç™»å½•å¤±è´¥:', error);
                showMessage(`ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleEmailRegister() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                return;
            }

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                showMessage(`æ³¨å†ŒæˆåŠŸï¼Œæ¬¢è¿ ${result.user.email}`);
                document.getElementById('login-modal').style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±æ³¨å†Œå¤±è´¥:', error);
                showMessage(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            }
        }

        async function handleGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showMessage(`æ¬¢è¿ï¼Œ${result.user.displayName}`);
                document.getElementById('login-modal').style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('Googleç™»å½•å¤±è´¥:', error);
                showMessage(`Googleç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                showMessage('å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMessage('é€€å‡ºç™»å½•å¤±è´¥');
            }
        }

        function resetLoginForms() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            
            const emailLoginForm = document.getElementById('email-login-form');
            if (emailLoginForm) emailLoginForm.style.display = 'none';
            
            const loginMethods = document.querySelector('.login-methods');
            if (loginMethods) loginMethods.style.display = 'flex';
        }

        function showLoginMethod(method) {
            const loginMethods = document.querySelector('.login-methods');
            if (loginMethods) loginMethods.style.display = 'none';
            
            if (method === 'email') {
                const emailLoginForm = document.getElementById('email-login-form');
                if (emailLoginForm) emailLoginForm.style.display = 'block';
            }
        }

        // ==================== Firestore æ•°æ®ç®¡ç† ====================
        async function saveUserPlaylistToFirestore() {
            if (!currentUser) return;

            try {
                await firestore.collection('playlists').doc(currentUser.uid).set({
                    songs: playlist,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    songCount: playlist.length,
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                console.log('âœ… æ­Œå•å·²ä¿å­˜åˆ° Firestore');
            } catch (error) {
                console.error('ä¿å­˜æ­Œå•åˆ° Firestore å¤±è´¥:', error);
                saveUserPlaylistToLocal();
            }
        }

        async function loadUserPlaylistFromFirestore() {
            if (!currentUser) return;

            try {
                const doc = await firestore.collection('playlists').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    playlist = data.songs || [];
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage('å·²ä»äº‘ç«¯åŠ è½½æ‚¨çš„æ­Œå•');
                }
            } catch (error) {
                console.error('ä» Firestore åŠ è½½æ­Œå•å¤±è´¥:', error);
                loadUserPlaylistFromLocal();
            }
        }

        function saveUserPlaylistToLocal() {
            if (!currentUser) return;
            try {
                localStorage.setItem(`playlist_${currentUser.uid}`, JSON.stringify(playlist));
            } catch (e) {
                console.error('ä¿å­˜æ­Œå•åˆ°æœ¬åœ°å¤±è´¥:', e);
            }
        }

        function loadUserPlaylistFromLocal() {
            if (!currentUser) return;
            const savedPlaylist = localStorage.getItem(`playlist_${currentUser.uid}`);
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                    renderPlaylist();
                    updatePlaylistCount();
                } catch (e) {
                    console.error('ä»æœ¬åœ°åŠ è½½æ­Œå•å¤±è´¥:', e);
                }
            }
        }

        // ==================== é¡µé¢å¯¼èˆªåŠŸèƒ½ ====================
        function initPageNavigation() {
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            
            if (karaokeNav) {
                karaokeNav.addEventListener('click', function() {
                    showPage('karaoke');
                    setActiveNav(this);
                });
            }
            
            if (pricingNav) {
                pricingNav.addEventListener('click', function() {
                    showPage('pricing');
                    setActiveNav(this);
                });
            }
        }
        
        function showPage(page) {
            const karaokePage = document.getElementById('karaoke-page');
            const pricingPage = document.getElementById('pricing-page');
            const orderPage = document.getElementById('order-page');
            
            if (karaokePage) karaokePage.style.display = page === 'karaoke' ? 'flex' : 'none';
            if (pricingPage) pricingPage.style.display = page === 'pricing' ? 'block' : 'none';
            if (orderPage) orderPage.style.display = page === 'order' ? 'block' : 'none';
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // ==================== æœç´¢é…ç½® ====================
        function getSearchConfig(term, category) {
            const configs = {
                'chinese-pop': {
                    searchTerms: [
                        'popular music',
                        'top hits',
                        'chart music'
                    ],
                    country: 'US',
                    description: 'å…¨çƒçƒ­é—¨åè¯­æ­Œæ›²'
                },
                'western-pop': {
                    searchTerms: [
                        'billboard hot 100',
                        'spotify top 50',
                        'popular songs'
                    ],
                    country: 'US',
                    description: 'æ¬§ç¾æµè¡Œçƒ­æ­Œ'
                },
                'chinese-dj': {
                    searchTerms: [
                        'edm',
                        'dance music',
                        'electronic'
                    ],
                    country: 'US',
                    description: 'çƒ­é—¨ç”µå­éŸ³ä¹'
                }
            };
            
            return configs[category] || {
                searchTerms: [term],
                country: 'US',
                description: 'è‡ªå®šä¹‰æœç´¢'
            };
        }

        // ==================== æ™ºèƒ½éŸ³ä¹æœç´¢åŠŸèƒ½ ====================
        async function searchMusic(term, category = 'musicTrack', limit = 50) {
            try {
                showLoading('æ­£åœ¨æœç´¢çƒ­é—¨æ­Œæ›²...');
                
                const searchConfig = getSearchConfig(term, category);
                let allResults = [];
                
                console.log('ğŸ” å¼€å§‹æ™ºèƒ½æœç´¢...');
                
                for (let i = 0; i < searchConfig.searchTerms.length; i++) {
                    const searchTerm = searchConfig.searchTerms[i];
                    
                    try {
                        console.log(`æœç´¢: ${searchTerm}`);
                        const results = await performSingleSearch(searchTerm, category, 20, searchConfig.country);
                        
                        results.forEach(song => {
                            const exists = allResults.some(existing => existing.id === song.id);
                            if (!exists) {
                                allResults.push(song);
                            }
                        });
                        
                        console.log(`æœç´¢å®Œæˆï¼Œå½“å‰æ€»æ•°: ${allResults.length}`);
                        
                        if (allResults.length >= limit) {
                            break;
                        }
                    } catch (error) {
                        console.warn(`æœç´¢å¤±è´¥: ${searchTerm}`, error);
                    }
                }
                
                console.log(`ğŸµ æœç´¢å®Œæˆï¼Œå…±æ‰¾åˆ° ${allResults.length} é¦–æ­Œæ›²`);
                
                if (allResults.length === 0) {
                    showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œè¯·å°è¯•å…¶ä»–æœç´¢è¯');
                    return [];
                }
                
                const sortedResults = smartSortResults(allResults, term);
                return sortedResults.slice(0, limit);
                
            } catch (error) {
                console.error('æœç´¢è¿‡ç¨‹å‡ºé”™:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return [];
            }
        }

        async function performSingleSearch(term, category, limit, country = 'US') {
            try {
                let url;
                
                if (term === '') {
                    url = `https://itunes.apple.com/search?term=popular&entity=${category}&limit=${limit}&country=${country}&lang=en_us`;
                } else {
                    const encodedTerm = encodeURIComponent(term);
                    url = `https://itunes.apple.com/search?term=${encodedTerm}&entity=${category}&limit=${limit}&country=${country}&lang=en_us`;
                }
                
                console.log(`ğŸ” æœç´¢è¯·æ±‚: ${url}`);
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn(`æœç´¢è¯·æ±‚å¤±è´¥: ${response.status}`);
                    return [];
                }
                
                const data = await response.json();
                console.log(`ğŸ“Š æœç´¢ç»“æœ: ${data.resultCount} æ¡`);
                
                if (data.resultCount === 0) return [];
                
                return data.results.map(track => ({
                    id: track.trackId || Math.random().toString(36).substr(2, 9),
                    title: track.trackName || 'æœªçŸ¥æ­Œæ›²',
                    artist: track.artistName || 'æœªçŸ¥æ­Œæ‰‹',
                    album: track.collectionName || 'æœªçŸ¥ä¸“è¾‘',
                    duration: track.trackTimeMillis,
                    previewUrl: track.previewUrl,
                    artwork: track.artworkUrl100?.replace('100x100', '300x300') || track.artworkUrl100,
                    popularity: track.trackNumber || Math.random()
                })).filter(track => {
                    return track.previewUrl && 
                           track.title && 
                           track.artist &&
                           !track.title.toLowerCase().includes('karaoke') &&
                           !track.artist.toLowerCase().includes('karaoke');
                });
                
            } catch (error) {
                console.warn(`æœç´¢ "${term}" å¤±è´¥:`, error);
                return [];
            }
        }

        function smartSortResults(results, originalTerm) {
            return results.sort((a, b) => {
                const coverScore = (b.artwork ? 1 : 0) - (a.artwork ? 1 : 0);
                if (coverScore !== 0) return coverScore;
                
                const titleMatchA = a.title.toLowerCase().includes(originalTerm.toLowerCase()) ? 1 : 0;
                const titleMatchB = b.title.toLowerCase().includes(originalTerm.toLowerCase()) ? 1 : 0;
                if (titleMatchA !== titleMatchB) return titleMatchB - titleMatchA;
                
                const artistMatchA = a.artist.toLowerCase().includes(originalTerm.toLowerCase()) ? 1 : 0;
                const artistMatchB = b.artist.toLowerCase().includes(originalTerm.toLowerCase()) ? 1 : 0;
                if (artistMatchA !== artistMatchB) return artistMatchB - artistMatchA;
                
                return (b.popularity || 0) - (a.popularity || 0);
            });
        }

        // ==================== æ’è¡Œæ¦œåŠ è½½åŠŸèƒ½ ====================
        async function loadChart(category) {
            isSearchResultsView = false;
            
            const chartConfig = {
                'chinese-pop': {
                    name: 'åè¯­æµè¡Œ',
                    description: 'çƒ­é—¨åè¯­æ­Œæ›²æ¦œ'
                },
                'western-pop': {
                    name: 'æ¬§ç¾æµè¡Œ', 
                    description: 'å…¨çƒçƒ­é—¨æ¬§ç¾æ­Œæ›²'
                },
                'chinese-dj': {
                    name: 'ä¸­æ–‡DJ',
                    description: 'çƒ­é—¨ç”µå­èˆæ›²'
                },
                'chinese-artists': {
                    type: 'artists',
                    artists: ['å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿']
                },
                'western-artists': {
                    type: 'artists', 
                    artists: ['Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish', 'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars']
                }
            };
            
            const config = chartConfig[category];
            if (!config) return;
            
            console.log(`ğŸ“Š åŠ è½½ ${config.name} æ’è¡Œæ¦œ...`);
            
            if (config.type === 'artists') {
                renderArtistsList(config.artists);
                return;
            }
            
            currentSongs = await searchMusic('popular', 'musicTrack', 50);
            
            if (currentSongs.length < 20) {
                console.log('ğŸ” ç»“æœè¾ƒå°‘ï¼Œä½¿ç”¨å¤‡ç”¨æœç´¢è¯...');
                try {
                    const backupResults = await searchMusic('hits', 'musicTrack', 30);
                    const existingIds = new Set(currentSongs.map(song => song.id));
                    backupResults.forEach(song => {
                        if (!existingIds.has(song.id)) {
                            currentSongs.push(song);
                        }
                    });
                } catch (error) {
                    console.warn('å¤‡ç”¨æœç´¢å¤±è´¥:', error);
                }
            }
            
            renderSongs(currentSongs);
            updateChartTitle(config.name, config.description);
            
            document.querySelectorAll('.chart-category').forEach(chart => {
                chart.classList.remove('active');
            });
            const activeChart = document.querySelector(`[data-category="${category}"]`);
            if (activeChart) activeChart.classList.add('active');
        }

        function updateChartTitle(name, description) {
            const songsContainer = document.getElementById('songs-container');
            if (!songsContainer) return;
            
            const existingTitle = songsContainer.querySelector('.chart-title');
            if (existingTitle) {
                existingTitle.remove();
            }
            
            const titleElement = document.createElement('div');
            titleElement.className = 'chart-title';
            titleElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <h3 style="margin: 0 0 5px 0; color: white;">${name}</h3>
                    <p style="margin: 0; opacity: 0.8; font-size: 0.9rem;">${description}</p>
                </div>
            `;
            
            songsContainer.insertBefore(titleElement, songsContainer.firstChild);
        }

        function renderArtistsList(artists) {
            const songsContainer = document.getElementById('songs-container');
            if (!songsContainer) return;
            
            songsContainer.innerHTML = '';
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">æ­Œæ‰‹</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
        }

        function renderSongs(songs) {
            const songsContainer = document.getElementById('songs-container');
            if (!songsContainer) return;
            
            songsContainer.innerHTML = '';
            
            if (songs.length === 0) {
                songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                return;
            }
            
            if (isSearchResultsView) {
                const backButton = document.createElement('button');
                backButton.className = 'back-btn';
                backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
                backButton.addEventListener('click', () => {
                    isSearchResultsView = false;
                    loadChart('chinese-pop');
                });
                songsContainer.appendChild(backButton);
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}">â–¶ï¸</button>` : ''}
                        <button class="add-btn" data-id="${song.id}">+</button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
        }

        // ==================== æ­Œå•ç®¡ç†åŠŸèƒ½ ====================
        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist-items');
            if (!playlistContainer) return;
            
            playlistContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
                renderPlaylistPagination();
                return;
            }
            
            const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
            const currentSongs = playlist.slice(startIndex, endIndex);
            
            currentSongs.forEach((song, index) => {
                const globalIndex = startIndex + index;
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.draggable = true;
                playlistItem.dataset.index = globalIndex;
                playlistItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="song-number">${globalIndex + 1}</div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            renderPlaylistPagination();
            setupDragAndDrop();
        }

        function renderPlaylistPagination() {
            const playlistPagination = document.getElementById('playlist-pagination');
            if (!playlistPagination) return;
            
            playlistPagination.innerHTML = '';
            
            if (playlist.length <= SONGS_PER_PAGE) return;
            
            const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
            
            if (currentPlaylistPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                prevButton.addEventListener('click', () => {
                    currentPlaylistPage--;
                    renderPlaylist();
                });
                playlistPagination.appendChild(prevButton);
            }
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPlaylistPage);
                pageButton.addEventListener('click', () => {
                    currentPlaylistPage = i;
                    renderPlaylist();
                });
                playlistPagination.appendChild(pageButton);
            }
            
            if (currentPlaylistPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                nextButton.addEventListener('click', () => {
                    currentPlaylistPage++;
                    renderPlaylist();
                });
                playlistPagination.appendChild(nextButton);
            }
        }

        function updatePlaylistCount() {
            const playlistCount = document.getElementById('playlist-count');
            if (playlistCount) {
                playlistCount.textContent = `(${playlist.length})`;
            }
        }

        function addSongToPlaylist(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song) {
                if (!playlist.some(s => s.id == songId)) {
                    playlist.push({...song});
                    currentPlaylistPage = 1;
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                    
                    if (currentUser) saveUserPlaylistToFirestore();
                    else saveUserPlaylistToLocal();
                } else {
                    showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
                }
            } else {
                showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
            }
        }

        function removeSongFromPlaylist(index) {
            if (index >= 0 && index < playlist.length) {
                const songTitle = playlist[index].title;
                playlist.splice(index, 1);
                
                const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
                if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                    currentPlaylistPage--;
                }
                
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }

        // ==================== éŸ³é¢‘æ’­æ”¾åŠŸèƒ½ ====================
        function previewSong(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song && song.previewUrl) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                currentAudio = new Audio(song.previewUrl);
                currentAudio.play();
                isPlaying = true;
                
                const playPauseBtn = document.getElementById('play-pause-btn');
                if (playPauseBtn) playPauseBtn.textContent = "â¸ï¸";
                
                const audioPlayer = document.getElementById('audio-player');
                const audioInfo = document.getElementById('audio-info');
                
                if (audioPlayer) audioPlayer.classList.remove('hidden');
                if (audioInfo) audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
                showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
                
                currentAudio.addEventListener('ended', () => {
                    stopAudio();
                });
            } else {
                showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
            }
        }

        function togglePlayPause() {
            if (currentAudio) {
                if (isPlaying) {
                    currentAudio.pause();
                    const playPauseBtn = document.getElementById('play-pause-btn');
                    if (playPauseBtn) playPauseBtn.textContent = "â–¶ï¸";
                } else {
                    currentAudio.play();
                    const playPauseBtn = document.getElementById('play-pause-btn');
                    if (playPauseBtn) playPauseBtn.textContent = "â¸ï¸";
                }
                isPlaying = !isPlaying;
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isPlaying = false;
                const playPauseBtn = document.getElementById('play-pause-btn');
                if (playPauseBtn) playPauseBtn.textContent = "â–¶ï¸";
                
                const audioPlayer = document.getElementById('audio-player');
                if (audioPlayer) audioPlayer.classList.add('hidden');
            }
        }

        // ==================== äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ====================
        function setupEventListeners() {
            const chartsContainer = document.getElementById('charts-container');
            const songsContainer = document.getElementById('songs-container');
            const playlistContainer = document.getElementById('playlist-items');
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-btn');
            const shareBtn = document.getElementById('share-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const loginBtn = document.getElementById('login-btn');
            const closeLoginBtn = document.getElementById('close-login');
            const emailLoginBtn = document.getElementById('email-login-btn');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const emailLoginSubmit = document.getElementById('email-login-submit');
            const emailRegisterSubmit = document.getElementById('email-register-submit');
            const logoutBtn = document.getElementById('logout-btn');

            if (chartsContainer) {
                chartsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('chart-category')) {
                        const category = e.target.dataset.category;
                        loadChart(category);
                    }
                });
            }
            
            if (songsContainer) {
                songsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-btn')) {
                        const songId = e.target.dataset.id;
                        const artist = e.target.dataset.artist;
                        
                        if (artist) {
                            performSearch(artist);
                        } else if (songId) {
                            addSongToPlaylist(songId);
                        }
                    } else if (e.target.classList.contains('preview-btn')) {
                        const songId = e.target.dataset.id;
                        previewSong(songId);
                    }
                });
            }
            
            if (playlistContainer) {
                playlistContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-btn')) {
                        const index = parseInt(e.target.dataset.index);
                        removeSongFromPlaylist(index);
                    }
                });
            }
            
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', () => {
                    const query = searchInput.value.trim();
                    if (query) performSearch(query);
                });
            }
            
            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        const query = searchInput.value.trim();
                        if (query) performSearch(query);
                    }
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', clearPlaylist);
            }
            
            if (shareBtn) {
                shareBtn.addEventListener('click', sharePlaylist);
            }
            
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', togglePlayPause);
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', stopAudio);
            }
            
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    document.getElementById('login-modal').style.display = 'flex';
                });
            }
            
            if (closeLoginBtn) {
                closeLoginBtn.addEventListener('click', () => {
                    document.getElementById('login-modal').style.display = 'none';
                    resetLoginForms();
                });
            }
            
            if (emailLoginBtn) {
                emailLoginBtn.addEventListener('click', () => showLoginMethod('email'));
            }
            
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', handleGoogleLogin);
            }
            
            if (emailLoginSubmit) {
                emailLoginSubmit.addEventListener('click', handleEmailLogin);
            }
            
            if (emailRegisterSubmit) {
                emailRegisterSubmit.addEventListener('click', handleEmailRegister);
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            document.querySelectorAll('.back-to-methods').forEach(btn => {
                btn.addEventListener('click', resetLoginForms);
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('login-modal')) {
                    document.getElementById('login-modal').style.display = 'none';
                    resetLoginForms();
                }
            });
        }

        async function performSearch(query) {
            isSearchResultsView = true;
            currentSongs = await searchMusic(query, 'musicTrack', 50);
            renderSongs(currentSongs);
        }

        function clearPlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
                playlist = [];
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage('æ­Œå•å·²æ¸…ç©º');
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }

        function sharePlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«');
                return;
            }
            
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œåˆ†äº«æ­Œå•');
                document.getElementById('login-modal').style.display = 'flex';
                return;
            }
            
            showOrderPage();
        }

        // ==================== è®¢å•åŠŸèƒ½ ====================
        function showOrderPage() {
            showPage('order');
            setActiveNav(null);
            
            if (currentUser) {
                const customerEmail = document.getElementById('customer-email');
                const customerName = document.getElementById('customer-name');
                
                if (customerEmail) customerEmail.value = currentUser.email || '';
                if (customerName && currentUser.displayName) {
                    customerName.value = currentUser.displayName;
                }
            }
            
            renderOrderPlaylistPreview();
            calculateAndDisplayPrice();
        }

        function renderOrderPlaylistPreview() {
            const previewContainer = document.getElementById('order-playlist-preview');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
                return;
            }
            
            const displaySongs = playlist.slice(0, 10);
            
            displaySongs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'playlist-preview-item';
                songElement.textContent = `${index + 1}. ${song.title} - ${song.artist}`;
                previewContainer.appendChild(songElement);
            });
            
            if (playlist.length > 10) {
                const moreElement = document.createElement('div');
                moreElement.className = 'playlist-preview-item';
                moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 10} é¦–æ­Œæ›²`;
                moreElement.style.fontStyle = 'italic';
                previewContainer.appendChild(moreElement);
            }
            
            const countElement = document.createElement('div');
            countElement.className = 'playlist-preview-item';
            countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
            countElement.style.fontWeight = 'bold';
            countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
            countElement.style.paddingTop = '10px';
            countElement.style.marginTop = '10px';
            previewContainer.appendChild(countElement);
        }

        function calculateAndDisplayPrice() {
            const songCount = playlist.length;
            const stateSelect = document.getElementById('customer-state');
            const state = stateSelect ? stateSelect.value : 'west';
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const priceSummary = document.getElementById('price-summary');
            if (priceSummary) {
                priceSummary.innerHTML = `
                    <div class="price-row">
                        <span>æ¨èé…å¥—ï¼š</span>
                        <span>${packageName} (${songCount}é¦–)</span>
                    </div>
                    <div class="price-row">
                        <span>é…å¥—ä»·æ ¼ï¼š</span>
                        <span>${packageName === 'è‡ªå®šä¹‰ç‰ˆ' ? `RM${packagePrice.toFixed(2)}` : `RM${packagePrice.toFixed(2)}`}</span>
                    </div>
                    <div class="price-row">
                        <span>é‚®è´¹ï¼š</span>
                        <span>${shippingFee === 0 ? 'å…è´¹' : `RM${shippingFee.toFixed(2)}`}</span>
                    </div>
                    <div class="price-row total-price">
                        <span>æ€»è´¹ç”¨ï¼š</span>
                        <span>RM${totalPrice.toFixed(2)}</span>
                    </div>
                    ${packageName === 'è‡ªå®šä¹‰ç‰ˆ' ? `
                    <div class="price-row" style="color: #ffd700; font-size: 0.9rem;">
                        <span>å¤‡æ³¨ï¼š</span>
                        <span>è‡ªå®šä¹‰é…å¥—è¯·è”ç³»å®¢æœç¡®è®¤æœ€ç»ˆä»·æ ¼</span>
                    </div>
                    ` : ''}
                `;
            }
        }

        function initOrderFunctions() {
            const customerState = document.getElementById('customer-state');
            const cancelOrderBtn = document.getElementById('cancel-order');
            const submitOrderBtn = document.getElementById('submit-order');
            
            if (customerState) {
                customerState.addEventListener('change', calculateAndDisplayPrice);
            }
            
            if (cancelOrderBtn) {
                cancelOrderBtn.addEventListener('click', function() {
                    showPage('karaoke');
                    setActiveNav(document.getElementById('karaoke-nav'));
                });
            }
            
            if (submitOrderBtn) {
                submitOrderBtn.addEventListener('click', async function() {
                    const nameInput = document.getElementById('customer-name');
                    const phoneInput = document.getElementById('customer-phone');
                    const emailInput = document.getElementById('customer-email');
                    const addressInput = document.getElementById('customer-address');
                    const stateSelect = document.getElementById('customer-state');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    const phone = phoneInput ? phoneInput.value.trim() : '';
                    const email = emailInput ? emailInput.value.trim() : '';
                    const address = addressInput ? addressInput.value.trim() : '';
                    const state = stateSelect ? stateSelect.value : '';
                    
                    if (!name || !phone || !email || !address || !state) {
                        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                        return;
                    }
                    
                    const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
                    if (!malaysiaPhoneRegex.test(phone)) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
                        return;
                    }
                    
                    await createOrder(name, phone, email, address, state);
                });
            }
        }

        async function createOrder(name, phone, email, address, state) {
            const songCount = playlist.length;
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const orderId = 'KTV' + new Date().getTime();
            
            const order = {
                orderId: orderId,
                customerInfo: {
                    name: name,
                    phone: phone,
                    email: email,
                    address: address,
                    state: state
                },
                playlist: [...playlist],
                pricing: {
                    package: packageName,
                    songCount: songCount,
                    packagePrice: packagePrice,
                    shippingFee: shippingFee,
                    totalPrice: totalPrice
                },
                orderDate: new Date().toISOString(),
                status: 'pending',
                userId: currentUser ? currentUser.uid : null
            };

            try {
                await firestore.collection('orders').doc(orderId).set(order);
                console.log('âœ… è®¢å•å·²ä¿å­˜åˆ° Firestore');
                
                alert(`âœ… è®¢å•æäº¤æˆåŠŸï¼\nè®¢å•ç¼–å·: ${order.orderId}\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
                
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                if (currentUser) saveUserPlaylistToFirestore();
                
                showPage('karaoke');
                setActiveNav(document.getElementById('karaoke-nav'));
                
            } catch (error) {
                console.error('è®¢å•æäº¤å¤±è´¥:', error);
                alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
            }
        }

        // ==================== æ‹–æ‹½åŠŸèƒ½ ====================
        function setupDragAndDrop() {
            const playlistContainer = document.getElementById('playlist-items');
            if (!playlistContainer) return;
            
            const items = playlistContainer.querySelectorAll('.playlist-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
            
            playlistContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(playlistContainer, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable && afterElement) {
                    playlistContainer.insertBefore(draggable, afterElement);
                } else if (draggable) {
                    playlistContainer.appendChild(draggable);
                }
            });
            
            playlistContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const items = Array.from(playlistContainer.querySelectorAll('.playlist-item'));
                const toIndex = items.findIndex(item => item.classList.contains('dragging'));
                
                if (fromIndex !== toIndex && toIndex !== -1) {
                    const [movedItem] = playlist.splice(fromIndex, 1);
                    playlist.splice(toIndex, 0, movedItem);
                    
                    renderPlaylist();
                    showMessage('æ­Œå•é¡ºåºå·²æ›´æ–°');
                    
                    if (currentUser) saveUserPlaylistToFirestore();
                    else saveUserPlaylistToLocal();
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // ==================== ç§»åŠ¨ç«¯åŠŸèƒ½ ====================
        function initMobileFeatures() {
            const fab = document.getElementById('mobile-playlist-fab');
            const badge = document.getElementById('mobile-playlist-badge');
            
            if (fab) {
                fab.addEventListener('click', () => {
                    document.querySelector('.playlist-section').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                });
            }
            
            function updatePlaylistBadge() {
                const count = playlist.length;
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                }
            }
            
            const originalUpdatePlaylistCount = updatePlaylistCount;
            updatePlaylistCount = function() {
                originalUpdatePlaylistCount();
                updatePlaylistBadge();
            };
            
            document.querySelectorAll('.mobile-bottom-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    
                    document.querySelectorAll('.mobile-bottom-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    if (page === 'karaoke') {
                        showPage('karaoke');
                        setActiveNav(document.getElementById('karaoke-nav'));
                    } else if (page === 'pricing') {
                        showPage('pricing');
                        setActiveNav(document.getElementById('pricing-nav'));
                    }
                });
            });
            
            updatePlaylistBadge();
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function showMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                z-index: 1000;
                transition: all 0.3s;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }

        function showLoading(message) {
            const songsContainer = document.getElementById('songs-container');
            if (songsContainer) {
                songsContainer.innerHTML = `<div class="loading">${message}</div>`;
            }
        }

        function showError(message) {
            const songsContainer = document.getElementById('songs-container');
            if (songsContainer) {
                songsContainer.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // ==================== ä»·æ ¼é…å¥—åŠŸèƒ½ ====================
        function initPricingButtons() {
            document.querySelectorAll('.select-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const pricingCard = this.closest('.pricing-card');
                    if (pricingCard) {
                        const planName = pricingCard.querySelector('.plan-name').textContent;
                        const price = pricingCard.querySelector('.price').textContent;
                        const songRange = pricingCard.querySelector('.song-range').textContent;
                        
                        if (planName === 'è‡ªå®šä¹‰ç‰ˆ') {
                            alert(`ğŸ“ è¯·è”ç³»æˆ‘ä»¬å®šåˆ¶ ${songRange} çš„ä¸“å±æ–¹æ¡ˆ\nä»·æ ¼: ${price}\n\nè¯·ç‚¹å‡»"åˆ†äº«æ­Œå•"åè”ç³»å®¢æœã€‚`);
                        } else {
                            alert(`âœ… æ‚¨é€‰æ‹©äº† ${planName}\næ­Œæ›²èŒƒå›´: ${songRange}\nä»·æ ¼: ${price}\n\nè¯·ç‚¹å‡»"åˆ†äº«æ­Œå•"æäº¤è®¢å•ã€‚`);
                        }
                    }
                });
            });
        }

        // ==================== ç´§æ€¥æŒ‰é’®ä¿®å¤ ====================
        function emergencyFixAllButtons() {
            console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥æŒ‰é’®ä¿®å¤...');
            
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            
            if (karaokeNav) {
                karaokeNav.onclick = function() {
                    console.log('ğŸµ åˆ‡æ¢åˆ°ç‚¹æ­Œé¡µé¢');
                    showPage('karaoke');
                    setActiveNav(this);
                };
            }
            
            if (pricingNav) {
                pricingNav.onclick = function() {
                    console.log('ğŸ’° åˆ‡æ¢åˆ°ä»·æ ¼é¡µé¢');
                    showPage('pricing');
                    setActiveNav(this);
                };
            }
            
            const chartButtons = document.querySelectorAll('.chart-category');
            chartButtons.forEach(btn => {
                btn.onclick = function() {
                    const category = this.getAttribute('data-category');
                    console.log(`ğŸ“Š åŠ è½½æ’è¡Œæ¦œ: ${category}`);
                    loadChart(category);
                };
            });
            
            console.log('âœ… ç´§æ€¥æŒ‰é’®ä¿®å¤å®Œæˆ');
        }

        // ==================== ä¸»åˆå§‹åŒ–å‡½æ•° ====================
        function initKaraoke() {
            console.log('ğŸµ åˆå§‹åŒ–ç‚¹æ­Œç³»ç»Ÿ...');
            
            setupEventListeners();
            initPageNavigation();
            initPricingButtons();
            initOrderFunctions();
            updatePlaylistCount();
            loadChart('chinese-pop');
            initMobileFeatures();
            emergencyFixAllButtons();
            
            console.log('âœ… ç‚¹æ­Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        // ==================== åº”ç”¨å¯åŠ¨ ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            
            initializeFirebase();
            
            setTimeout(() => {
                initKaraoke();
            }, 100);
        });

        // ==================== PWA Service Worker æ³¨å†Œ ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('âœ… ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('âŒ ServiceWorker æ³¨å†Œå¤±è´¥: ', error);
                    });
            });
        }
    </script>
</body>
</html>
