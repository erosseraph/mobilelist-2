<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.5.0 - å®Œæ•´ä¿®å¤ç‰ˆ</title>
    
    <link rel="icon" href="/favicon.ico">
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: white; min-height: 100vh; padding-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin-bottom: 20px; }
        .logo { font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); }
        .nav-btn:hover, .nav-btn.active { background: rgba(255, 255, 255, 0.2); }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .login-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .user-info { display: none; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.1); padding: 8px 15px; border-radius: 25px; }
        .user-avatar { width: 32px; height: 32px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .logout-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; }
        .page-container { min-height: 600px; }
        #karaoke-page { display: flex; gap: 20px; }
        .songs-section { flex: 2; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; }
        .playlist-section { flex: 1; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; max-height: 700px; overflow-y: auto; }
        .mobile-tabs { display: none; }
        .mobile-tab-header { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .mobile-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .mobile-tab.active { background: rgba(255, 255, 255, 0.2); border-bottom-color: #fdbb2d; }
        .mobile-tab-content { display: none; }
        .mobile-tab-content.active { display: block; }
        .redirect-status { display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 8px; z-index: 3000; font-size: 0.9rem; animation: fadeIn 0.3s ease; max-width: 300px; word-wrap: break-word; }
        .redirect-status.show { display: block; }
        .redirect-success { border-left: 4px solid #34A853; }
        .redirect-error { border-left: 4px solid #EA4335; }
        .redirect-warning { border-left: 4px solid #FBBC05; }
        .redirect-info { border-left: 4px solid #4285F4; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { 
            .container { padding: 0 10px; } 
            .navbar { flex-direction: column; gap: 15px; padding: 10px 0; } 
            .logo { font-size: 1.4rem; text-align: center; } 
            .nav-buttons { width: 100%; justify-content: center; flex-wrap: wrap; } 
            .nav-btn { padding: 8px 15px; font-size: 0.9rem; } 
            .user-section { width: 100%; justify-content: center; } 
            .mobile-tabs { display: block; } 
            #karaoke-page { flex-direction: column; } 
            #karaoke-page > .songs-section, #karaoke-page > .playlist-section { display: none; } 
            .mobile-tabs .songs-section, .mobile-tabs .playlist-section { display: block !important; } 
            .mobile-tab-content.active { display: block; } 
            .redirect-status { left: 10px; right: 10px; max-width: none; } 
        }
    </style>
</head>
<body>
    <!-- é‡å®šå‘çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="redirect-status" class="redirect-status"></div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç™»å½• / æ³¨å†Œ</h2>
                <button class="close-btn" id="close-login">&times;</button>
            </div>
            <div class="login-methods">
                <button class="login-method-btn" id="email-login-btn">ğŸ“§ é‚®ç®±ç™»å½•/æ³¨å†Œ</button>
                <button class="login-method-btn" id="google-login-btn">ğŸ”µ Google ç™»å½• (ç»ˆæä¿®å¤ç‰ˆ)</button>
            </div>
            <div style="margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); text-align: center;">
                <p>Googleç™»å½•ä½¿ç”¨å¢å¼ºçš„é‡å®šå‘æµç¨‹</p>
                <p>ç‰ˆæœ¬: 2.5.0 (å®Œæ•´ä¿®å¤ç‰ˆ)</p>
            </div>
        </div>
    </div>

    <div class="container">
        <nav class="navbar">
            <div class="logo">ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.5.0</div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ğŸµ ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ğŸ’° ä»·æ ¼é…å¥—</button>
                <div class="admin-section" id="admin-section" style="display: none;">
                    <a href="admin.html" class="nav-btn">ğŸ‘‘ ç®¡ç†é¢æ¿</a>
                </div>
            </div>
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-email" id="user-email">ç”¨æˆ·</span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
            </div>
        </nav>
        
        <!-- å®Œæ•´çš„é¡µé¢ç»“æ„ -->
        <div class="page-container">
            <div id="karaoke-page">
                <!-- æ¡Œé¢ç«¯å¸ƒå±€ -->
                <div class="songs-section">
                    <div id="charts-view">
                        <h3>æ­Œæ›²æµè§ˆ</h3>
                        <div class="search-container">
                            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢æ­Œæ›²åç§°ã€æ­Œæ‰‹...">
                            <button class="search-btn" id="search-btn">æœç´¢</button>
                        </div>
                        <div class="songs-container" id="songs-container">
                            <div class="loading">è¯·ä½¿ç”¨Googleç™»å½•åæµè§ˆæ­Œæ›²...</div>
                        </div>
                    </div>
                </div>
                
                <div class="playlist-section">
                    <div class="playlist-header">
                        <div class="playlist-count">æˆ‘çš„æ­Œå• <span id="playlist-count">(0)</span></div>
                    </div>
                    <div class="playlist-items" id="playlist-items">
                        <div class="empty-playlist">è¯·å…ˆç™»å½•ä»¥ç®¡ç†æ­Œå•</div>
                    </div>
                </div>

                <!-- ç§»åŠ¨ç«¯æ ‡ç­¾é¡µå¸ƒå±€ -->
                <div class="mobile-tabs">
                    <div class="mobile-tab-header">
                        <div class="mobile-tab active" data-tab="songs">ğŸµ æ­Œæ›²æµè§ˆ</div>
                        <div class="mobile-tab" data-tab="playlist">ğŸ“‹ æˆ‘çš„æ­Œå• <span id="mobile-playlist-count">(0)</span></div>
                    </div>
                    <div class="mobile-tab-content active" id="mobile-songs-tab">
                        <div class="songs-section">
                            <div id="charts-view-mobile">
                                <h3>æ­Œæ›²æµè§ˆ</h3>
                                <div class="search-container">
                                    <input type="text" class="search-input" id="search-input-mobile" placeholder="æœç´¢æ­Œæ›²åç§°ã€æ­Œæ‰‹...">
                                    <button class="search-btn" id="search-btn-mobile">æœç´¢</button>
                                </div>
                                <div class="songs-container" id="songs-container-mobile">
                                    <div class="loading">è¯·ä½¿ç”¨Googleç™»å½•åæµè§ˆæ­Œæ›²...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mobile-tab-content" id="mobile-playlist-tab">
                        <div class="playlist-section">
                            <div class="playlist-header">
                                <div class="playlist-count">æˆ‘çš„æ­Œå• <span id="mobile-playlist-count-display">(0)</span></div>
                            </div>
                            <div class="playlist-items" id="playlist-items-mobile">
                                <div class="empty-playlist">è¯·å…ˆç™»å½•ä»¥ç®¡ç†æ­Œå•</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="pricing-page" style="display: none;">
                <h2 style="text-align: center; margin: 30px 0;">ä»·æ ¼é…å¥—</h2>
                <div class="pricing-container">
                    <div class="pricing-card">
                        <div class="plan-name">åŸºç¡€ç‰ˆ</div>
                        <div class="price">RM 29</div>
                        <div class="song-range">1 - 20 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    <div class="pricing-card">
                        <div class="plan-name">æ ‡å‡†ç‰ˆ</div>
                        <div class="price">RM 49</div>
                        <div class="song-range">21 - 50 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // ğŸ”¥ æœ€ç»ˆå®Œæ•´ä¿®å¤ç‰ˆ - Googleç™»å½•é‡å®šå‘è§£å†³æ–¹æ¡ˆ
        // =============================================

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAMn7EOOUDpIGXzA8EhPBtLWw7BwyU2Rdc",
            authDomain: "karaoke-customizer.firebaseapp.com",
            projectId: "karaoke-customizer",
            storageBucket: "karaoke-customizer.firebasestorage.app",
            messagingSenderId: "593643512892",
            appId: "1:593643512892:web:c21ec4ce7c2d286fed4f39",
            measurementId: "G-D791D33Y6R"
        };

        // åº”ç”¨çŠ¶æ€
        let currentUser = null;
        let firebaseApp, auth, firestore;
        let isMobileView = window.innerWidth <= 768;
        let loginInProgress = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åˆå§‹åŒ–æ­Œå…å®šåˆ¶åº”ç”¨ v2.5.0 - å®Œæ•´ä¿®å¤ç‰ˆ');
            
            // ä¿®å¤ï¼šå…ˆåˆå§‹åŒ–DOMç›¸å…³åŠŸèƒ½
            initializeViewport();
            setupEventListeners();
            
            // ç„¶ååˆå§‹åŒ–Firebase
            setTimeout(() => {
                initializeFirebase();
                
                // è®¾ç½®OAuthé‡å®šå‘ç›‘å¬å™¨
                setupOAuthRedirectListener();
                
                // æ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°
                checkUrlForAuthParams();
            }, 100);
        });

        /**
         * ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨çš„è§†å£åˆå§‹åŒ–
         */
        function initializeViewport() {
            isMobileView = window.innerWidth <= 768;
            console.log('ğŸ“± å½“å‰è§†å›¾:', isMobileView ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
            
            // å®‰å…¨åœ°è®¿é—®DOMå…ƒç´ 
            const mobileTabs = document.querySelector('.mobile-tabs');
            const songsSection = document.querySelector('.songs-section');
            const playlistSection = document.querySelector('.playlist-section');
            const karaokePage = document.getElementById('karaoke-page');
            
            if (!karaokePage) {
                console.error('âŒ æ‰¾ä¸åˆ°#karaoke-pageå…ƒç´ ');
                return;
            }
            
            if (isMobileView) {
                karaokePage.style.display = 'block';
                document.getElementById('pricing-page').style.display = 'none';
                
                // å®‰å…¨åœ°æ“ä½œç§»åŠ¨ç«¯æ ‡ç­¾é¡µ
                if (mobileTabs) {
                    mobileTabs.style.display = 'block';
                }
                
                if (songsSection) {
                    songsSection.style.display = 'none';
                }
                
                if (playlistSection) {
                    playlistSection.style.display = 'none';
                }
                
                // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ ‡ç­¾é¡µ
                setTimeout(() => {
                    const firstTab = document.querySelector('.mobile-tab');
                    if (firstTab) {
                        switchMobileTab(firstTab.dataset.tab);
                    }
                }, 100);
                
            } else {
                karaokePage.style.display = 'flex';
                document.getElementById('pricing-page').style.display = 'none';
                
                if (mobileTabs) {
                    mobileTabs.style.display = 'none';
                }
                
                if (songsSection) {
                    songsSection.style.display = 'block';
                }
                
                if (playlistSection) {
                    playlistSection.style.display = 'block';
                }
            }
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                const newIsMobile = window.innerWidth <= 768;
                if (newIsMobile !== isMobileView) {
                    isMobileView = newIsMobile;
                    console.log('ğŸ”„ è§†å›¾åˆ‡æ¢:', isMobileView ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯');
                    showPage('karaoke');
                    initializeViewport();
                }
            });
        }

        /**
         * åˆ‡æ¢ç§»åŠ¨ç«¯æ ‡ç­¾é¡µ
         */
        function switchMobileTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.mobile-tab').forEach(tab => {
                if (tab) tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector('.mobile-tab[data-tab="' + tabName + '"]');
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.mobile-tab-content').forEach(content => {
                if (content) content.classList.remove('active');
            });
            
            const activeContent = document.getElementById('mobile-' + tabName + '-tab');
            if (activeContent) {
                activeContent.classList.add('active');
            }
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°
         */
        function checkUrlForAuthParams() {
            console.log('ğŸ” æ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°...');
            
            const searchParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            const authParams = {
                code: searchParams.get('code') || hashParams.get('code'),
                error: searchParams.get('error') || hashParams.get('error'),
                auth_status: searchParams.get('auth_status') || hashParams.get('auth_status')
            };
            
            console.log('ğŸ“‹ å‘ç°çš„è®¤è¯å‚æ•°:', authParams);
            
            if (authParams.code || authParams.auth_status) {
                console.log('ğŸ¯ æ£€æµ‹åˆ°OAuthé‡å®šå‘è¿”å›');
                showRedirectStatus('æ£€æµ‹åˆ°ç™»å½•è¿”å›ï¼Œæ­£åœ¨å¤„ç†...', 'info');
                loginInProgress = true;
                
                if (authParams.error) {
                    const errorDesc = searchParams.get('error_description') || hashParams.get('error_description');
                    console.error('âŒ OAuthé”™è¯¯:', authParams.error, errorDesc);
                    showRedirectStatus(`ç™»å½•é”™è¯¯: ${authParams.error}`, 'error');
                    clearAuthParams();
                }
            }
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¸…é™¤URLä¸­çš„è®¤è¯å‚æ•°
         */
        function clearAuthParams() {
            if (window.history.replaceState) {
                try {
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    console.log('ğŸ§¹ å·²æ¸…é™¤URLä¸­çš„è®¤è¯å‚æ•°');
                } catch (e) {
                    console.error('æ¸…é™¤URLå‚æ•°å¤±è´¥:', e);
                }
            }
        }

        /**
         * åˆå§‹åŒ–Firebase
         */
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.apps[0];
                }
                
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                
                console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®æŒä¹…åŒ–
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        console.log('âœ… è®¤è¯æŒä¹…åŒ–è®¾ç½®æˆåŠŸ');
                        
                        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                        auth.onAuthStateChanged(handleAuthStateChange);
                    })
                    .catch((error) => {
                        console.error('è®¤è¯æŒä¹…åŒ–è®¾ç½®å¤±è´¥:', error);
                    });
                    
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®¾ç½®OAuthé‡å®šå‘ç›‘å¬å™¨
         */
        function setupOAuthRedirectListener() {
            console.log('ğŸ”„ è®¾ç½®OAuthé‡å®šå‘ç›‘å¬å™¨...');
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && loginInProgress) {
                    console.log('ğŸ‘ï¸ é¡µé¢é‡æ–°å¯è§ï¼Œç™»å½•å¯èƒ½å·²å®Œæˆ');
                    setTimeout(handleOAuthRedirectReturn, 1000);
                }
            });
            
            // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (loginInProgress) {
                        console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€');
                        handleOAuthRedirectReturn();
                    }
                }, 1500);
            });
            
            console.log('âœ… OAuthé‡å®šå‘ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¤„ç†OAuthé‡å®šå‘è¿”å›
         */
        function handleOAuthRedirectReturn() {
            console.log('ğŸ”„ å¤„ç†OAuthé‡å®šå‘è¿”å›...');
            
            if (!auth) {
                console.log('âš ï¸ Authæœªåˆå§‹åŒ–ï¼Œç­‰å¾…...');
                setTimeout(handleOAuthRedirectReturn, 500);
                return;
            }
            
            // æ£€æŸ¥Firebaseé‡å®šå‘ç»“æœ
            auth.getRedirectResult()
                .then((result) => {
                    console.log('ğŸ¯ getRedirectResultè¿”å›:', {
                        hasUser: !!result.user,
                        hasCredential: !!result.credential,
                        operationType: result.operationType
                    });
                    
                    if (result.user) {
                        // ğŸ”¥ æˆåŠŸï¼ç”¨æˆ·é€šè¿‡é‡å®šå‘ç™»å½•æˆåŠŸ
                        console.log('ğŸ‰ OAuthé‡å®šå‘ç™»å½•æˆåŠŸ:', result.user.email);
                        showMessage('âœ… Googleç™»å½•æˆåŠŸï¼');
                        showRedirectStatus('Googleç™»å½•æˆåŠŸï¼æ¬¢è¿ ' + result.user.email, 'success');
                        
                        clearAuthParams();
                        loginInProgress = false;
                        
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) {
                            loginModal.style.display = 'none';
                        }
                        
                    } else {
                        console.log('â„¹ï¸ æ²¡æœ‰ä»é‡å®šå‘è¿”å›çš„ç”¨æˆ·æˆ–å‡­è¯');
                        
                        // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æœ‰ç”¨æˆ·ç™»å½•
                        if (auth.currentUser) {
                            console.log('âœ… å·²ç»æœ‰ç”¨æˆ·ç™»å½•:', auth.currentUser.email);
                            loginInProgress = false;
                            clearAuthParams();
                        } else {
                            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰é”™è¯¯
                            const searchParams = new URLSearchParams(window.location.search);
                            const hashParams = new URLSearchParams(window.location.hash.substring(1));
                            
                            if (searchParams.get('error') || hashParams.get('error')) {
                                const error = searchParams.get('error') || hashParams.get('error');
                                console.error('âŒ URLä¸­æ£€æµ‹åˆ°é”™è¯¯:', error);
                                showRedirectStatus('ç™»å½•å¤±è´¥: ' + error, 'error');
                                clearAuthParams();
                                loginInProgress = false;
                            } else {
                                console.log('â³ ç™»å½•å¯èƒ½è¿˜åœ¨è¿›è¡Œä¸­ï¼Œç»§ç»­ç­‰å¾…...');
                                setTimeout(handleOAuthRedirectReturn, 2000);
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.log('âš ï¸ getRedirectResulté”™è¯¯:', error.code, error.message);
                    
                    switch(error.code) {
                        case 'auth/redirect-cancelled-by-user':
                            console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†é‡å®šå‘ç™»å½•');
                            showRedirectStatus('ç™»å½•å·²å–æ¶ˆ', 'warning');
                            loginInProgress = false;
                            clearAuthParams();
                            break;
                            
                        case 'auth/redirect-operation-pending':
                            console.log('â³ é‡å®šå‘æ“ä½œæ­£åœ¨è¿›è¡Œä¸­');
                            setTimeout(handleOAuthRedirectReturn, 2000);
                            break;
                            
                        case 'auth/no-auth-event':
                            console.log('â„¹ï¸ æ²¡æœ‰è®¤è¯äº‹ä»¶');
                            loginInProgress = false;
                            break;
                            
                        default:
                            console.log('â„¹ï¸ å…¶ä»–çŠ¶æ€:', error.code || 'æ— é”™è¯¯ä»£ç ');
                            loginInProgress = false;
                    }
                });
        }

        /**
         * ğŸ”¥ ä¿®å¤ï¼šå¢å¼ºçš„Googleç™»å½•å‡½æ•°
         */
        function initLoginEvents() {
            const googleLoginBtn = document.getElementById('google-login-btn');
            
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', function() {
                    console.log('ğŸ‘† ç‚¹å‡»Googleç™»å½•æŒ‰é’®');
                    
                    if (!auth) {
                        console.error('âŒ è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–');
                        showMessage('è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
                        return;
                    }
                    
                    if (loginInProgress) {
                        console.log('âš ï¸ ç™»å½•å·²åœ¨å¤„ç†ä¸­');
                        showRedirectStatus('ç™»å½•å·²åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                        return;
                    }
                    
                    loginInProgress = true;
                    
                    const provider = new firebase.auth.GoogleAuthProvider();
                    
                    // OAuthé…ç½®
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    provider.setCustomParameters({
                        prompt: 'select_account',
                        include_granted_scopes: 'true'
                    });
                    
                    console.log('ğŸ”§ Googleç™»å½•é…ç½®å®Œæˆ');
                    
                    showRedirectStatus('æ­£åœ¨å¯åŠ¨Googleç™»å½•...', 'info');
                    
                    clearAuthParams();
                    
                    // æ‰§è¡Œç™»å½•
                    setTimeout(() => {
                        handleGoogleLoginWithRedirect(provider);
                    }, 500);
                });
            }
            
            // å…¶ä»–æŒ‰é’®äº‹ä»¶
            const loginBtn = document.getElementById('login-btn');
            const closeLoginBtn = document.getElementById('close-login');
            const emailLoginBtn = document.getElementById('email-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginModal = document.getElementById('login-modal');
            
            if (loginBtn) loginBtn.addEventListener('click', () => {
                if (loginModal) loginModal.style.display = 'flex';
            });
            
            if (closeLoginBtn) closeLoginBtn.addEventListener('click', () => {
                if (loginModal) loginModal.style.display = 'none';
            });
            
            if (emailLoginBtn) emailLoginBtn.addEventListener('click', handleEmailLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            
            if (loginModal) {
                loginModal.addEventListener('click', (e) => {
                    if (e.target === loginModal) loginModal.style.display = 'none';
                });
            }
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal && loginModal.style.display === 'flex') {
                        loginModal.style.display = 'none';
                    }
                }
            });
            
            // é¡µé¢å¯¼èˆª
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            
            if (karaokeNav) karaokeNav.addEventListener('click', () => showPage('karaoke'));
            if (pricingNav) pricingNav.addEventListener('click', () => showPage('pricing'));
            
            // ç§»åŠ¨ç«¯æ ‡ç­¾é¡µ
            document.querySelectorAll('.mobile-tab').forEach(tab => {
                if (tab) {
                    tab.addEventListener('click', function() {
                        const tabName = this.dataset.tab;
                        switchMobileTab(tabName);
                    });
                }
            });
        }

        /**
         * å¤„ç†Googleç™»å½•é‡å®šå‘
         */
        function handleGoogleLoginWithRedirect(provider) {
            console.log('ğŸ”„ æ‰§è¡ŒGoogleç™»å½•é‡å®šå‘...');
            
            showRedirectStatus('æ­£åœ¨è·³è½¬åˆ°Googleç™»å½•é¡µé¢...', 'info');
            
            auth.signInWithRedirect(provider)
                .then(() => {
                    console.log('âœ… signInWithRedirectè°ƒç”¨æˆåŠŸ');
                    
                    // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                    setTimeout(() => {
                        if (loginInProgress && !auth.currentUser) {
                            console.log('â° ç™»å½•è¶…æ—¶ï¼Œæ£€æŸ¥çŠ¶æ€');
                            showRedirectStatus('ç™»å½•å¤„ç†ä¸­ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæˆ...', 'warning');
                            handleOAuthRedirectReturn();
                        }
                    }, 10000);
                })
                .catch((error) => {
                    console.error('âŒ signInWithRedirectè°ƒç”¨å¤±è´¥:', error);
                    loginInProgress = false;
                    showRedirectStatus('é‡å®šå‘å¤±è´¥: ' + error.message, 'error');
                    showMessage('âŒ ç™»å½•å¤±è´¥: ' + error.message);
                });
        }

        /**
         * å¤„ç†é‚®ç®±ç™»å½•
         */
        function handleEmailLogin() {
            const email = prompt('è¯·è¾“å…¥é‚®ç®±åœ°å€:');
            if (!email) return;
            
            const password = prompt('è¯·è¾“å…¥å¯†ç :');
            if (!password) return;
            
            if (!auth) {
                showMessage('è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼');
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) loginModal.style.display = 'none';
                    showRedirectStatus('é‚®ç®±æ³¨å†ŒæˆåŠŸï¼', 'success');
                })
                .catch((error) => {
                    if (error.code === 'auth/email-already-in-use') {
                        auth.signInWithEmailAndPassword(email, password)
                            .then(() => {
                                showMessage('âœ… ç™»å½•æˆåŠŸï¼');
                                const loginModal = document.getElementById('login-modal');
                                if (loginModal) loginModal.style.display = 'none';
                                showRedirectStatus('é‚®ç®±ç™»å½•æˆåŠŸï¼', 'success');
                            })
                            .catch(loginError => {
                                showMessage('âŒ ç™»å½•å¤±è´¥: ' + loginError.message);
                                showRedirectStatus('ç™»å½•å¤±è´¥: ' + loginError.message, 'error');
                            });
                    } else {
                        showMessage('âŒ é”™è¯¯: ' + error.message);
                        showRedirectStatus('é”™è¯¯: ' + error.message, 'error');
                    }
                });
        }

        /**
         * å¤„ç†é€€å‡ºç™»å½•
         */
        function handleLogout() {
            if (!auth) {
                showMessage('è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–');
                return;
            }
            
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                auth.signOut().then(() => {
                    showMessage('å·²é€€å‡ºç™»å½•');
                    showRedirectStatus('å·²é€€å‡ºç™»å½•', 'info');
                }).catch((error) => {
                    showMessage('é€€å‡ºå¤±è´¥: ' + error.message);
                    showRedirectStatus('é€€å‡ºå¤±è´¥', 'error');
                });
            }
        }

        /**
         * å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
         */
        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.email);
                updateUserUI();
                showRedirectStatus('æ¬¢è¿å›æ¥ ' + (user.displayName || user.email.split('@')[0]), 'success');
            } else {
                currentUser = null;
                console.log('ğŸ‘‹ ç”¨æˆ·å·²ç™»å‡º');
                updateUserUI();
            }
        }

        /**
         * æ›´æ–°ç”¨æˆ·ç•Œé¢
         */
        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const loginBtn = document.getElementById('login-btn');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            const adminSection = document.getElementById('admin-section');
            
            if (currentUser && userInfo && loginBtn) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                
                if (userAvatar) userAvatar.textContent = initial;
                if (userEmail) userEmail.textContent = displayName;
                
                if (adminSection) {
                    adminSection.style.display = 'block';
                }
            } else if (userInfo && loginBtn) {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
            }
        }

        /**
         * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
         */
        function setupEventListeners() {
            initLoginEvents();
        }

        /**
         * æ˜¾ç¤ºé‡å®šå‘çŠ¶æ€
         */
        function showRedirectStatus(message, type = 'info') {
            const statusEl = document.getElementById('redirect-status');
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.className = `redirect-status show redirect-${type}`;
            
            console.log(`ğŸ“¢ çŠ¶æ€: ${type.toUpperCase()} - ${message}`);
            
            const hideDelay = type === 'success' ? 3000 : 
                             type === 'error' ? 5000 : 3000;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, hideDelay);
        }

        /**
         * æ˜¾ç¤ºæ¶ˆæ¯
         */
        function showMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 5px; z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; animation: fadeIn 0.3s ease;';
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        /**
         * æ˜¾ç¤ºé¡µé¢
         */
        function showPage(page) {
            const karaokePage = document.getElementById('karaoke-page');
            const pricingPage = document.getElementById('pricing-page');
            
            if (!karaokePage || !pricingPage) return;
            
            karaokePage.style.display = 'none';
            pricingPage.style.display = 'none';
            
            if (page === 'karaoke') {
                if (isMobileView) {
                    karaokePage.style.display = 'block';
                } else {
                    karaokePage.style.display = 'flex';
                }
                
                // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                updateNavButtons('karaoke');
            } else if (page === 'pricing') {
                pricingPage.style.display = 'block';
                updateNavButtons('pricing');
            }
            
            // é‡æ–°åˆå§‹åŒ–è§†å£
            setTimeout(initializeViewport, 50);
        }

        /**
         * æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
         */
        function updateNavButtons(activePage) {
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            
            if (karaokeNav) karaokeNav.classList.remove('active');
            if (pricingNav) pricingNav.classList.remove('active');
            
            if (activePage === 'karaoke' && karaokeNav) {
                karaokeNav.classList.add('active');
            } else if (activePage === 'pricing' && pricingNav) {
                pricingNav.classList.add('active');
            }
        }

        // åˆå§‹åŒ–é¡µé¢æ˜¾ç¤º
        setTimeout(() => {
            showPage('karaoke');
        }, 100);
    </script>
</body>
</html>
