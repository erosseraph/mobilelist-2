<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定制你的专属歌厅 v2.2.3</title>
    
    <!-- PWA 配置 -->
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="专业歌厅定制服务，打造您的专属音乐空间">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="歌厅定制">

    <!-- 添加SheetJS库用于Excel导出 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- 添加Chart.js用于统计图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    
    <style>
        /* ==================== 重置和基础样式 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ==================== 导航栏样式 ==================== */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo .version {
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
            justify-content: center;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .login-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .user-info {
            display: none;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* ==================== 页面容器 ==================== */
        .page-container {
            min-height: 600px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== 点歌系统页面 - 新Tabs布局 ==================== */
        #karaoke-page {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 1024px) {
            #karaoke-page {
                flex-direction: column;
            }
        }
        
        /* 移动端Tabs布局 */
        .karaoke-tabs {
            display: none; /* 默认桌面端不显示 */
        }
        
        .karaoke-desktop {
            display: flex;
            width: 100%;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .karaoke-desktop {
                display: none; /* 移动端隐藏桌面布局 */
            }
            
            .karaoke-tabs {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .tabs-header {
                display: flex;
                justify-content: center;
                gap: 5px;
                margin-bottom: 20px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 25px;
                padding: 5px;
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(10px);
            }
            
            .tab-btn {
                flex: 1;
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.7);
                padding: 12px 20px;
                border-radius: 20px;
                cursor: pointer;
                font-size: 1rem;
                transition: all 0.3s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            .tab-btn.active {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                font-weight: bold;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            }
            
            .tabs-content {
                position: relative;
                min-height: 500px;
            }
            
            .tab-pane {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            
            .tab-pane.active {
                display: block;
            }
        }
        
        /* 歌曲区域和歌单区域的基础样式 */
        .songs-section, .playlist-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .songs-section {
            flex: 2;
            min-width: 300px;
        }
        
        .playlist-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            max-height: 700px;
        }
        
        /* 移动端歌单独立页面样式 */
        @media (max-width: 768px) {
            .playlist-section {
                max-height: none;
                height: auto;
                min-height: 500px;
            }
            
            .playlist-items {
                max-height: 400px;
            }
        }
        
        /* ==================== 排行榜样式 ==================== */
        .charts-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .chart-category {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        
        .chart-category:hover, .chart-category.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ==================== 搜索框样式 ==================== */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 14px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-btn, .clear-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .search-btn:hover, .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* ==================== 歌曲列表样式 ==================== */
        .songs-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            padding-right: 5px;
        }
        
        /* 滚动条样式 */
        .songs-container::-webkit-scrollbar,
        .playlist-items::-webkit-scrollbar,
        .orders-table-container::-webkit-scrollbar,
        .my-orders-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .songs-container::-webkit-scrollbar-track,
        .playlist-items::-webkit-scrollbar-track,
        .orders-table-container::-webkit-scrollbar-track,
        .my-orders-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .songs-container::-webkit-scrollbar-thumb,
        .playlist-items::-webkit-scrollbar-thumb,
        .orders-table-container::-webkit-scrollbar-thumb,
        .my-orders-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .songs-container::-webkit-scrollbar-thumb:hover,
        .playlist-items::-webkit-scrollbar-thumb:hover,
        .orders-table-container::-webkit-scrollbar-thumb:hover,
        .my-orders-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .song {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .song:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .song-info {
            flex: 1;
            min-width: 0;
            margin-right: 15px;
        }
        
        .song-title {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 1.05rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .song-album {
            font-size: 0.85rem;
            opacity: 0.6;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-controls {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .preview-btn, .add-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
        }
        
        .preview-btn:hover, .add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .preview-btn.playing {
            background: rgba(46, 204, 113, 0.3);
        }
        
        .load-more-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .load-more-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ==================== 歌单样式 ==================== */
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .playlist-count {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .playlist-count-number {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 1rem;
        }
        
        .submit-playlist-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }
        
        .submit-playlist-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .submit-playlist-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .playlist-items {
            flex: 1;
            min-height: 200px;
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .playlist-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }
        
        .song-number {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .playlist-item-title {
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .playlist-item-artist {
            font-size: 0.85rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .remove-btn {
            background: rgba(255, 59, 48, 0.3);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .remove-btn:hover {
            background: rgba(255, 59, 48, 0.5);
            transform: scale(1.1);
        }
        
        .empty-playlist {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .empty-playlist-icon {
            font-size: 3rem;
            opacity: 0.5;
        }
        
        /* ==================== 价格推荐卡片 ==================== */
        .price-recommendation {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .price-recommendation h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recommended-plan {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .plan-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .plan-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .shipping-cost {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .total-price {
            display: flex;
            justify-content: space-between;
            font-size: 1.4rem;
            font-weight: bold;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: #2ecc71;
        }
        
        /* ==================== 价格配套页面 ==================== */
        #pricing-page {
            display: none;
        }
        
        .pricing-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .pricing-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .pricing-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.4s;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .pricing-card.popular {
            border: 2px solid #ffd700;
            background: rgba(255, 255, 255, 0.12);
        }
        
        .popular-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #333;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .plan-name {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #fff, #a0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .price {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        .song-range {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 25px;
            font-size: 1.1rem;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .select-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 16px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            width: 100%;
            margin-top: auto;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .select-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* 配送信息样式 */
        .shipping-info {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            margin: 40px auto;
            max-width: 900px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .shipping-info h3 {
            text-align: center;
            margin: 0 0 30px 0;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #fff, #a0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .shipping-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .shipping-options {
                grid-template-columns: 1fr;
            }
        }
        
        .shipping-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .shipping-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .shipping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .shipping-region {
            font-weight: bold;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shipping-price {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .shipping-desc {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .shipping-note {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            font-style: italic;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== 订单管理页面 ==================== */
        #orders-page, #my-orders-page {
            display: none;
        }
        
        .orders-header, .my-orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .orders-header h2, .my-orders-header h2 {
            font-size: 2rem;
            background: linear-gradient(135deg, #fff, #a0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .orders-controls, .my-orders-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .export-btn, .refresh-btn, .filter-btn, .batch-btn, .my-orders-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 48px;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .filter-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .batch-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .my-orders-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .export-btn:hover, .refresh-btn:hover, .filter-btn:hover, .batch-btn:hover, .my-orders-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 分页系统样式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            flex-wrap: wrap;
        }
        
        .pagination-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            min-width: 40px;
            text-align: center;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .pagination-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-weight: bold;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-left: 15px;
        }
        
        /* 过滤面板 */
        .filter-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        .filter-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: bold;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .filter-select, .filter-input, .filter-date {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .filter-select:focus, .filter-input:focus, .filter-date:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .apply-filter-btn, .clear-filter-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .apply-filter-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .clear-filter-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .apply-filter-btn:hover, .clear-filter-btn:hover {
            transform: translateY(-2px);
        }
        
        /* 统计卡片 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .stat-card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-card-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff, #a0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card-label {
            font-size: 0.95rem;
            opacity: 0.8;
        }
        
        /* 订单表格 */
        .orders-table-container, .my-orders-container {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }
        
        .orders-table, .my-orders-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        .orders-table th, .my-orders-table th {
            background: rgba(255, 255, 255, 0.1);
            padding: 18px 20px;
            text-align: left;
            font-weight: bold;
            font-size: 0.95rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .orders-table td, .my-orders-table td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }
        
        .orders-table tr, .my-orders-table tr {
            transition: all 0.3s;
        }
        
        .orders-table tr:hover, .my-orders-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .orders-table tr.selected, .my-orders-table tr.selected {
            background: rgba(52, 152, 219, 0.15);
        }
        
        .select-checkbox {
            width: 40px;
            text-align: center;
        }
        
        .select-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .status-pending {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }
        
        .status-paid {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .status-shipped {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .status-completed {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .status-cancelled {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .status-deleted {
            background: rgba(149, 165, 166, 0.2);
            color: #95a5a6;
            border: 1px solid rgba(149, 165, 166, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            justify-content: center;
        }
        
        .view-btn {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .edit-btn {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        
        .delete-btn {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .view-btn:hover {
            background: rgba(52, 152, 219, 0.3);
            transform: translateY(-2px);
        }
        
        .edit-btn:hover {
            background: rgba(155, 89, 182, 0.3);
            transform: translateY(-2px);
        }
        
        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.3);
            transform: translateY(-2px);
        }
        
        /* 批量操作面板 */
        .batch-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .batch-panel.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .batch-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }
        
        .batch-selected-count {
            background: rgba(52, 152, 219, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .batch-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .batch-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        
        .batch-export-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .batch-status-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .batch-delete-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .batch-clear-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .batch-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* ==================== 模态框样式 ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 20px;
            padding: 35px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-title {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }
        
        .login-methods {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-bottom: 25px;
        }
        
        .login-method-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .login-method-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .login-method-icon {
            font-size: 1.3rem;
        }
        
        /* 表单样式 */
        .form-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-label .required {
            color: #ff6b6b;
            font-size: 1.2rem;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: fadeIn 0.3s ease;
        }
        
        .form-radio-group {
            display: flex;
            gap: 25px;
            margin-top: 10px;
        }
        
        .form-radio-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        
        .form-radio-label:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-radio-label.selected {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid rgba(52, 152, 219, 0.5);
        }
        
        .form-radio-label input[type="radio"] {
            margin: 0;
            width: 18px;
            height: 18px;
        }
        
        .form-submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 18px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s;
            font-weight: bold;
            letter-spacing: 1px;
            margin-top: 20px;
        }
        
        .form-submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .form-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }
        
        .form-info h4 {
            margin-bottom: 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-info-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .song-count-info {
            font-size: 1.1rem;
        }
        
        .song-count-number {
            background: rgba(52, 152, 219, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .price-summary {
            text-align: right;
        }
        
        .base-price, .shipping-fee, .total-price-summary {
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .total-price-summary {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2ecc71;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* 订单详情样式 */
        .order-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .detail-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-card h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #a0e7ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .detail-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .detail-label {
            font-weight: bold;
            opacity: 0.8;
            min-width: 100px;
        }
        
        .detail-value {
            text-align: right;
            flex: 1;
            word-break: break-word;
        }
        
        .songs-list-container {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .song-detail-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }
        
        .song-detail-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.05rem;
        }
        
        .song-detail-artist {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .song-detail-album {
            opacity: 0.6;
            font-size: 0.85rem;
            font-style: italic;
            margin-top: 3px;
        }
        
        .order-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .status-update-form {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-update-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-select {
            flex: 1;
            min-width: 200px;
        }
        
        .status-update-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .status-update-btn:hover {
            transform: translateY(-2px);
        }
        
        /* 批量状态更新模态框 */
        .batch-status-form {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .selected-orders-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .selected-order-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            border-left: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ==================== 工具类 ==================== */
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.8;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .error {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.8;
            color: #ff6b6b;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .error-icon {
            font-size: 3rem;
            opacity: 0.7;
        }
        
        .success {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.8;
            color: #2ecc71;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .success-icon {
            font-size: 3rem;
            opacity: 0.7;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            opacity: 0.6;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-message {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .empty-state-submessage {
            opacity: 0.7;
        }
        
        /* 消息通知 */
        .message-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 5000;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            word-break: break-word;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-20px);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px 0;
            }
            
            .nav-buttons {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .nav-btn, .login-btn {
                padding: 10px 18px;
                font-size: 0.9rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .page-container {
                padding: 15px;
            }
            
            .modal-content {
                padding: 25px;
                max-height: 85vh;
            }
            
            .modal-title {
                font-size: 1.5rem;
            }
            
            .orders-table th, .orders-table td,
            .my-orders-table th, .my-orders-table td {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-btn {
                min-width: 60px;
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .nav-btn, .login-btn {
                padding: 8px 15px;
                font-size: 0.85rem;
                min-height: 42px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .page-container {
                padding: 12px;
            }
            
            .songs-section,
            .playlist-section {
                padding: 20px;
            }
            
            .modal-content {
                padding: 20px;
                max-height: 80vh;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .orders-controls, .my-orders-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .export-btn, .refresh-btn, .filter-btn, .batch-btn, .my-orders-btn {
                width: 100%;
                justify-content: center;
            }
            
            .batch-panel.show {
                flex-direction: column;
                align-items: stretch;
            }
            
            .batch-actions {
                flex-direction: column;
            }
            
            .batch-action-btn {
                width: 100%;
            }
        }
        
        /* 动画效果 */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.5s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
            }
        }
        
        /* 自定义滚动条 */
        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        *::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        *::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        
        *::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <!-- 登录模态框 -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">登录 / 注册</h2>
                <button class="close-btn" id="close-login">&times;</button>
            </div>
            
            <div class="login-methods">
                <button class="login-method-btn" id="email-login-btn">
                    <span class="login-method-icon">📧</span>
                    <span>邮箱登录/注册</span>
                </button>
                <button class="login-method-btn" id="google-login-btn">
                    <span class="login-method-icon">🔵</span>
                    <span>Google 登录</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 提交歌单模态框 -->
    <div class="modal" id="submit-playlist-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">提交歌单订单</h2>
                <button class="close-btn" id="close-submit-playlist">&times;</button>
            </div>
            
            <div class="form-container">
                <div class="form-info">
                    <h4>📋 订单信息</h4>
                    <div class="form-info-content">
                        <div class="song-count-info">
                            歌单歌曲: <span class="song-count-number" id="modal-song-count">0</span> 首
                        </div>
                        <div class="price-summary">
                            <div class="base-price" id="modal-base-price">套餐价格: RM 0</div>
                            <div class="shipping-fee" id="modal-shipping-fee">配送费用: RM 0</div>
                            <div class="total-price-summary" id="modal-total-price">总金额: RM 0</div>
                        </div>
                    </div>
                </div>
                
                <form id="submit-playlist-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <span>姓名</span>
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="customer-name" 
                                   placeholder="请输入您的姓名" required>
                            <div class="error-message" id="customer-name-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <span>电话号码</span>
                                <span class="required">*</span>
                            </label>
                            <input type="tel" class="form-input" id="customer-phone" 
                                   placeholder="请输入马来西亚电话号码" required>
                            <div class="error-message" id="customer-phone-error"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span>邮箱地址</span>
                            <span class="required">*</span>
                        </label>
                        <input type="email" class="form-input" id="customer-email" 
                               placeholder="请输入您的邮箱地址" required>
                        <div class="error-message" id="customer-email-error"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <span>街道地址</span>
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="address-street" 
                                   placeholder="请输入街道地址" required>
                            <div class="error-message" id="address-street-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <span>城市</span>
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="address-city" 
                                   placeholder="请输入城市" required>
                            <div class="error-message" id="address-city-error"></div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                <span>州属</span>
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="address-state" 
                                   placeholder="请输入州属" required>
                            <div class="error-message" id="address-state-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <span>邮编</span>
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="address-zip" 
                                   placeholder="请输入邮编" required>
                            <div class="error-message" id="address-zip-error"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span>配送地区</span>
                            <span class="required">*</span>
                        </label>
                        <div class="form-radio-group">
                            <label class="form-radio-label" id="west-malaysia-label">
                                <input type="radio" name="shipping-region" value="west" checked>
                                <span>西马 (免费配送)</span>
                            </label>
                            <label class="form-radio-label" id="east-malaysia-label">
                                <input type="radio" name="shipping-region" value="east">
                                <span>东马 (+RM 8.00)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <span>备注 (选填)</span>
                        </label>
                        <textarea class="form-textarea" id="customer-note" 
                                  placeholder="如有特殊要求，请在此填写..."></textarea>
                    </div>
                    
                    <button type="submit" class="form-submit-btn" id="submit-order-btn">
                        提交订单
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div class="modal" id="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">订单详情</h2>
                <button class="close-btn" id="close-order-details">&times;</button>
            </div>
            
            <div id="order-details-content">
                <!-- 订单详情内容会动态加载到这里 -->
            </div>
        </div>
    </div>

    <!-- 批量操作模态框 -->
    <div class="modal" id="batch-operations-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">批量操作</h2>
                <button class="close-btn" id="close-batch-operations">&times;</button>
            </div>
            
            <div id="batch-operations-content">
                <!-- 批量操作内容会动态加载到这里 -->
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="logo">
                🎤 定制你的专属歌厅
                <span class="version">v2.2.3</span>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">
                    <span>🎵</span>
                    <span>点歌系统</span>
                </button>
                <button class="nav-btn" id="pricing-nav">
                    <span>💰</span>
                    <span>价格配套</span>
                </button>
                <button class="nav-btn" id="my-orders-nav" style="display: none;">
                    <span>📋</span>
                    <span>我的订单</span>
                </button>
                <button class="nav-btn" id="orders-nav" style="display: none;">
                    <span>👑</span>
                    <span>订单管理</span>
                </button>
            </div>
            
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">E</div>
                    <span class="user-email" id="user-email">Eros Seraph</span>
                    <button class="logout-btn" id="logout-btn">退出</button>
                </div>
                <button class="login-btn" id="login-btn">
                    <span>🔐</span>
                    <span>登录/注册</span>
                </button>
            </div>
        </nav>
        
        <!-- 页面容器 -->
        <div class="page-container">
            <!-- 点歌系统页面 - 新的Tabs布局 -->
            <div id="karaoke-page">
                <!-- 桌面端布局 -->
                <div class="karaoke-desktop">
                    <div class="songs-section">
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">🎵 搜索和选择歌曲</h3>
                        
                        <div class="charts-container">
                            <div class="chart-category active" data-category="chinese-pop">
                                华语流行
                            </div>
                            <div class="chart-category" data-category="western-pop">
                                欧美流行
                            </div>
                            <div class="chart-category" data-category="chinese-dj">
                                中文DJ
                            </div>
                            <div class="chart-category" data-category="chinese-artists">
                                华语歌手
                            </div>
                            <div class="chart-category" data-category="western-artists">
                                欧美歌手
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <input type="text" class="search-input" id="search-input" 
                                   placeholder="搜索歌曲名称、歌手或专辑...">
                            <button class="search-btn" id="search-btn">
                                <span>🔍</span>
                                <span>搜索</span>
                            </button>
                            <button class="clear-btn" id="clear-search-btn">
                                <span>🗑️</span>
                                <span>清空</span>
                            </button>
                        </div>
                        
                        <div class="songs-container" id="songs-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <div>正在加载歌曲...</div>
                            </div>
                        </div>
                        
                        <button class="load-more-btn" id="load-more-btn" style="display: none;">
                            <span>⬇️</span>
                            <span>加载更多歌曲</span>
                        </button>
                    </div>
                    
                    <div class="playlist-section">
                        <div class="playlist-header">
                            <div class="playlist-count">
                                <span>我的歌单</span>
                                <span class="playlist-count-number" id="playlist-count">0</span>
                            </div>
                            <button class="submit-playlist-btn" id="submit-playlist-btn" disabled>
                                <span>📤</span>
                                <span>提交歌单</span>
                            </button>
                        </div>
                        
                        <div class="playlist-items" id="playlist-items">
                            <div class="empty-playlist">
                                <div class="empty-playlist-icon">🎵</div>
                                <div class="empty-playlist-message">歌单为空</div>
                                <div class="empty-playlist-submessage">
                                    请从左侧添加歌曲到歌单
                                </div>
                            </div>
                        </div>
                        
                        <div class="price-recommendation" id="price-recommendation" style="display: none;">
                            <h4>💰 价格推荐</h4>
                            <div class="recommended-plan">
                                <span class="plan-name" id="recommended-plan-name">基础版</span>
                                <span class="plan-price" id="recommended-plan-price">RM 29</span>
                            </div>
                            <div class="shipping-cost">
                                <span>配送费用</span>
                                <span id="shipping-cost-text">RM 0 (西马免费)</span>
                            </div>
                            <div class="total-price">
                                <span>总计金额</span>
                                <span id="total-price-text">RM 29</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 移动端Tabs布局 -->
                <div class="karaoke-tabs">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="find-songs">
                            <span>🔍</span>
                            <span>找歌曲</span>
                        </button>
                        <button class="tab-btn" data-tab="my-playlist">
                            <span>🎵</span>
                            <span>我的歌单</span>
                            <span class="playlist-count-number-mobile" id="playlist-count-mobile">0</span>
                        </button>
                    </div>
                    
                    <div class="tabs-content">
                        <!-- 找歌曲标签页 -->
                        <div class="tab-pane active" id="find-songs-tab">
                            <div class="songs-section">
                                <div class="charts-container">
                                    <div class="chart-category active" data-category="chinese-pop">
                                        华语流行
                                    </div>
                                    <div class="chart-category" data-category="western-pop">
                                        欧美流行
                                    </div>
                                    <div class="chart-category" data-category="chinese-dj">
                                        中文DJ
                                    </div>
                                    <div class="chart-category" data-category="chinese-artists">
                                        华语歌手
                                    </div>
                                    <div class="chart-category" data-category="western-artists">
                                        欧美歌手
                                    </div>
                                </div>
                                
                                <div class="search-container">
                                    <input type="text" class="search-input" id="search-input-mobile" 
                                           placeholder="搜索歌曲名称、歌手或专辑...">
                                    <button class="search-btn" id="search-btn-mobile">
                                        <span>🔍</span>
                                        <span>搜索</span>
                                    </button>
                                    <button class="clear-btn" id="clear-search-btn-mobile">
                                        <span>🗑️</span>
                                        <span>清空</span>
                                    </button>
                                </div>
                                
                                <div class="songs-container" id="songs-container-mobile">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                        <div>正在加载歌曲...</div>
                                    </div>
                                </div>
                                
                                <button class="load-more-btn" id="load-more-btn-mobile" style="display: none;">
                                    <span>⬇️</span>
                                    <span>加载更多歌曲</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 我的歌单标签页 -->
                        <div class="tab-pane" id="my-playlist-tab">
                            <div class="playlist-section">
                                <div class="playlist-header">
                                    <div class="playlist-count">
                                        <span>我的歌单</span>
                                        <span class="playlist-count-number" id="playlist-count-tab">0</span>
                                    </div>
                                    <button class="submit-playlist-btn" id="submit-playlist-btn-mobile" disabled>
                                        <span>📤</span>
                                        <span>提交歌单</span>
                                    </button>
                                </div>
                                
                                <div class="playlist-items" id="playlist-items-mobile">
                                    <div class="empty-playlist">
                                        <div class="empty-playlist-icon">🎵</div>
                                        <div class="empty-playlist-message">歌单为空</div>
                                        <div class="empty-playlist-submessage">
                                            请在"找歌曲"标签页添加歌曲
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="price-recommendation" id="price-recommendation-mobile" style="display: none;">
                                    <h4>💰 价格推荐</h4>
                                    <div class="recommended-plan">
                                        <span class="plan-name" id="recommended-plan-name-mobile">基础版</span>
                                        <span class="plan-price" id="recommended-plan-price-mobile">RM 29</span>
                                    </div>
                                    <div class="shipping-cost">
                                        <span>配送费用</span>
                                        <span id="shipping-cost-text-mobile">RM 0 (西马免费)</span>
                                    </div>
                                    <div class="total-price">
                                        <span>总计金额</span>
                                        <span id="total-price-text-mobile">RM 29</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 价格配套页面 -->
            <div id="pricing-page">
                <div class="pricing-header">
                    <h2>💰 价格配套选择</h2>
                    <p style="opacity: 0.8; margin-top: 10px;">选择适合您的歌曲数量配套</p>
                </div>
                
                <div class="pricing-container">
                    <div class="pricing-card">
                        <div class="plan-name">基础版</div>
                        <div class="price">RM 29</div>
                        <div class="song-range">1 - 20 首歌曲</div>
                        <button class="select-btn" data-plan="basic">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">标准版</div>
                        <div class="price">RM 49</div>
                        <div class="song-range">21 - 50 首歌曲</div>
                        <button class="select-btn" data-plan="standard">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card popular">
                        <div class="popular-badge">最受欢迎</div>
                        <div class="plan-name">进阶版</div>
                        <div class="price">RM 69</div>
                        <div class="song-range">51 - 100 首歌曲</div>
                        <button class="select-btn" data-plan="premium">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">豪华版</div>
                        <div class="price">RM 89</div>
                        <div class="song-range">101 - 200 首歌曲</div>
                        <button class="select-btn" data-plan="deluxe">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">专业版</div>
                        <div class="price">RM 109</div>
                        <div class="song-range">201 - 300 首歌曲</div>
                        <button class="select-btn" data-plan="professional">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">旗舰版</div>
                        <div class="price">RM 129</div>
                        <div class="song-range">301 - 400 首歌曲</div>
                        <button class="select-btn" data-plan="flagship">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">至尊版</div>
                        <div class="price">RM 159</div>
                        <div class="song-range">401 - 500 首歌曲</div>
                        <button class="select-btn" data-plan="ultimate">
                            选择此配套
                        </button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">自定义版</div>
                        <div class="price">RM 0.30/每首</div>
                        <div class="song-range">501+ 首歌曲</div>
                        <button class="select-btn" data-plan="custom">
                            联系定制
                        </button>
                    </div>
                </div>
                
                <!-- 配送信息 -->
                <div class="shipping-info">
                    <h3>🚚 配送信息</h3>
                    <div class="shipping-options">
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">
                                    <span>🇲🇾</span>
                                    <span>西马</span>
                                </span>
                                <span class="shipping-price">免费配送</span>
                            </div>
                            <div class="shipping-desc">
                                预计 5-7 个工作日内送达
                            </div>
                        </div>
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">
                                    <span>✈️</span>
                                    <span>东马</span>
                                </span>
                                <span class="shipping-price">RM 8.00</span>
                            </div>
                            <div class="shipping-desc">
                                预计 7-10 个工作日内送达
                            </div>
                        </div>
                    </div>
                    <div class="shipping-note">
                        * 所有配套均包含完整的技术支持和售后服务
                    </div>
                </div>
            </div>
            
            <!-- 我的订单页面 -->
            <div id="my-orders-page">
                <div class="my-orders-header">
                    <h2>📋 我的订单</h2>
                    <div class="my-orders-controls">
                        <button class="refresh-btn" id="refresh-my-orders-btn">
                            <span>🔄</span>
                            <span>刷新</span>
                        </button>
                        <button class="filter-btn" id="filter-my-orders-btn">
                            <span>🔍</span>
                            <span>筛选</span>
                        </button>
                    </div>
                </div>
                
                <!-- 筛选面板 -->
                <div class="filter-panel" id="my-orders-filter-panel">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">订单状态</label>
                            <select class="filter-select" id="my-orders-filter-status">
                                <option value="all">全部状态</option>
                                <option value="pending">待付款</option>
                                <option value="paid">已付款</option>
                                <option value="shipped">已发货</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">开始日期</label>
                            <input type="date" class="filter-date" id="my-orders-filter-start-date">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">结束日期</label>
                            <input type="date" class="filter-date" id="my-orders-filter-end-date">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="clear-filter-btn" id="clear-my-orders-filter-btn">
                            清除筛选
                        </button>
                        <button class="apply-filter-btn" id="apply-my-orders-filter-btn">
                            应用筛选
                        </button>
                    </div>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination-container" id="my-orders-pagination">
                    <!-- 分页按钮将动态生成 -->
                </div>
                
                <!-- 订单表格 -->
                <div class="my-orders-container">
                    <table class="my-orders-table">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>套餐类型</th>
                                <th>歌曲数量</th>
                                <th>总金额</th>
                                <th>配送地区</th>
                                <th>订单状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="my-orders-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 60px;">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                        <div>正在加载订单数据...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination-container" id="my-orders-pagination-bottom">
                    <!-- 分页按钮将动态生成 -->
                </div>
            </div>
            
            <!-- 订单管理页面 -->
            <div id="orders-page">
                <div class="orders-header">
                    <h2>👑 订单管理系统</h2>
                    <div class="orders-controls">
                        <button class="export-btn" id="export-excel-btn">
                            <span>📊</span>
                            <span>导出Excel</span>
                        </button>
                        <button class="refresh-btn" id="refresh-orders-btn">
                            <span>🔄</span>
                            <span>刷新订单</span>
                        </button>
                        <button class="filter-btn" id="filter-orders-btn">
                            <span>🔍</span>
                            <span>筛选订单</span>
                        </button>
                        <button class="batch-btn" id="batch-operations-btn" style="display: none;">
                            <span>⚙️</span>
                            <span>批量操作</span>
                        </button>
                    </div>
                </div>
                
                <!-- 筛选面板 -->
                <div class="filter-panel" id="filter-panel">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">订单状态</label>
                            <select class="filter-select" id="filter-status">
                                <option value="all">全部状态</option>
                                <option value="pending">待付款</option>
                                <option value="paid">已付款</option>
                                <option value="shipped">已发货</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                                <option value="deleted">已删除</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">顾客姓名</label>
                            <input type="text" class="filter-input" id="filter-customer-name" 
                                   placeholder="输入顾客姓名">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">开始日期</label>
                            <input type="date" class="filter-date" id="filter-start-date">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">结束日期</label>
                            <input type="date" class="filter-date" id="filter-end-date">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="clear-filter-btn" id="clear-filter-btn">
                            清除筛选
                        </button>
                        <button class="apply-filter-btn" id="apply-filter-btn">
                            应用筛选
                        </button>
                    </div>
                </div>
                
                <!-- 批量操作面板 -->
                <div class="batch-panel" id="batch-panel">
                    <div class="batch-info">
                        <span>已选择</span>
                        <span class="batch-selected-count" id="batch-selected-count">0</span>
                        <span>个订单</span>
                    </div>
                    <div class="batch-actions">
                        <button class="batch-action-btn batch-export-btn" id="batch-export-btn">
                            <span>📥</span>
                            <span>导出选中</span>
                        </button>
                        <button class="batch-action-btn batch-status-btn" id="batch-status-btn">
                            <span>🔄</span>
                            <span>批量改状态</span>
                        </button>
                        <button class="batch-action-btn batch-delete-btn" id="batch-delete-btn">
                            <span>🗑️</span>
                            <span>批量删除</span>
                        </button>
                        <button class="batch-action-btn batch-clear-btn" id="batch-clear-btn">
                            <span>✖️</span>
                            <span>取消选择</span>
                        </button>
                    </div>
                </div>
                
                <!-- 统计卡片 -->
                <div class="stats-cards" id="stats-cards">
                    <div class="stat-card">
                        <div class="stat-card-icon">📊</div>
                        <div class="stat-card-value" id="stat-total-orders">0</div>
                        <div class="stat-card-label">总订单数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">💰</div>
                        <div class="stat-card-value" id="stat-total-revenue">RM 0</div>
                        <div class="stat-card-label">总收入</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">📈</div>
                        <div class="stat-card-value" id="stat-avg-order">RM 0</div>
                        <div class="stat-card-label">平均订单</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">🎵</div>
                        <div class="stat-card-value" id="stat-total-songs">0</div>
                        <div class="stat-card-label">总歌曲数</div>
                    </div>
                </div>
                
                <!-- 已移除图表容器 -->
                <!-- 原charts-container-orders区域已删除 -->
                
                <!-- 分页控件 -->
                <div class="pagination-container" id="orders-pagination">
                    <!-- 分页按钮将动态生成 -->
                </div>
                
                <!-- 订单表格 -->
                <div class="orders-table-container">
                    <table class="orders-table" id="orders-table">
                        <thead>
                            <tr>
                                <th class="select-checkbox">
                                    <input type="checkbox" id="select-all-checkbox">
                                </th>
                                <th>订单号</th>
                                <th>顾客姓名</th>
                                <th>套餐类型</th>
                                <th>歌曲数量</th>
                                <th>总金额</th>
                                <th>配送地区</th>
                                <th>订单状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 60px;">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                        <div>正在加载订单数据...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination-container" id="orders-pagination-bottom">
                    <!-- 分页按钮将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 定制歌厅系统 v2.2.3 - JavaScript代码
        // ============================================
        
        // ==================== 应用配置 ====================
        const APP_CONFIG = {
            name: "定制你的专属歌厅",
            version: "2.2.3",
            environment: "production"
        };

        // ==================== Firebase 配置 ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAMn7EOOUDpIGXzA8EhPBtLWw7BwyU2Rdc",
            authDomain: "karaoke-customizer.firebaseapp.com",
            projectId: "karaoke-customizer",
            storageBucket: "karaoke-customizer.firebasestorage.app",
            messagingSenderId: "593643512892",
            appId: "1:593643512892:web:c21ec4ce7c2d286fed4f39",
            measurementId: "G-D791D33Y6R"
        };

        // ==================== 应用状态变量 ====================
        let currentUser = null;
        let currentSongs = [];
        let playlist = [];
        let orders = [];
        let myOrders = [];
        let selectedOrders = new Set(); // 批量选择的订单ID
        let currentSearchOffset = 0;
        let currentSearchTerm = '';
        let currentChartCategory = 'chinese-pop';
        let isAdmin = false;
        let firebaseApp, auth, firestore, analytics;
        
        // 分页管理器实例
        let ordersPagination = null;
        let myOrdersPagination = null;
        
        // 音频播放状态
        let currentAudio = null;
        let currentlyPlayingId = null;

        // ==================== 页面初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 初始化定制歌厅系统 v2.2.3...');
            console.log(`应用名称: ${APP_CONFIG.name}`);
            console.log(`环境: ${APP_CONFIG.environment}`);
            
            // 初始化Firebase
            initializeFirebase();
            
            // 初始化页面导航
            initPageNavigation();
            
            // 初始化事件监听
            setupEventListeners();
            
            // 初始化移动端Tabs
            initMobileTabs();
            
            // 初始化分页管理器
            ordersPagination = new PaginationManager('#orders-table', 20);
            myOrdersPagination = new PaginationManager('#my-orders-table', 10);
            
            // 加载默认排行榜
            loadChartOptimized('chinese-pop');
        });

        // ==================== Firebase 初始化 ====================
        function initializeFirebase() {
            try {
                console.log('🔧 Firebase 初始化中...', firebaseConfig);
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                analytics = firebaseApp.analytics();
                
                console.log('✅ Firebase 初始化成功');
                
                // 设置认证状态监听
                auth.onAuthStateChanged(handleAuthStateChange);
                
            } catch (error) {
                console.error('❌ Firebase 初始化失败:', error);
                showMessage('系统初始化失败，请刷新页面重试', 'error');
            }
        }

        function handleAuthStateChange(user) {
            if (user) {
                console.log('✅ 用户已登录:', user.email);
                currentUser = user;
                updateUserUI();
                
                // 检查管理员状态
                checkAdminStatus(user);
                
            } else {
                console.log('❌ 用户已退出');
                currentUser = null;
                updateUserUI();
            }
        }

        // ==================== 检查管理员状态 ====================
        function checkAdminStatus(user) {
            try {
                // 管理员邮箱列表
                const adminEmails = [
                    'erosseraph@gmail.com',
                    'admin@karaoke.com'
                ].map(email => email.toLowerCase());
                
                const userEmail = user.email.toLowerCase();
                isAdmin = adminEmails.includes(userEmail);
                
                // 获取管理元素
                const ordersNav = document.getElementById('orders-nav');
                const myOrdersNav = document.getElementById('my-orders-nav');
                const batchBtn = document.getElementById('batch-operations-btn');
                
                // 所有登录用户都可以看到"我的订单"
                myOrdersNav.style.display = 'block';
                
                if (isAdmin) {
                    // 显示管理功能
                    ordersNav.style.display = 'block';
                    batchBtn.style.display = 'flex';
                    console.log('👑 ' + user.email + ' 是管理员');
                    
                    // 如果当前在订单页面，重新加载数据
                    if (document.getElementById('orders-page').style.display === 'block') {
                        loadOrders();
                    }
                } else {
                    // 隐藏管理功能
                    ordersNav.style.display = 'none';
                    batchBtn.style.display = 'none';
                    console.log('🚫 ' + user.email + ' 不是管理员');
                }
                
            } catch (error) {
                console.error('检查管理员状态失败:', error);
            }
        }

        // ==================== 移动端Tabs初始化 ====================
        function initMobileTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const isMobile = window.innerWidth <= 768;
            
            if (!isMobile) return;
            
            // 显示移动端布局，隐藏桌面端布局
            document.querySelector('.karaoke-desktop').style.display = 'none';
            document.querySelector('.karaoke-tabs').style.display = 'flex';
            
            // 添加标签切换事件
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // 更新按钮状态
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新标签页内容
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // 如果是歌单标签，更新显示
                    if (tabId === 'my-playlist') {
                        updateMobilePlaylistDisplay();
                    }
                });
            });
        }

        // ==================== 页面导航功能 ====================
        function initPageNavigation() {
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            const myOrdersNav = document.getElementById('my-orders-nav');
            const ordersNav = document.getElementById('orders-nav');
            
            karaokeNav.addEventListener('click', function() {
                showPage('karaoke');
                setActiveNav(this);
            });
            
            pricingNav.addEventListener('click', function() {
                showPage('pricing');
                setActiveNav(this);
            });
            
            myOrdersNav.addEventListener('click', function() {
                showPage('my-orders');
                setActiveNav(this);
                loadMyOrders();
            });
            
            ordersNav.addEventListener('click', function() {
                showPage('orders');
                setActiveNav(this);
                loadOrders();
            });
        }
        
        function showPage(page) {
            const karaokePage = document.getElementById('karaoke-page');
            const pricingPage = document.getElementById('pricing-page');
            const myOrdersPage = document.getElementById('my-orders-page');
            const ordersPage = document.getElementById('orders-page');
            
            // 隐藏所有页面
            karaokePage.style.display = 'none';
            pricingPage.style.display = 'none';
            myOrdersPage.style.display = 'none';
            ordersPage.style.display = 'none';
            
            // 隐藏筛选面板和批量面板
            document.getElementById('filter-panel').classList.remove('show');
            document.getElementById('my-orders-filter-panel').classList.remove('show');
            document.getElementById('batch-panel').classList.remove('show');
            selectedOrders.clear();
            updateBatchPanel();
            
            // 显示目标页面
            if (page === 'karaoke') {
                karaokePage.style.display = 'flex';
            } else if (page === 'pricing') {
                pricingPage.style.display = 'block';
            } else if (page === 'my-orders') {
                myOrdersPage.style.display = 'block';
            } else if (page === 'orders') {
                ordersPage.style.display = 'block';
            }
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            activeButton.classList.add('active');
        }

        // ==================== 事件监听器设置 ====================
        function setupEventListeners() {
            // 排行榜点击事件（桌面端）
            document.querySelectorAll('.chart-category').forEach(chart => {
                chart.addEventListener('click', function() {
                    const category = this.dataset.category;
                    currentChartCategory = category;
                    loadChartOptimized(category);
                    
                    // 更新活跃状态
                    document.querySelectorAll('.chart-category').forEach(c => {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 如果是移动端，也更新移动端的活跃状态
                    updateMobileChartActiveState(category);
                });
            });
            
            // 搜索功能（桌面端）
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // 清空搜索（桌面端）
            document.getElementById('clear-search-btn').addEventListener('click', function() {
                document.getElementById('search-input').value = '';
                loadChartOptimized(currentChartCategory);
            });
            
            // 搜索功能（移动端）
            const searchBtnMobile = document.getElementById('search-btn-mobile');
            const searchInputMobile = document.getElementById('search-input-mobile');
            
            searchBtnMobile.addEventListener('click', performSearchMobile);
            searchInputMobile.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearchMobile();
                }
            });
            
            // 清空搜索（移动端）
            document.getElementById('clear-search-btn-mobile').addEventListener('click', function() {
                document.getElementById('search-input-mobile').value = '';
                loadChartOptimized(currentChartCategory);
            });
            
            // 加载更多歌曲（桌面端）
            document.getElementById('load-more-btn').addEventListener('click', loadMoreSongs);
            
            // 加载更多歌曲（移动端）
            document.getElementById('load-more-btn-mobile').addEventListener('click', loadMoreSongsMobile);
            
            // 提交歌单按钮（桌面端）
            document.getElementById('submit-playlist-btn').addEventListener('click', function() {
                if (playlist.length === 0) {
                    showMessage('歌单为空，请先添加歌曲', 'warning');
                    return;
                }
                
                if (!currentUser) {
                    showMessage('请先登录以提交订单', 'warning');
                    document.getElementById('login-modal').style.display = 'flex';
                    return;
                }
                
                showSubmitPlaylistModal();
            });
            
            // 提交歌单按钮（移动端）
            document.getElementById('submit-playlist-btn-mobile').addEventListener('click', function() {
                if (playlist.length === 0) {
                    showMessage('歌单为空，请先添加歌曲', 'warning');
                    return;
                }
                
                if (!currentUser) {
                    showMessage('请先登录以提交订单', 'warning');
                    document.getElementById('login-modal').style.display = 'flex';
                    return;
                }
                
                showSubmitPlaylistModal();
            });
            
            // 登录模态框
            document.getElementById('login-btn').addEventListener('click', function() {
                document.getElementById('login-modal').style.display = 'flex';
            });
            
            document.getElementById('close-login').addEventListener('click', function() {
                document.getElementById('login-modal').style.display = 'none';
            });
            
            // 提交歌单模态框
            document.getElementById('close-submit-playlist').addEventListener('click', function() {
                document.getElementById('submit-playlist-modal').style.display = 'none';
            });
            
            // 订单详情模态框
            document.getElementById('close-order-details').addEventListener('click', function() {
                document.getElementById('order-details-modal').style.display = 'none';
            });
            
            // 批量操作模态框
            document.getElementById('close-batch-operations').addEventListener('click', function() {
                document.getElementById('batch-operations-modal').style.display = 'none';
            });
            
            // 退出登录
            document.getElementById('logout-btn').addEventListener('click', function() {
                if (auth) {
                    auth.signOut();
                }
            });

            // 价格配套按钮
            document.querySelectorAll('.select-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const plan = this.dataset.plan;
                    handlePlanSelection(plan);
                });
            });

            // 登录方式按钮
            document.getElementById('email-login-btn').addEventListener('click', function() {
                showEmailLoginForm();
            });

            document.getElementById('google-login-btn').addEventListener('click', function() {
                signInWithGoogle();
            });

            // 订单管理按钮
            document.getElementById('refresh-orders-btn').addEventListener('click', function() {
                loadOrders();
            });
            
            document.getElementById('export-excel-btn').addEventListener('click', function() {
                exportOrdersToExcel();
            });
            
            document.getElementById('filter-orders-btn').addEventListener('click', function() {
                const filterPanel = document.getElementById('filter-panel');
                filterPanel.classList.toggle('show');
            });
            
            document.getElementById('batch-operations-btn').addEventListener('click', function() {
                showBatchOperationsModal();
            });
            
            // 我的订单按钮
            document.getElementById('refresh-my-orders-btn').addEventListener('click', function() {
                loadMyOrders();
            });
            
            document.getElementById('filter-my-orders-btn').addEventListener('click', function() {
                const filterPanel = document.getElementById('my-orders-filter-panel');
                filterPanel.classList.toggle('show');
            });
            
            // 筛选功能
            document.getElementById('apply-filter-btn').addEventListener('click', applyFilters);
            document.getElementById('clear-filter-btn').addEventListener('click', clearFilters);
            document.getElementById('apply-my-orders-filter-btn').addEventListener('click', applyMyOrdersFilters);
            document.getElementById('clear-my-orders-filter-btn').addEventListener('click', clearMyOrdersFilters);
            
            // 批量操作
            document.getElementById('batch-export-btn').addEventListener('click', batchExportOrders);
            document.getElementById('batch-status-btn').addEventListener('click', batchUpdateStatus);
            document.getElementById('batch-delete-btn').addEventListener('click', batchDeleteOrders);
            document.getElementById('batch-clear-btn').addEventListener('click', clearSelectedOrders);
            
            // 全选复选框
            document.getElementById('select-all-checkbox').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.order-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    if (this.checked) {
                        selectedOrders.add(checkbox.dataset.orderId);
                    } else {
                        selectedOrders.delete(checkbox.dataset.orderId);
                    }
                });
                updateBatchPanel();
            });
            
            // 表单提交
            document.getElementById('submit-playlist-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitPlaylistOrder();
            });
            
            // 表单实时验证
            setupFormValidation();
            
            // 配送地区选择
            document.querySelectorAll('input[name="shipping-region"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePriceRecommendation();
                });
            });
            
            // 点击外部关闭模态框
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // 窗口大小变化时重新初始化布局
            window.addEventListener('resize', function() {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    document.querySelector('.karaoke-desktop').style.display = 'none';
                    document.querySelector('.karaoke-tabs').style.display = 'flex';
                } else {
                    document.querySelector('.karaoke-desktop').style.display = 'flex';
                    document.querySelector('.karaoke-tabs').style.display = 'none';
                }
            });
        }
        
        // ==================== 移动端相关功能 ====================
        function updateMobileChartActiveState(category) {
            // 更新移动端的活跃状态
            const mobileCharts = document.querySelectorAll('#find-songs-tab .chart-category');
            mobileCharts.forEach(chart => {
                if (chart.dataset.category === category) {
                    chart.classList.add('active');
                } else {
                    chart.classList.remove('active');
                }
            });
        }
        
        function updateMobilePlaylistDisplay() {
            // 更新移动端的歌单显示
            const playlistCountMobile = document.getElementById('playlist-count-mobile');
            const playlistCountTab = document.getElementById('playlist-count-tab');
            
            if (playlistCountMobile) playlistCountMobile.textContent = playlist.length;
            if (playlistCountTab) playlistCountTab.textContent = playlist.length;
            
            // 更新移动端歌单列表
            renderMobilePlaylist();
            
            // 更新移动端价格推荐
            updateMobilePriceRecommendation();
        }
        
        function renderMobilePlaylist() {
            const playlistContainer = document.getElementById('playlist-items-mobile');
            const submitBtn = document.getElementById('submit-playlist-btn-mobile');
            const priceRecommendation = document.getElementById('price-recommendation-mobile');
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = `
                    <div class="empty-playlist">
                        <div class="empty-playlist-icon">🎵</div>
                        <div class="empty-playlist-message">歌单为空</div>
                        <div class="empty-playlist-submessage">
                            请在"找歌曲"标签页添加歌曲
                        </div>
                    </div>
                `;
                priceRecommendation.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }
            
            playlistContainer.innerHTML = '';
            priceRecommendation.style.display = 'block';
            submitBtn.disabled = false;
            
            playlist.forEach((song, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.innerHTML = `
                    <div class="playlist-item-content">
                        <div class="song-number">${index + 1}</div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${index}">×</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('#playlist-items-mobile .remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    removeSongFromPlaylist(index);
                });
            });
        }
        
        function updateMobilePriceRecommendation() {
            if (playlist.length === 0) return;
            
            const songCount = playlist.length;
            const recommendedPlan = getRecommendedPlan(songCount);
            const shippingRegion = document.querySelector('input[name="shipping-region"]:checked')?.value || 'west';
            const shippingCost = shippingRegion === 'east' ? 8 : 0;
            const totalPrice = (recommendedPlan.isCustom ? recommendedPlan.price : recommendedPlan.price) + shippingCost;
            
            // 更新移动端显示
            const planNameEl = document.getElementById('recommended-plan-name-mobile');
            const planPriceEl = document.getElementById('recommended-plan-price-mobile');
            const shippingCostEl = document.getElementById('shipping-cost-text-mobile');
            const totalPriceEl = document.getElementById('total-price-text-mobile');
            
            if (planNameEl) planNameEl.textContent = recommendedPlan.name;
            if (planPriceEl) planPriceEl.textContent = 
                recommendedPlan.isCustom ? `RM ${recommendedPlan.price.toFixed(2)}` : `RM ${recommendedPlan.price}`;
            if (shippingCostEl) shippingCostEl.textContent = 
                shippingCost === 0 ? 'RM 0 (西马免费)' : `RM ${shippingCost}`;
            if (totalPriceEl) totalPriceEl.textContent = 
                recommendedPlan.isCustom ? `RM ${totalPrice.toFixed(2)}` : `RM ${totalPrice}`;
        }
        
        function performSearchMobile() {
            const searchInput = document.getElementById('search-input-mobile');
            const query = searchInput.value.trim();
            
            if (!query) {
                showMessage('请输入搜索关键词', 'warning');
                return;
            }
            
            const songsContainer = document.getElementById('songs-container-mobile');
            songsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>搜索中...</div></div>';
            
            currentSearchTerm = query;
            currentSearchOffset = 0;
            
            searchMusic(query, 50, 0).then(songs => {
                currentSongs = songs;
                renderMobileSongs(songs);
                
                if (songs.length === 0) {
                    showMessage('未找到相关歌曲', 'info');
                } else {
                    showMessage(`找到 ${songs.length} 首相关歌曲`, 'success');
                    
                    if (songs.length >= 50) {
                        document.getElementById('load-more-btn-mobile').style.display = 'flex';
                    }
                }
            }).catch(error => {
                console.error('移动端搜索失败:', error);
                songsContainer.innerHTML = `
                    <div class="error">
                        <div class="error-icon">❌</div>
                        <div>搜索失败</div>
                        <div class="empty-playlist-submessage">请检查网络连接</div>
                    </div>
                `;
            });
        }
        
        function loadMoreSongsMobile() {
            const loadMoreBtn = document.getElementById('load-more-btn-mobile');
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px;"></div><span>加载中...</span>';
            
            currentSearchOffset += 50;
            
            searchMusic(currentSearchTerm || getSearchConfig(currentChartCategory).terms[0], 50, currentSearchOffset)
                .then(moreSongs => {
                    if (moreSongs.length > 0) {
                        currentSongs = [...currentSongs, ...moreSongs];
                        renderMobileSongs(currentSongs);
                        
                        if (moreSongs.length >= 50) {
                            loadMoreBtn.disabled = false;
                            loadMoreBtn.innerHTML = '<span>⬇️</span><span>加载更多歌曲</span>';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('移动端加载更多失败:', error);
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<span>⬇️</span><span>加载更多歌曲</span>';
                    showMessage('加载失败，请重试', 'error');
                });
        }
        
        function renderMobileSongs(songs) {
            const songsContainer = document.getElementById('songs-container-mobile');
            
            if (currentSearchOffset === 0) {
                songsContainer.innerHTML = '';
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `
                            <button class="preview-btn" data-url="${song.previewUrl}" data-id="${song.id}">
                                <span>▶️</span>
                                <span>试听</span>
                            </button>
                        ` : ''}
                        <button class="add-btn" data-id="${song.id}">
                            <span>➕</span>
                            <span>添加</span>
                        </button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
            
            // 添加歌曲点击事件
            document.querySelectorAll('#songs-container-mobile .add-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const songId = this.dataset.id;
                    addSongToPlaylist(songId);
                });
            });
            
            // 添加试听按钮事件
            document.querySelectorAll('#songs-container-mobile .preview-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const previewUrl = this.dataset.url;
                    const songId = this.dataset.id;
                    previewSong(previewUrl, songId);
                });
            });
        }
        
        // ==================== 表单验证设置 ====================
        function setupFormValidation() {
            const form = document.getElementById('submit-playlist-form');
            const fields = form.querySelectorAll('.form-input, .form-textarea');
            
            fields.forEach(field => {
                // 实时验证
                field.addEventListener('input', function() {
                    validateField(this);
                });
                
                // 失去焦点时验证
                field.addEventListener('blur', function() {
                    validateField(this);
                });
            });
        }
        
        function validateField(field) {
            const value = field.value.trim();
            const fieldId = field.id;
            const errorElement = document.getElementById(fieldId + '-error');
            
            // 清除之前的错误状态
            field.classList.remove('error');
            if (errorElement) {
                errorElement.textContent = '';
            }
            
            // 非必填字段且为空，跳过验证
            if (!field.required && value === '') {
                return true;
            }
            
            let isValid = true;
            let errorMessage = '';
            
            switch(fieldId) {
                case 'customer-name':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = '姓名至少需要2个字符';
                    }
                    break;
                    
                case 'customer-phone':
                    const phoneRegex = /^01[0-9]{8,9}$/;
                    const cleanPhone = value.replace(/\D/g, '');
                    if (!phoneRegex.test(cleanPhone)) {
                        isValid = false;
                        errorMessage = '请输入有效的马来西亚电话号码（10-11位数字，以01开头）';
                    }
                    break;
                    
                case 'customer-email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = '请输入有效的邮箱地址';
                    }
                    break;
                    
                case 'address-street':
                    if (value.length < 5) {
                        isValid = false;
                        errorMessage = '街道地址至少需要5个字符';
                    }
                    break;
                    
                case 'address-city':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = '城市名称至少需要2个字符';
                    }
                    break;
                    
                case 'address-state':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = '州属至少需要2个字符';
                    }
                    break;
                    
                case 'address-zip':
                    const zipRegex = /^[0-9]{5}$/;
                    if (!zipRegex.test(value)) {
                        isValid = false;
                        errorMessage = '邮编必须是5位数字';
                    }
                    break;
            }
            
            if (!isValid) {
                field.classList.add('error');
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                }
            }
            
            return isValid;
        }
        
        function validateForm() {
            const form = document.getElementById('submit-playlist-form');
            const fields = form.querySelectorAll('.form-input[required], .form-textarea[required]');
            let isValid = true;
            
            fields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
        
        // ==================== 登录功能 ====================
        function showEmailLoginForm() {
            const loginModal = document.getElementById('login-modal');
            loginModal.querySelector('.modal-content').innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">邮箱登录/注册</h2>
                    <button class="close-btn" id="close-login">&times;</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">邮箱地址</label>
                    <input type="email" class="form-input" id="login-email" placeholder="输入您的邮箱">
                </div>
                
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" class="form-input" id="login-password" placeholder="输入密码">
                </div>
                
                <button class="form-submit-btn" id="submit-login">登录 / 注册</button>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button class="nav-btn" style="background: transparent; font-size: 0.9rem;" id="back-to-login-methods">
                        ← 返回登录方式选择
                    </button>
                </div>
            `;

            document.getElementById('close-login').addEventListener('click', function() {
                loginModal.style.display = 'none';
            });

            document.getElementById('submit-login').addEventListener('click', function() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmail(email, password);
            });

            document.getElementById('back-to-login-methods').addEventListener('click', function() {
                showLoginMethods();
            });
        }

        function showLoginMethods() {
            const loginModal = document.getElementById('login-modal');
            loginModal.querySelector('.modal-content').innerHTML = `
                <div class="modal-header">
                    <h2 class="modal-title">登录 / 注册</h2>
                    <button class="close-btn" id="close-login">&times;</button>
                </div>
                
                <div class="login-methods">
                    <button class="login-method-btn" id="email-login-btn">
                        <span class="login-method-icon">📧</span>
                        <span>邮箱登录/注册</span>
                    </button>
                    <button class="login-method-btn" id="google-login-btn">
                        <span class="login-method-icon">🔵</span>
                        <span>Google 登录</span>
                    </button>
                </div>
            `;

            document.getElementById('close-login').addEventListener('click', function() {
                loginModal.style.display = 'none';
            });

            document.getElementById('email-login-btn').addEventListener('click', showEmailLoginForm);
            document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);
        }

        async function signInWithEmail(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('✅ 邮箱登录成功:', userCredential.user.email);
                showMessage('登录成功！', 'success');
                document.getElementById('login-modal').style.display = 'none';
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    // 用户不存在，尝试注册
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        console.log('✅ 邮箱注册成功:', userCredential.user.email);
                        showMessage('注册成功！', 'success');
                        document.getElementById('login-modal').style.display = 'none';
                    } catch (signUpError) {
                        console.error('❌ 注册失败:', signUpError);
                        showMessage(`注册失败: ${signUpError.message}`, 'error');
                    }
                } else {
                    console.error('❌ 登录失败:', error);
                    showMessage(`登录失败: ${error.message}`, 'error');
                }
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                console.log('✅ Google登录成功:', userCredential.user.email);
                showMessage('Google登录成功！', 'success');
                document.getElementById('login-modal').style.display = 'none';
            } catch (error) {
                // 忽略特定的COOP错误
                if (error.message.includes('Cross-Origin-Opener-Policy') || 
                    error.code === 'auth/popup-blocked') {
                    console.log('弹窗被阻止，建议使用邮箱登录');
                    showMessage('弹窗被阻止，请使用邮箱登录', 'warning');
                } else {
                    console.error('❌ Google登录失败:', error);
                    showMessage(`Google登录失败: ${error.message}`, 'error');
                }
            }
        }

        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const loginBtn = document.getElementById('login-btn');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            
            if (currentUser) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                
                // 更新用户信息
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                userAvatar.textContent = initial;
                userEmail.textContent = displayName;
                
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'flex';
                isAdmin = false;
                
                // 用户退出时隐藏管理功能
                document.getElementById('orders-nav').style.display = 'none';
                document.getElementById('my-orders-nav').style.display = 'none';
                document.getElementById('batch-operations-btn').style.display = 'none';
            }
        }

        // ==================== 价格套餐选择处理 ====================
        function handlePlanSelection(plan) {
            if (playlist.length === 0) {
                showMessage('请先添加歌曲到歌单', 'warning');
                showPage('karaoke');
                setActiveNav(document.getElementById('karaoke-nav'));
                return;
            }

            const planNames = {
                'basic': '基础版',
                'standard': '标准版',
                'premium': '进阶版',
                'deluxe': '豪华版',
                'professional': '专业版',
                'flagship': '旗舰版',
                'ultimate': '至尊版',
                'custom': '自定义版'
            };

            const planPrices = {
                'basic': 29,
                'standard': 49,
                'premium': 69,
                'deluxe': 89,
                'professional': 109,
                'flagship': 129,
                'ultimate': 159,
                'custom': playlist.length * 0.3
            };

            const planName = planNames[plan];
            const price = plan === 'custom' ? 
                `RM ${planPrices[plan].toFixed(2)}` : 
                `RM ${planPrices[plan]}`;

            if (!currentUser) {
                showMessage('请先登录以提交订单', 'warning');
                document.getElementById('login-modal').style.display = 'flex';
                return;
            }

            // 切换到提交歌单表单
            showSubmitPlaylistModal();
        }

        // ==================== 显示提交歌单模态框 ====================
        function showSubmitPlaylistModal() {
            // 更新模态框中的歌曲数量
            document.getElementById('modal-song-count').textContent = playlist.length;
            
            // 计算价格
            updatePriceRecommendation();
            
            // 显示模态框
            document.getElementById('submit-playlist-modal').style.display = 'flex';
        }
        
        function updatePriceRecommendation() {
            const songCount = playlist.length;
            
            // 获取推荐套餐
            const recommendedPlan = getRecommendedPlan(songCount);
            
            // 获取配送地区
            const shippingRegion = document.querySelector('input[name="shipping-region"]:checked').value;
            const shippingCost = shippingRegion === 'east' ? 8 : 0;
            const totalPrice = (recommendedPlan.isCustom ? recommendedPlan.price : recommendedPlan.price) + shippingCost;
            
            // 更新桌面端显示
            document.getElementById('recommended-plan-name').textContent = recommendedPlan.name;
            document.getElementById('recommended-plan-price').textContent = 
                recommendedPlan.isCustom ? `RM ${recommendedPlan.price.toFixed(2)}` : `RM ${recommendedPlan.price}`;
            document.getElementById('shipping-cost-text').textContent = 
                shippingCost === 0 ? 'RM 0 (西马免费)' : `RM ${shippingCost}`;
            document.getElementById('total-price-text').textContent = 
                recommendedPlan.isCustom ? `RM ${totalPrice.toFixed(2)}` : `RM ${totalPrice}`;
            
            // 更新移动端显示
            updateMobilePriceRecommendation();
            
            // 更新表单中的价格显示
            document.getElementById('modal-base-price').textContent = 
                recommendedPlan.isCustom ? 
                `套餐价格: RM ${recommendedPlan.price.toFixed(2)}` : 
                `套餐价格: RM ${recommendedPlan.price}`;
            document.getElementById('modal-shipping-fee').textContent = 
                `配送费用: RM ${shippingCost}`;
            document.getElementById('modal-total-price').textContent = 
                recommendedPlan.isCustom ? 
                `总金额: RM ${totalPrice.toFixed(2)}` : 
                `总金额: RM ${totalPrice}`;
        }
        
        function getRecommendedPlan(songCount) {
            if (songCount <= 20) {
                return { name: "基础版", price: 29, isCustom: false };
            } else if (songCount <= 50) {
                return { name: "标准版", price: 49, isCustom: false };
            } else if (songCount <= 100) {
                return { name: "进阶版", price: 69, isCustom: false };
            } else if (songCount <= 200) {
                return { name: "豪华版", price: 89, isCustom: false };
            } else if (songCount <= 300) {
                return { name: "专业版", price: 109, isCustom: false };
            } else if (songCount <= 400) {
                return { name: "旗舰版", price: 129, isCustom: false };
            } else if (songCount <= 500) {
                return { name: "至尊版", price: 159, isCustom: false };
            } else {
                return { name: "自定义版", price: songCount * 0.3, isCustom: true };
            }
        }

        // ==================== 提交歌单订单 ====================
        async function submitPlaylistOrder() {
            // 验证表单
            if (!validateForm()) {
                showMessage('请正确填写所有必填字段', 'error');
                return;
            }
            
            // 禁用提交按钮防止重复提交
            const submitBtn = document.getElementById('submit-order-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            try {
                // 收集表单数据
                const formData = {
                    customerName: document.getElementById('customer-name').value.trim(),
                    customerPhone: document.getElementById('customer-phone').value.trim().replace(/\D/g, ''),
                    customerEmail: document.getElementById('customer-email').value.trim(),
                    addressStreet: document.getElementById('address-street').value.trim(),
                    addressCity: document.getElementById('address-city').value.trim(),
                    addressState: document.getElementById('address-state').value.trim(),
                    addressZip: document.getElementById('address-zip').value.trim(),
                    shippingRegion: document.querySelector('input[name="shipping-region"]:checked').value,
                    customerNote: document.getElementById('customer-note').value.trim(),
                    songCount: playlist.length,
                    songs: playlist.map(song => ({
                        title: song.title,
                        artist: song.artist,
                        album: song.album || ''
                    }))
                };
                
                // 计算价格
                const recommendedPlan = getRecommendedPlan(playlist.length);
                const shippingCost = formData.shippingRegion === 'east' ? 8 : 0;
                const basePrice = recommendedPlan.isCustom ? recommendedPlan.price : recommendedPlan.price;
                const totalPrice = basePrice + shippingCost;
                
                // 创建订单数据
                const orderData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    ...formData,
                    plan: recommendedPlan.name,
                    basePrice: basePrice,
                    shippingCost: shippingCost,
                    totalAmount: totalPrice,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // 保存到Firestore
                const docRef = await firestore.collection('orders').add(orderData);
                
                // 生成订单号并更新
                const orderId = `ORD-${Date.now()}-${docRef.id.substring(0, 4).toUpperCase()}`;
                await docRef.update({ orderId: orderId });
                
                console.log('✅ 订单创建成功:', orderId);
                
                // 显示成功消息
                showMessage(`订单提交成功！订单号: ${orderId}`, 'success');
                
                // 关闭模态框
                document.getElementById('submit-playlist-modal').style.display = 'none';
                
                // 清空歌单
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                updateMobilePlaylistDisplay();
                
                // 重置表单
                document.getElementById('submit-playlist-form').reset();
                
                // 如果有未完成的订单管理页面，刷新订单列表
                if (document.getElementById('orders-page').style.display === 'block') {
                    loadOrders();
                }
                if (document.getElementById('my-orders-page').style.display === 'block') {
                    loadMyOrders();
                }
                
            } catch (error) {
                console.error('❌ 创建订单失败:', error);
                showMessage(`创建订单失败: ${error.message}`, 'error');
            } finally {
                // 重新启用提交按钮
                submitBtn.disabled = false;
                submitBtn.textContent = '提交订单';
            }
        }

        // ==================== 分页系统 ====================
        class PaginationManager {
            constructor(tableSelector, itemsPerPage = 20) {
                this.tableSelector = tableSelector;
                this.itemsPerPage = itemsPerPage;
                this.currentPage = 1;
                this.totalItems = 0;
                this.totalPages = 0;
                this.allItems = [];
                this.filteredItems = [];
            }
            
            init(items) {
                this.allItems = items;
                this.filteredItems = [...items];
                this.totalItems = items.length;
                this.totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                this.currentPage = 1;
                
                this.renderTable();
                this.renderPagination();
            }
            
            filterItems(filterFn) {
                this.filteredItems = this.allItems.filter(filterFn);
                this.totalItems = this.filteredItems.length;
                this.totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                this.currentPage = 1;
                
                this.renderTable();
                this.renderPagination();
            }
            
            clearFilter() {
                this.filteredItems = [...this.allItems];
                this.totalItems = this.allItems.length;
                this.totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                this.currentPage = 1;
                
                this.renderTable();
                this.renderPagination();
            }
            
            renderTable() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageItems = this.filteredItems.slice(startIndex, endIndex);
                
                // 调用外部渲染函数
                if (this.tableSelector === '#orders-table') {
                    renderOrdersTable(pageItems);
                } else if (this.tableSelector === '#my-orders-table') {
                    renderMyOrdersTable(pageItems);
                }
            }
            
            renderPagination() {
                const topPagination = document.getElementById(`${this.tableSelector.substring(1)}-pagination`);
                const bottomPagination = document.getElementById(`${this.tableSelector.substring(1)}-pagination-bottom`);
                
                [topPagination, bottomPagination].forEach(paginationContainer => {
                    if (!paginationContainer) return;
                    
                    paginationContainer.innerHTML = '';
                    
                    // 上一页按钮
                    const prevBtn = this.createPaginationButton('上一页', this.currentPage > 1, () => {
                        if (this.currentPage > 1) {
                            this.currentPage--;
                            this.renderTable();
                            this.renderPagination();
                        }
                    });
                    paginationContainer.appendChild(prevBtn);
                    
                    // 页码按钮
                    const maxVisiblePages = 5;
                    let startPage = Math.max(1, this.currentPage - Math.floor(maxVisiblePages / 2));
                    let endPage = Math.min(this.totalPages, startPage + maxVisiblePages - 1);
                    
                    if (endPage - startPage + 1 < maxVisiblePages) {
                        startPage = Math.max(1, endPage - maxVisiblePages + 1);
                    }
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = this.createPaginationButton(
                            i.toString(),
                            i === this.currentPage,
                            () => {
                                this.currentPage = i;
                                this.renderTable();
                                this.renderPagination();
                            }
                        );
                        paginationContainer.appendChild(pageBtn);
                    }
                    
                    // 下一页按钮
                    const nextBtn = this.createPaginationButton('下一页', this.currentPage < this.totalPages, () => {
                        if (this.currentPage < this.totalPages) {
                            this.currentPage++;
                            this.renderTable();
                            this.renderPagination();
                        }
                    });
                    paginationContainer.appendChild(nextBtn);
                    
                    // 页数信息
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'page-info';
                    pageInfo.textContent = `第 ${this.currentPage} 页，共 ${this.totalPages} 页 (${this.totalItems} 条记录)`;
                    paginationContainer.appendChild(pageInfo);
                });
            }
            
            createPaginationButton(text, isActive, onClick) {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn';
                if (isActive) btn.classList.add('active');
                btn.textContent = text;
                btn.addEventListener('click', onClick);
                return btn;
            }
            
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                    this.renderTable();
                    this.renderPagination();
                }
            }
        }

        // ==================== 我的订单管理 ====================
        async function loadMyOrders() {
            if (!currentUser) {
                showMessage('请先登录查看订单', 'warning');
                document.getElementById('login-modal').style.display = 'flex';
                return;
            }

            const myOrdersTableBody = document.getElementById('my-orders-table-body');
            myOrdersTableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 60px;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>正在加载订单数据...</div>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const querySnapshot = await firestore.collection('orders')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                myOrders = [];
                querySnapshot.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.status !== 'deleted') { // 不显示已删除的订单
                        myOrders.push({
                            id: doc.id,
                            ...orderData,
                            createdAt: orderData.createdAt ? 
                                orderData.createdAt.toDate().toLocaleString('zh-CN') : '未知时间',
                            updatedAt: orderData.updatedAt ? 
                                orderData.updatedAt.toDate().toLocaleString('zh-CN') : '未知时间'
                        });
                    }
                });

                // 初始化分页
                myOrdersPagination.init(myOrders);
                
                // 如果没有订单，显示空状态
                if (myOrders.length === 0) {
                    myOrdersTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 80px;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">📭</div>
                                    <div class="empty-state-message">暂无订单</div>
                                    <div class="empty-state-submessage">
                                        请先创建歌单并提交订单
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }

            } catch (error) {
                console.error('❌ 加载我的订单失败:', error);
                myOrdersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 60px;">
                            <div class="error">
                                <div class="error-icon">❌</div>
                                <div>加载订单失败</div>
                                <div style="font-size: 0.9rem; margin-top: 10px;">
                                    ${error.message}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderMyOrdersTable(orders) {
            const myOrdersTableBody = document.getElementById('my-orders-table-body');
            
            if (orders.length === 0) {
                myOrdersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 80px;">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔍</div>
                                <div class="empty-state-message">未找到符合条件的订单</div>
                                <div class="empty-state-submessage">
                                    请尝试修改筛选条件
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            myOrdersTableBody.innerHTML = '';
            
            orders.forEach(order => {
                // 根据状态设置样式
                let statusClass = '';
                let statusText = '';
                let statusIcon = '';
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = '待付款';
                        statusIcon = '⏳';
                        break;
                    case 'paid':
                        statusClass = 'status-paid';
                        statusText = '已付款';
                        statusIcon = '✅';
                        break;
                    case 'shipped':
                        statusClass = 'status-shipped';
                        statusText = '已发货';
                        statusIcon = '🚚';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = '已完成';
                        statusIcon = '🏁';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = '已取消';
                        statusIcon = '❌';
                        break;
                    default:
                        statusClass = 'status-pending';
                        statusText = order.status || '待处理';
                }

                const row = document.createElement('tr');
                row.dataset.orderId = order.id;
                
                row.innerHTML = `
                    <td>${order.orderId || order.id}</td>
                    <td>${order.plan}</td>
                    <td>${order.songCount || 0}</td>
                    <td>RM ${order.totalAmount || 0}</td>
                    <td>${order.shippingRegion === 'east' ? '东马' : '西马'}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            <span>${statusIcon}</span>
                            <span>${statusText}</span>
                        </span>
                    </td>
                    <td>${order.createdAt}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" data-order-id="${order.id}">
                                <span>👁️</span>
                                <span>查看</span>
                            </button>
                        </div>
                    </td>
                `;
                
                myOrdersTableBody.appendChild(row);
            });

            // ============= 在这里添加事件绑定代码 =============
    // 方案1：最简单的修复（立即生效）
    setTimeout(() => {
        document.querySelectorAll('#my-orders-table .view-btn').forEach(btn => {
            // 移除所有现有事件（防止重复绑定）
            btn.replaceWith(btn.cloneNode(true));
        });
        
        // 重新绑定事件
        document.querySelectorAll('#my-orders-table .view-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const orderId = this.dataset.orderId;
                console.log('🔍 查看按钮点击，订单ID:', orderId);
                if (orderId) {
                    showOrderDetails(orderId);
                } else {
                    console.error('❌ 未找到订单ID');
                    showMessage('无法查看订单详情', 'error');
                }
            });
        });
        
        console.log('✅ 事件绑定完成，按钮数量:', 
            document.querySelectorAll('#my-orders-table .view-btn').length);
    }, 0);
    // ============= 事件绑定代码结束 =============
}
            // 添加查看详情事件
            document.querySelectorAll('#my-orders-table .view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    showOrderDetails(orderId);
                });
            });
        }
        
        function applyMyOrdersFilters() {
            const statusFilter = document.getElementById('my-orders-filter-status').value;
            const startDate = document.getElementById('my-orders-filter-start-date').value;
            const endDate = document.getElementById('my-orders-filter-end-date').value;
            
            myOrdersPagination.filterItems(order => {
                // 状态筛选
                if (statusFilter !== 'all' && order.status !== statusFilter) {
                    return false;
                }
                
                // 日期范围筛选
                if (startDate || endDate) {
                    const orderDate = order.createdAt ? new Date(order.createdAt) : null;
                    if (!orderDate) return false;
                    
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate + 'T23:59:59') : null;
                    
                    if (start && orderDate < start) return false;
                    if (end && orderDate > end) return false;
                }
                
                return true;
            });
            
            showMessage('筛选条件已应用', 'success');
        }
        
        function clearMyOrdersFilters() {
            document.getElementById('my-orders-filter-status').value = 'all';
            document.getElementById('my-orders-filter-start-date').value = '';
            document.getElementById('my-orders-filter-end-date').value = '';
            
            myOrdersPagination.clearFilter();
            showMessage('筛选条件已清除', 'success');
        }

        // ==================== 订单管理功能 ====================
        async function loadOrders() {
            if (!isAdmin) {
                showMessage('您没有权限访问此页面', 'error');
                return;
            }

            const ordersTableBody = document.getElementById('orders-table-body');
            ordersTableBody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 60px;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>正在加载订单数据...</div>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const snapshot = await firestore.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                orders = [];
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    orders.push({
                        id: doc.id,
                        ...orderData,
                        createdAt: orderData.createdAt ? 
                            orderData.createdAt.toDate().toLocaleString('zh-CN') : '未知时间',
                        updatedAt: orderData.updatedAt ? 
                            orderData.updatedAt.toDate().toLocaleString('zh-CN') : '未知时间'
                    });
                });

                // 初始化分页
                ordersPagination.init(orders);
                
                // 更新统计
                updateStatistics();

            } catch (error) {
                console.error('❌ 加载订单失败:', error);
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 60px;">
                            <div class="error">
                                <div class="error-icon">❌</div>
                                <div>加载订单失败</div>
                                <div style="font-size: 0.9rem; margin-top: 10px;">
                                    ${error.message}
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderOrdersTable(orders) {
            const ordersTableBody = document.getElementById('orders-table-body');
            
            if (orders.length === 0) {
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 80px;">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔍</div>
                                <div class="empty-state-message">未找到符合条件的订单</div>
                                <div class="empty-state-submessage">
                                    请尝试修改筛选条件
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            ordersTableBody.innerHTML = '';
            
            orders.forEach(order => {
                // 根据状态设置样式
                let statusClass = '';
                let statusText = '';
                let statusIcon = '';
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = '待付款';
                        statusIcon = '⏳';
                        break;
                    case 'paid':
                        statusClass = 'status-paid';
                        statusText = '已付款';
                        statusIcon = '✅';
                        break;
                    case 'shipped':
                        statusClass = 'status-shipped';
                        statusText = '已发货';
                        statusIcon = '🚚';
                        break;
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = '已完成';
                        statusIcon = '🏁';
                        break;
                    case 'cancelled':
                        statusClass = 'status-cancelled';
                        statusText = '已取消';
                        statusIcon = '❌';
                        break;
                    case 'deleted':
                        statusClass = 'status-deleted';
                        statusText = '已删除';
                        statusIcon = '🗑️';
                        break;
                    default:
                        statusClass = 'status-pending';
                        statusText = order.status || '待处理';
                }

                const row = document.createElement('tr');
                row.dataset.orderId = order.id;
                
                // 如果是选中状态，添加选中类
                if (selectedOrders.has(order.id)) {
                    row.classList.add('selected');
                }
                
                row.innerHTML = `
                    <td class="select-checkbox">
                        <input type="checkbox" class="order-checkbox" 
                               data-order-id="${order.id}"
                               ${selectedOrders.has(order.id) ? 'checked' : ''}>
                    </td>
                    <td>${order.orderId || order.id}</td>
                    <td>${order.customerName || '未提供'}</td>
                    <td>${order.plan}</td>
                    <td>${order.songCount || 0}</td>
                    <td>RM ${order.totalAmount || 0}</td>
                    <td>${order.shippingRegion === 'east' ? '东马' : '西马'}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            <span>${statusIcon}</span>
                            <span>${statusText}</span>
                        </span>
                    </td>
                    <td>${order.createdAt}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" data-order-id="${order.id}">
                                <span>👁️</span>
                                <span>查看</span>
                            </button>
                            ${isAdmin ? `
                                <button class="action-btn edit-btn" data-order-id="${order.id}">
                                    <span>✏️</span>
                                    <span>编辑</span>
                                </button>
                                <button class="action-btn delete-btn" data-order-id="${order.id}">
                                    <span>🗑️</span>
                                    <span>删除</span>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                ordersTableBody.appendChild(row);
            });
            
            // 添加事件监听器
            addOrderTableEventListeners();
        }
        
        function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const customerNameFilter = document.getElementById('filter-customer-name').value.toLowerCase();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            
            ordersPagination.filterItems(order => {
                // 状态筛选
                if (statusFilter !== 'all' && order.status !== statusFilter) {
                    return false;
                }
                
                // 顾客姓名筛选
                if (customerNameFilter && !(order.customerName || '').toLowerCase().includes(customerNameFilter)) {
                    return false;
                }
                
                // 日期范围筛选
                if (startDate || endDate) {
                    const orderDate = order.createdAt ? new Date(order.createdAt) : null;
                    if (!orderDate) return false;
                    
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate + 'T23:59:59') : null;
                    
                    if (start && orderDate < start) return false;
                    if (end && orderDate > end) return false;
                }
                
                return true;
            });
            
            showMessage('筛选条件已应用', 'success');
        }
        
        function clearFilters() {
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-customer-name').value = '';
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            
            ordersPagination.clearFilter();
            showMessage('筛选条件已清除', 'success');
        }
        
        function addOrderTableEventListeners() {
            // 查看订单详情
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    showOrderDetails(orderId);
                });
            });
            
            // 编辑订单（仅管理员）
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    editOrderStatus(orderId);
                });
            });
            
            // 删除订单（仅管理员）
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    deleteOrder(orderId);
                });
            });
            
            // 订单选择复选框
            document.querySelectorAll('.order-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const orderId = this.dataset.orderId;
                    const row = this.closest('tr');
                    
                    if (this.checked) {
                        selectedOrders.add(orderId);
                        row.classList.add('selected');
                    } else {
                        selectedOrders.delete(orderId);
                        row.classList.remove('selected');
                        // 取消全选
                        document.getElementById('select-all-checkbox').checked = false;
                    }
                    
                    updateBatchPanel();
                });
            });
        }
        
        function updateBatchPanel() {
            const batchPanel = document.getElementById('batch-panel');
            const batchSelectedCount = document.getElementById('batch-selected-count');
            const batchBtn = document.getElementById('batch-operations-btn');
            
            if (selectedOrders.size > 0) {
                batchSelectedCount.textContent = selectedOrders.size;
                batchPanel.classList.add('show');
                batchBtn.classList.add('pulse');
            } else {
                batchPanel.classList.remove('show');
                batchBtn.classList.remove('pulse');
            }
        }
        
        function clearSelectedOrders() {
            selectedOrders.clear();
            document.querySelectorAll('.order-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });
            document.getElementById('select-all-checkbox').checked = false;
            updateBatchPanel();
        }

        // ==================== 查看订单详情 ====================
        async function showOrderDetails(orderId) {
            try {
                const orderDoc = await firestore.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    showMessage('订单不存在', 'error');
                    return;
                }

                const orderData = orderDoc.data();
                const modalContent = document.getElementById('order-details-content');
                
                // 格式化状态
                let statusText = '';
                let statusClass = '';
                switch(orderData.status) {
                    case 'pending': 
                        statusText = '待付款'; 
                        statusClass = 'status-pending';
                        break;
                    case 'paid': 
                        statusText = '已付款'; 
                        statusClass = 'status-paid';
                        break;
                    case 'shipped': 
                        statusText = '已发货'; 
                        statusClass = 'status-shipped';
                        break;
                    case 'completed': 
                        statusText = '已完成'; 
                        statusClass = 'status-completed';
                        break;
                    case 'cancelled': 
                        statusText = '已取消'; 
                        statusClass = 'status-cancelled';
                        break;
                    case 'deleted': 
                        statusText = '已删除'; 
                        statusClass = 'status-deleted';
                        break;
                    default: 
                        statusText = orderData.status || '待处理';
                }

                modalContent.innerHTML = `
                    <div class="order-details-grid">
                        <div class="detail-card">
                            <h4>📋 订单信息</h4>
                            <div class="detail-item">
                                <span class="detail-label">订单号:</span>
                                <span class="detail-value">${orderData.orderId || orderId}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">订单状态:</span>
                                <span class="detail-value">
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">套餐类型:</span>
                                <span class="detail-value">${orderData.plan}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">歌曲数量:</span>
                                <span class="detail-value">${orderData.songCount || 0} 首</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">总金额:</span>
                                <span class="detail-value">RM ${orderData.totalAmount || 0}</span>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <h4>👤 顾客信息</h4>
                            <div class="detail-item">
                                <span class="detail-label">姓名:</span>
                                <span class="detail-value">${orderData.customerName || '未提供'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">电话:</span>
                                <span class="detail-value">${orderData.customerPhone || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">邮箱:</span>
                                <span class="detail-value">${orderData.customerEmail || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">配送地区:</span>
                                <span class="detail-value">
                                    ${orderData.shippingRegion === 'east' ? '东马' : '西马'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <h4>🏠 配送地址</h4>
                            <div class="detail-item">
                                <span class="detail-label">街道:</span>
                                <span class="detail-value">${orderData.addressStreet || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">城市:</span>
                                <span class="detail-value">${orderData.addressCity || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">州属:</span>
                                <span class="detail-value">${orderData.addressState || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">邮编:</span>
                                <span class="detail-value">${orderData.addressZip || ''}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <h4>🎵 歌曲列表 (${orderData.songCount || 0}首)</h4>
                        <div class="songs-list-container">
                            ${orderData.songs ? orderData.songs.map((song, index) => `
                                <div class="song-detail-item">
                                    <div class="song-detail-title">${index + 1}. ${song.title}</div>
                                    <div class="song-detail-artist">歌手: ${song.artist}</div>
                                    ${song.album ? `<div class="song-detail-album">专辑: ${song.album}</div>` : ''}
                                </div>
                            `).join('') : '<div style="text-align: center; padding: 30px;">无歌曲信息</div>'}
                        </div>
                    </div>
                    
                    ${orderData.customerNote ? `
                        <div class="detail-card">
                            <h4>📝 顾客备注</h4>
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                ${orderData.customerNote}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="detail-card">
                        <h4>📅 订单时间</h4>
                        <div class="detail-item">
                            <span class="detail-label">创建时间:</span>
                            <span class="detail-value">
                                ${orderData.createdAt ? orderData.createdAt.toDate().toLocaleString('zh-CN') : '未知'}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">更新时间:</span>
                            <span class="detail-value">
                                ${orderData.updatedAt ? orderData.updatedAt.toDate().toLocaleString('zh-CN') : '未知'}
                            </span>
                        </div>
                    </div>
                    
                    ${isAdmin ? `
                        <div class="status-update-form">
                            <h4>🔄 更新订单状态</h4>
                            <div class="status-update-row">
                                <select class="status-select" id="update-status-select">
                                    <option value="pending" ${orderData.status === 'pending' ? 'selected' : ''}>待付款</option>
                                    <option value="paid" ${orderData.status === 'paid' ? 'selected' : ''}>已付款</option>
                                    <option value="shipped" ${orderData.status === 'shipped' ? 'selected' : ''}>已发货</option>
                                    <option value="completed" ${orderData.status === 'completed' ? 'selected' : ''}>已完成</option>
                                    <option value="cancelled" ${orderData.status === 'cancelled' ? 'selected' : ''}>已取消</option>
                                    <option value="deleted" ${orderData.status === 'deleted' ? 'selected' : ''}>已删除</option>
                                </select>
                                <button class="status-update-btn" id="update-status-btn" data-order-id="${orderId}">
                                    更新状态
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="order-actions">
                        <button class="action-btn view-btn" onclick="document.getElementById('order-details-modal').style.display='none'" style="flex: 1;">
                            <span>关闭</span>
                        </button>
                    </div>
                `;

                // 添加更新状态事件监听
                if (isAdmin) {
                    document.getElementById('update-status-btn').addEventListener('click', function() {
                        const newStatus = document.getElementById('update-status-select').value;
                        updateOrderStatus(orderId, newStatus);
                    });
                }

                document.getElementById('order-details-modal').style.display = 'flex';

            } catch (error) {
                console.error('❌ 加载订单详情失败:', error);
                showMessage(`加载订单详情失败: ${error.message}`, 'error');
            }
        }
        
        // ==================== 更新订单状态 ====================
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await firestore.collection('orders').doc(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage('订单状态更新成功', 'success');
                
                // 关闭模态框
                document.getElementById('order-details-modal').style.display = 'none';
                
                // 重新加载订单列表
                loadOrders();
                loadMyOrders();
                
            } catch (error) {
                console.error('❌ 更新订单状态失败:', error);
                showMessage(`更新订单状态失败: ${error.message}`, 'error');
            }
        }
        
        async function editOrderStatus(orderId) {
            try {
                const orderDoc = await firestore.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    showMessage('订单不存在', 'error');
                    return;
                }

                const orderData = orderDoc.data();
                const modalContent = document.getElementById('order-details-content');
                
                modalContent.innerHTML = `
                    <div class="detail-card">
                        <h4>🔄 更新订单状态</h4>
                        <div class="detail-item">
                            <span class="detail-label">订单号:</span>
                            <span class="detail-value">${orderData.orderId || orderId}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">顾客姓名:</span>
                            <span class="detail-value">${orderData.customerName || '未提供'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">当前状态:</span>
                            <span class="detail-value">
                                <span class="status-badge status-${orderData.status}">
                                    ${getStatusText(orderData.status)}
                                </span>
                            </span>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label class="form-label">新状态</label>
                            <select class="form-select" id="edit-status-select">
                                <option value="pending" ${orderData.status === 'pending' ? 'selected' : ''}>待付款</option>
                                <option value="paid" ${orderData.status === 'paid' ? 'selected' : ''}>已付款</option>
                                <option value="shipped" ${orderData.status === 'shipped' ? 'selected' : ''}>已发货</option>
                                <option value="completed" ${orderData.status === 'completed' ? 'selected' : ''}>已完成</option>
                                <option value="cancelled" ${orderData.status === 'cancelled' ? 'selected' : ''}>已取消</option>
                                <option value="deleted" ${orderData.status === 'deleted' ? 'selected' : ''}>已删除</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <button class="form-submit-btn" id="save-status-btn" data-order-id="${orderId}">
                                保存更改
                            </button>
                            <button class="nav-btn" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1);" onclick="document.getElementById('order-details-modal').style.display='none'">
                                取消
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('save-status-btn').addEventListener('click', function() {
                    const newStatus = document.getElementById('edit-status-select').value;
                    updateOrderStatus(orderId, newStatus);
                });
                
                document.getElementById('order-details-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('❌ 编辑订单失败:', error);
                showMessage(`编辑订单失败: ${error.message}`, 'error');
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'pending': return '待付款';
                case 'paid': return '已付款';
                case 'shipped': return '已发货';
                case 'completed': return '已完成';
                case 'cancelled': return '已取消';
                case 'deleted': return '已删除';
                default: return status;
            }
        }
        
        // ==================== 删除订单 ====================
        async function deleteOrder(orderId) {
            if (!confirm('确定要删除这个订单吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                // 将状态更新为已删除而不是实际删除数据
                await firestore.collection('orders').doc(orderId).update({
                    status: 'deleted',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage('订单已标记为已删除', 'success');
                
                // 重新加载订单列表
                loadOrders();
                loadMyOrders();
                
            } catch (error) {
                console.error('❌ 删除订单失败:', error);
                showMessage(`删除订单失败: ${error.message}`, 'error');
            }
        }
        
        // ==================== 批量操作功能 ====================
        function showBatchOperationsModal() {
            if (selectedOrders.size === 0) {
                showMessage('请先选择要操作的订单', 'warning');
                return;
            }
            
            const modalContent = document.getElementById('batch-operations-content');
            const selectedCount = selectedOrders.size;
            
            modalContent.innerHTML = `
                <div class="detail-card">
                    <h4>⚙️ 批量操作</h4>
                    <div class="detail-item">
                        <span class="detail-label">已选择:</span>
                        <span class="detail-value">${selectedCount} 个订单</span>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label class="form-label">选择操作类型</label>
                        <select class="form-select" id="batch-action-type">
                            <option value="">请选择操作类型</option>
                            <option value="export">导出选中订单</option>
                            <option value="status">批量更新状态</option>
                            <option value="delete">批量删除订单</option>
                        </select>
                    </div>
                    
                    <div id="batch-action-details" style="margin-top: 20px; display: none;">
                        <!-- 操作详情将动态加载 -->
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button class="form-submit-btn" id="execute-batch-action" disabled>
                            执行操作
                        </button>
                        <button class="nav-btn" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1);" onclick="document.getElementById('batch-operations-modal').style.display='none'">
                            取消
                        </button>
                    </div>
                </div>
            `;
            
            // 操作类型选择事件
            document.getElementById('batch-action-type').addEventListener('change', function() {
                const actionType = this.value;
                const actionDetails = document.getElementById('batch-action-details');
                const executeBtn = document.getElementById('execute-batch-action');
                
                if (!actionType) {
                    actionDetails.style.display = 'none';
                    executeBtn.disabled = true;
                    return;
                }
                
                executeBtn.disabled = false;
                
                switch(actionType) {
                    case 'export':
                        actionDetails.innerHTML = `
                            <div class="form-info">
                                <h4>📊 导出设置</h4>
                                <div style="margin-top: 10px;">
                                    <label class="form-radio-label" style="margin-bottom: 10px;">
                                        <input type="radio" name="export-format" value="excel" checked>
                                        <span>Excel格式 (.xlsx)</span>
                                    </label>
                                    <label class="form-radio-label">
                                        <input type="radio" name="export-format" value="csv">
                                        <span>CSV格式 (.csv)</span>
                                    </label>
                                </div>
                                <div style="margin-top: 15px;">
                                    <label class="form-label">导出文件名</label>
                                    <input type="text" class="form-input" id="export-filename" 
                                           value="批量导出订单_${new Date().toISOString().slice(0, 10)}">
                                </div>
                            </div>
                        `;
                        executeBtn.textContent = '导出订单';
                        break;
                        
                    case 'status':
                        actionDetails.innerHTML = `
                            <div class="form-info">
                                <h4>🔄 批量更新状态</h4>
                                <div style="margin-top: 10px;">
                                    <label class="form-label">新状态</label>
                                    <select class="form-select" id="batch-new-status">
                                        <option value="pending">待付款</option>
                                        <option value="paid">已付款</option>
                                        <option value="shipped">已发货</option>
                                        <option value="completed">已完成</option>
                                        <option value="cancelled">已取消</option>
                                        <option value="deleted">已删除</option>
                                    </select>
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    将把 ${selectedCount} 个订单的状态更新为所选状态
                                </div>
                            </div>
                        `;
                        executeBtn.textContent = '更新状态';
                        break;
                        
                    case 'delete':
                        actionDetails.innerHTML = `
                            <div class="form-info" style="border-left-color: #e74c3c;">
                                <h4 style="color: #e74c3c;">⚠️ 批量删除订单</h4>
                                <div style="margin-top: 15px; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">
                                    <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">
                                        警告: 此操作不可恢复！
                                    </div>
                                    <div>
                                        将把 ${selectedCount} 个订单标记为"已删除"状态。
                                        订单数据不会被永久删除，但将从正常视图中隐藏。
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <label class="form-radio-label">
                                        <input type="checkbox" id="confirm-delete">
                                        <span>我确认要删除这些订单</span>
                                    </label>
                                </div>
                            </div>
                        `;
                        executeBtn.textContent = '确认删除';
                        executeBtn.disabled = true;
                        
                        // 确认删除复选框事件
                        document.getElementById('confirm-delete').addEventListener('change', function() {
                            executeBtn.disabled = !this.checked;
                        });
                        break;
                }
                
                actionDetails.style.display = 'block';
            });
            
            // 执行批量操作
            document.getElementById('execute-batch-action').addEventListener('click', function() {
                const actionType = document.getElementById('batch-action-type').value;
                
                switch(actionType) {
                    case 'export':
                        batchExportOrders();
                        break;
                    case 'status':
                        batchUpdateStatus();
                        break;
                    case 'delete':
                        batchDeleteOrders();
                        break;
                }
                
                document.getElementById('batch-operations-modal').style.display = 'none';
            });
            
            document.getElementById('batch-operations-modal').style.display = 'flex';
        }
        
        async function batchExportOrders() {
            if (selectedOrders.size === 0) {
                showMessage('请先选择要导出的订单', 'warning');
                return;
            }
            
            try {
                // 获取选中的订单数据
                const selectedOrderData = orders.filter(order => selectedOrders.has(order.id));
                
                // 准备数据
                const worksheetData = selectedOrderData.map(order => ({
                    '订单号': order.orderId || order.id,
                    '顾客姓名': order.customerName || '未提供',
                    '顾客电话': order.customerPhone || '',
                    '顾客邮箱': order.customerEmail || '',
                    '街道地址': order.addressStreet || '',
                    '城市': order.addressCity || '',
                    '州属': order.addressState || '',
                    '邮编': order.addressZip || '',
                    '配送地区': order.shippingRegion === 'east' ? '东马' : '西马',
                    '套餐类型': order.plan,
                    '歌曲数量': order.songCount || 0,
                    '套餐价格': `RM ${order.basePrice || 0}`,
                    '配送费用': `RM ${order.shippingCost || 0}`,
                    '总金额': `RM ${order.totalAmount || 0}`,
                    '订单状态': getStatusText(order.status),
                    '创建时间': order.createdAt,
                    '更新时间': order.updatedAt || '',
                    '备注': order.customerNote || ''
                }));
                
                // 创建工作表
                const worksheet = XLSX.utils.json_to_sheet(worksheetData);
                
                // 设置列宽
                const colWidths = [
                    { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 25 },
                    { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 8 },
                    { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 12 },
                    { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 20 },
                    { wch: 20 }, { wch: 30 }
                ];
                worksheet['!cols'] = colWidths;
                
                // 创建工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "批量订单数据");
                
                // 生成文件名
                const now = new Date();
                const fileName = document.getElementById('export-filename')?.value || 
                                `批量导出订单_${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日.xlsx`;
                
                // 导出文件
                XLSX.writeFile(workbook, fileName);
                
                showMessage(`成功导出 ${selectedOrderData.length} 个订单`, 'success');
                
                // 清除选择
                clearSelectedOrders();
                
            } catch (error) {
                console.error('❌ 批量导出失败:', error);
                showMessage(`批量导出失败: ${error.message}`, 'error');
            }
        }
        
        async function batchUpdateStatus() {
            if (selectedOrders.size === 0) {
                showMessage('请先选择要更新的订单', 'warning');
                return;
            }
            
            const newStatus = document.getElementById('batch-new-status')?.value || 'pending';
            
            if (!confirm(`确定要将 ${selectedOrders.size} 个订单的状态更新为"${getStatusText(newStatus)}"吗？`)) {
                return;
            }
            
            try {
                const batch = firestore.batch();
                const orderIds = Array.from(selectedOrders);
                
                orderIds.forEach(orderId => {
                    const orderRef = firestore.collection('orders').doc(orderId);
                    batch.update(orderRef, {
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                
                showMessage(`成功更新 ${orderIds.length} 个订单的状态`, 'success');
                
                // 重新加载订单列表
                loadOrders();
                
                // 清除选择
                clearSelectedOrders();
                
            } catch (error) {
                console.error('❌ 批量更新状态失败:', error);
                showMessage(`批量更新状态失败: ${error.message}`, 'error');
            }
        }
        
        async function batchDeleteOrders() {
            if (selectedOrders.size === 0) {
                showMessage('请先选择要删除的订单', 'warning');
                return;
            }
            
            if (!confirm(`确定要将 ${selectedOrders.size} 个订单标记为"已删除"吗？此操作不可恢复。`)) {
                return;
            }
            
            try {
                const batch = firestore.batch();
                const orderIds = Array.from(selectedOrders);
                
                orderIds.forEach(orderId => {
                    const orderRef = firestore.collection('orders').doc(orderId);
                    batch.update(orderRef, {
                        status: 'deleted',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                
                showMessage(`成功标记 ${orderIds.length} 个订单为已删除`, 'success');
                
                // 重新加载订单列表
                loadOrders();
                
                // 清除选择
                clearSelectedOrders();
                
            } catch (error) {
                console.error('❌ 批量删除失败:', error);
                showMessage(`批量删除失败: ${error.message}`, 'error');
            }
        }

        // ==================== 统计功能 ====================
        function updateStatistics() {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.totalAmount) || 0), 0);
            const avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;
            const totalSongs = orders.reduce((sum, order) => sum + (parseInt(order.songCount) || 0), 0);
            
            document.getElementById('stat-total-orders').textContent = totalOrders;
            document.getElementById('stat-total-revenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
            document.getElementById('stat-avg-order').textContent = `RM ${avgOrderValue}`;
            document.getElementById('stat-total-songs').textContent = totalSongs;
        }

        // ==================== Excel导出功能 ====================
        function exportOrdersToExcel() {
            if (orders.length === 0) {
                showMessage('暂无订单数据可导出', 'warning');
                return;
            }

            try {
                // 准备数据
                const worksheetData = orders.map(order => ({
                    '订单号': order.orderId || order.id,
                    '顾客姓名': order.customerName || '未提供',
                    '顾客电话': order.customerPhone || '',
                    '顾客邮箱': order.customerEmail || '',
                    '街道地址': order.addressStreet || '',
                    '城市': order.addressCity || '',
                    '州属': order.addressState || '',
                    '邮编': order.addressZip || '',
                    '配送地区': order.shippingRegion === 'east' ? '东马' : '西马',
                    '套餐类型': order.plan,
                    '歌曲数量': order.songCount || 0,
                    '套餐价格': `RM ${order.basePrice || 0}`,
                    '配送费用': `RM ${order.shippingCost || 0}`,
                    '总金额': `RM ${order.totalAmount || 0}`,
                    '订单状态': getStatusText(order.status),
                    '创建时间': order.createdAt,
                    '更新时间': order.updatedAt || '',
                    '备注': order.customerNote || ''
                }));

                // 创建工作表
                const worksheet = XLSX.utils.json_to_sheet(worksheetData);
                
                // 设置列宽
                const colWidths = [
                    { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 25 },
                    { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 8 },
                    { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 12 },
                    { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 20 },
                    { wch: 20 }, { wch: 30 }
                ];
                worksheet['!cols'] = colWidths;
                
                // 创建工作簿
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "订单数据");
                
                // 添加统计工作表
                const stats = calculateOrderStatistics(orders);
                const statsWorksheet = XLSX.utils.json_to_sheet([
                    { '统计项目': '订单总数', '数值': stats.totalOrders },
                    { '统计项目': '总收入', '数值': `RM ${stats.totalRevenue.toFixed(2)}` },
                    { '统计项目': '平均订单金额', '数值': `RM ${stats.averageOrderValue}` },
                    { '统计项目': '总歌曲数量', '数值': stats.totalSongs },
                    { '': '' },
                    { '统计项目': '东马订单数', '数值': stats.ordersByRegion.east },
                    { '统计项目': '西马订单数', '数值': stats.ordersByRegion.west },
                    { '统计项目': '东马订单占比', '数值': `${stats.regionPercentage.east}%` },
                    { '统计项目': '西马订单占比', '数值': `${stats.regionPercentage.west}%` }
                ]);
                XLSX.utils.book_append_sheet(workbook, statsWorksheet, "统计信息");
                
                // 生成文件名
                const now = new Date();
                const fileName = `订单数据_${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日.xlsx`;
                
                // 导出文件
                XLSX.writeFile(workbook, fileName);
                
                showMessage(`订单数据已导出为: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('❌ 导出Excel失败:', error);
                showMessage(`导出Excel失败: ${error.message}`, 'error');
            }
        }
        
        function calculateOrderStatistics(orders) {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + (parseFloat(order.totalAmount) || 0), 0);
            const averageOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;
            const totalSongs = orders.reduce((sum, order) => sum + (parseInt(order.songCount) || 0), 0);
            
            // 按地区统计
            const ordersByRegion = {
                east: orders.filter(order => order.shippingRegion === 'east').length,
                west: orders.filter(order => order.shippingRegion === 'west').length
            };
            
            const regionPercentage = {
                east: totalOrders > 0 ? Math.round((ordersByRegion.east / totalOrders) * 100) : 0,
                west: totalOrders > 0 ? Math.round((ordersByRegion.west / totalOrders) * 100) : 0
            };
            
            return {
                totalOrders,
                totalRevenue,
                averageOrderValue,
                totalSongs,
                ordersByRegion,
                regionPercentage
            };
        }

        // ==================== 优化的搜索功能 ====================
        function getSearchConfig(category) {
            const configs = {
                'chinese-pop': {
                    terms: ['popular chinese songs', 'mandarin pop', '华语热门歌曲', '中文流行音乐'],
                    country: 'CN',
                    description: '热门华语歌曲榜',
                    artists: []
                },
                'western-pop': {
                    terms: ['pop music', 'top songs', 'hits', 'billboard'],
                    country: 'US',
                    description: '欧美流行热歌',
                    artists: []
                },
                'chinese-dj': {
                    terms: ['中文DJ', '电子舞曲', 'remix', '电音'],
                    country: 'CN',
                    description: '热门电子舞曲',
                    artists: []
                },
                'chinese-artists': {
                    type: 'artists',
                    artists: [
                        '周杰伦', '林俊杰', '邓紫棋', '薛之谦', '李荣浩', '王力宏', '陈奕迅', '张惠妹', 
                        '蔡依林', '孙燕姿', '五月天', 'S.H.E', 'Beyond', '张国荣', '张学友', '刘德华', 
                        '郭富城', '黎明', '王菲', '那英', '杨丞琳', '张韶涵', '王心凌', '蔡健雅', '田馥甄', 
                        '林忆莲', '许嵩', '汪苏泷', '徐佳莹', '吴青峰', '苏打绿', '八三夭', '告五人', 
                        '蔡徐坤', 'TFBOYS', '华晨宇', '毛不易', '周深', '张杰', '李宇春', '张靓颖', 
                        '郁可唯', '黄龄', '胡彦斌', '许巍', '朴树', '李健', '陈粒', '花粥', '房东的猫'
                    ]
                },
                'western-artists': {
                    type: 'artists',
                    artists: [
                        'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish', 
                        'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars', 'Maroon 5', 
                        'Coldplay', 'Imagine Dragons', 'Lady Gaga', 'Rihanna', 'Beyoncé', 'Katy Perry', 
                        'Shawn Mendes', 'Harry Styles', 'Lewis Capaldi', 'Sam Smith', 'Adele', 
                        'Michael Jackson', 'Madonna', 'Elton John', 'Queen', 'The Beatles', 
                        'Linkin Park', 'Green Day', 'Eminem', 'Kanye West', 'Jay-Z', 'Snoop Dogg', 
                        '50 Cent', 'Rihanna', 'Beyoncé', 'Katy Perry', 'Lady Gaga', 'Britney Spears', 
                        'Christina Aguilera', 'Pink', 'Avril Lavigne', 'Shakira', 'Jennifer Lopez', 
                        'Nicki Minaj', 'Cardi B', 'Megan Thee Stallion', 'Doja Cat', 'Lizzo', 'Halsey'
                    ]
                }
            };
            
            return configs[category] || configs['chinese-pop'];
        }
        
        async function getITunesCharts(category) {
            try {
                const config = getSearchConfig(category);
                
                if (config.type === 'artists') {
                    return [];
                }
                
                const searchTerm = config.terms[0] || 'music';
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(searchTerm)}&entity=musicTrack&limit=50&country=${config.country}&lang=zh_cn`;
                
                console.log('📊 获取iTunes排行榜:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.resultCount === 0) {
                    return [];
                }
                
                return data.results.map(track => ({
                    id: track.trackId,
                    title: track.trackName,
                    artist: track.artistName,
                    album: track.collectionName,
                    duration: track.trackTimeMillis,
                    previewUrl: track.previewUrl,
                    artwork: track.artworkUrl100,
                    popularity: track.trackNumber || 0
                })).filter(track => 
                    track.previewUrl && 
                    track.title && 
                    track.artist
                );
                
            } catch (error) {
                console.error('获取iTunes排行榜失败:', error);
                return [];
            }
        }
        
        function removeDuplicates(songs) {
            const seen = new Set();
            return songs.filter(song => {
                const key = `${song.title}-${song.artist}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }
        
        async function loadChartOptimized(category) {
            const songsContainer = document.getElementById('songs-container');
            songsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>正在加载热门歌曲...</div></div>';
            
            // 隐藏加载更多按钮
            document.getElementById('load-more-btn').style.display = 'none';
            
            try {
                const config = getSearchConfig(category);
                
                if (config.type === 'artists') {
                    renderArtistsList(config.artists);
                    // 如果是移动端，也更新移动端显示
                    renderMobileArtistsList(config.artists);
                    return;
                }
                
                // 策略1: iTunes官方排行榜
                let songs = await getITunesCharts(category);
                
                if (songs.length < 15) {
                    console.log('📊 iTunes排行榜数据不足，尝试策略2');
                    
                    // 策略2: 多关键词组合搜索
                    const allSongs = [];
                    const searchPromises = config.terms.slice(0, 4).map(term => 
                        searchMusic(term, 15).catch(() => [])
                    );
                    
                    const results = await Promise.allSettled(searchPromises);
                    results.forEach(result => {
                        if (result.status === 'fulfilled' && result.value) {
                            allSongs.push(...result.value);
                        }
                    });
                    
                    songs = removeDuplicates(allSongs)
                        .sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                }
                
                if (songs.length < 15 && config.artists && config.artists.length > 0) {
                    console.log('📊 数据仍不足，尝试策略3: 热门歌手补充');
                    
                    // 策略3: 热门歌手补充
                    const artistSongs = [];
                    for (const artist of config.artists.slice(0, 5)) {
                        try {
                            const artistResults = await searchMusic(artist, 8);
                            artistSongs.push(...artistResults);
                        } catch (error) {
                            continue;
                        }
                    }
                    
                    songs = [...songs, ...removeDuplicates(artistSongs)];
                    songs = removeDuplicates(songs).slice(0, 50);
                }
                
                if (songs.length === 0) {
                    songsContainer.innerHTML = `
                        <div class="error">
                            <div class="error-icon">🎵</div>
                            <div>未找到相关歌曲</div>
                            <div class="empty-playlist-submessage">请尝试其他分类</div>
                        </div>
                    `;
                    // 如果是移动端，也更新移动端显示
                    const mobileContainer = document.getElementById('songs-container-mobile');
                    if (mobileContainer) {
                        mobileContainer.innerHTML = `
                            <div class="error">
                                <div class="error-icon">🎵</div>
                                <div>未找到相关歌曲</div>
                                <div class="empty-playlist-submessage">请尝试其他分类</div>
                            </div>
                        `;
                    }
                    return;
                }
                
                currentSongs = songs;
                renderSongs(currentSongs);
                
                // 如果是移动端，也更新移动端显示
                if (document.getElementById('songs-container-mobile')) {
                    renderMobileSongs(currentSongs);
                }
                
                showMessage(`成功加载 ${songs.length} 首歌曲`, 'success');
                
            } catch (error) {
                console.error('加载排行榜失败:', error);
                songsContainer.innerHTML = `
                    <div class="error">
                        <div class="error-icon">❌</div>
                        <div>加载失败</div>
                        <div class="empty-playlist-submessage">请检查网络连接</div>
                    </div>
                `;
                // 如果是移动端，也更新移动端显示
                const mobileContainer = document.getElementById('songs-container-mobile');
                if (mobileContainer) {
                    mobileContainer.innerHTML = `
                        <div class="error">
                            <div class="error-icon">❌</div>
                            <div>加载失败</div>
                            <div class="empty-playlist-submessage">请检查网络连接</div>
                        </div>
                    `;
                }
            }
        }

        async function searchMusic(term, limit = 50, offset = 0) {
            try {
                const encodedTerm = encodeURIComponent(term);
                const url = `https://itunes.apple.com/search?term=${encodedTerm}&entity=musicTrack&limit=${limit}&offset=${offset}&country=CN&lang=zh_cn`;
                
                console.log('🔍 搜索请求:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📊 搜索结果:', data.resultCount, '条');
                
                if (data.resultCount === 0) {
                    return [];
                }
                
                return data.results.map(track => ({
                    id: track.trackId,
                    title: track.trackName,
                    artist: track.artistName,
                    album: track.collectionName,
                    duration: track.trackTimeMillis,
                    previewUrl: track.previewUrl,
                    artwork: track.artworkUrl100,
                    popularity: track.trackNumber || 0
                })).filter(track => 
                    track.previewUrl && 
                    track.title && 
                    track.artist
                );
                
            } catch (error) {
                console.error('搜索失败:', error);
                throw error;
            }
        }
        
        async function loadMoreSongs() {
            const loadMoreBtn = document.getElementById('load-more-btn');
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px;"></div><span>加载中...</span>';
            
            try {
                currentSearchOffset += 50;
                const moreSongs = await searchMusic(currentSearchTerm || getSearchConfig(currentChartCategory).terms[0], 50, currentSearchOffset);
                
                if (moreSongs.length > 0) {
                    currentSongs = [...currentSongs, ...moreSongs];
                    renderSongs(currentSongs);
                    
                    // 如果还有更多结果，继续显示加载按钮
                    if (moreSongs.length >= 50) {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.innerHTML = '<span>⬇️</span><span>加载更多歌曲</span>';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                } else {
                    loadMoreBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('加载更多歌曲失败:', error);
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<span>⬇️</span><span>加载更多歌曲</span>';
                showMessage('加载失败，请重试', 'error');
            }
        }

        function renderArtistsList(artists) {
            const songsContainer = document.getElementById('songs-container');
            songsContainer.innerHTML = '';
            
            // 隐藏加载更多按钮
            document.getElementById('load-more-btn').style.display = 'none';
            
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">歌手</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">
                            <span>🔍</span>
                            <span>搜索歌曲</span>
                        </button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
            
            document.querySelectorAll('.add-btn[data-artist]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const artist = this.dataset.artist;
                    document.getElementById('search-input').value = artist;
                    performSearch();
                });
            });
        }
        
        function renderMobileArtistsList(artists) {
            const songsContainer = document.getElementById('songs-container-mobile');
            if (!songsContainer) return;
            
            songsContainer.innerHTML = '';
            
            document.getElementById('load-more-btn-mobile').style.display = 'none';
            
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">歌手</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">
                            <span>🔍</span>
                            <span>搜索歌曲</span>
                        </button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
            
            document.querySelectorAll('#songs-container-mobile .add-btn[data-artist]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const artist = this.dataset.artist;
                    document.getElementById('search-input-mobile').value = artist;
                    performSearchMobile();
                });
            });
        }

        function renderSongs(songs) {
            const songsContainer = document.getElementById('songs-container');
            
            // 如果是第一次加载，清空容器
            if (currentSearchOffset === 0) {
                songsContainer.innerHTML = '';
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `
                            <button class="preview-btn" data-url="${song.previewUrl}" data-id="${song.id}">
                                <span>▶️</span>
                                <span>试听</span>
                            </button>
                        ` : ''}
                        <button class="add-btn" data-id="${song.id}">
                            <span>➕</span>
                            <span>添加</span>
                        </button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
            
            // 添加歌曲点击事件
            document.querySelectorAll('.add-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const songId = this.dataset.id;
                    addSongToPlaylist(songId);
                });
            });
            
            // 添加试听按钮事件
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const previewUrl = this.dataset.url;
                    const songId = this.dataset.id;
                    previewSong(previewUrl, songId);
                });
            });
        }
        
        function previewSong(previewUrl, songId) {
            // 如果正在播放同一首歌，停止播放
            if (currentlyPlayingId === songId && currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentlyPlayingId = null;
                
                // 更新按钮状态
                document.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<span>▶️</span><span>试听</span>';
                });
                return;
            }
            
            // 如果正在播放其他歌曲，停止播放
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                currentlyPlayingId = null;
                
                // 更新所有按钮状态
                document.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<span>▶️</span><span>试听</span>';
                });
            }
            
            // 播放新歌曲
            currentAudio = new Audio(previewUrl);
            currentlyPlayingId = songId;
            
            // 更新当前按钮状态
            const currentBtn = document.querySelector(`.preview-btn[data-id="${songId}"]`);
            if (currentBtn) {
                currentBtn.classList.add('playing');
                currentBtn.innerHTML = '<span>⏸️</span><span>停止</span>';
            }
            
            currentAudio.play().catch(error => {
                console.error('播放失败:', error);
                showMessage('播放失败，请重试', 'error');
                
                // 重置按钮状态
                if (currentBtn) {
                    currentBtn.classList.remove('playing');
                    currentBtn.innerHTML = '<span>▶️</span><span>试听</span>';
                }
                currentlyPlayingId = null;
            });
            
            // 监听播放结束
            currentAudio.addEventListener('ended', function() {
                currentlyPlayingId = null;
                if (currentBtn) {
                    currentBtn.classList.remove('playing');
                    currentBtn.innerHTML = '<span>▶️</span><span>试听</span>';
                }
            });
            
            showMessage('开始试听...', 'info');
        }

        // ==================== 歌单功能 ====================
        function addSongToPlaylist(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song && !playlist.some(s => s.id == songId)) {
                playlist.push(song);
                renderPlaylist();
                updatePlaylistCount();
                updateMobilePlaylistDisplay();
                
                showMessage(`已添加 "${song.title}" 到歌单`, 'success');
            } else if (playlist.some(s => s.id == songId)) {
                showMessage(`"${song.title}" 已在歌单中`, 'info');
            }
        }

        function renderPlaylist() {
            const playlistContainer = document.getElementById('playlist-items');
            const priceRecommendation = document.getElementById('price-recommendation');
            const submitBtn = document.getElementById('submit-playlist-btn');
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = `
                    <div class="empty-playlist">
                        <div class="empty-playlist-icon">🎵</div>
                        <div class="empty-playlist-message">歌单为空</div>
                        <div class="empty-playlist-submessage">
                            请从左侧添加歌曲到歌单
                        </div>
                    </div>
                `;
                priceRecommendation.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }
            
            playlistContainer.innerHTML = '';
            priceRecommendation.style.display = 'block';
            submitBtn.disabled = false;
            
            playlist.forEach((song, index) => {
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.innerHTML = `
                    <div class="playlist-item-content">
                        <div class="song-number">${index + 1}</div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${index}">×</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    removeSongFromPlaylist(index);
                });
            });
            
            // 更新价格推荐
            updatePriceRecommendation();
        }

        function removeSongFromPlaylist(index) {
            if (index >= 0 && index < playlist.length) {
                const songTitle = playlist[index].title;
                playlist.splice(index, 1);
                renderPlaylist();
                updatePlaylistCount();
                updateMobilePlaylistDisplay();
                showMessage(`已从歌单移除 "${songTitle}"`, 'success');
            }
        }

        function updatePlaylistCount() {
            const playlistCount = document.getElementById('playlist-count');
            playlistCount.textContent = playlist.length;
            
            // 更新提交按钮状态
            const submitBtn = document.getElementById('submit-playlist-btn');
            submitBtn.disabled = playlist.length === 0;
            
            // 更新移动端计数
            const playlistCountMobile = document.getElementById('playlist-count-mobile');
            const playlistCountTab = document.getElementById('playlist-count-tab');
            
            if (playlistCountMobile) playlistCountMobile.textContent = playlist.length;
            if (playlistCountTab) playlistCountTab.textContent = playlist.length;
        }

        // ==================== 搜索功能 ====================
        async function performSearch() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim();
            
            if (!query) {
                showMessage('请输入搜索关键词', 'warning');
                return;
            }
            
            const songsContainer = document.getElementById('songs-container');
            songsContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>搜索中...</div></div>';
            
            // 隐藏加载更多按钮
            document.getElementById('load-more-btn').style.display = 'none';
            
            try {
                currentSearchTerm = query;
                currentSearchOffset = 0;
                currentSongs = await searchMusic(query, 50, 0);
                
                if (currentSongs.length === 0) {
                    songsContainer.innerHTML = `
                        <div class="error">
                            <div class="error-icon">🔍</div>
                            <div>未找到相关歌曲</div>
                            <div class="empty-playlist-submessage">请尝试其他关键词</div>
                        </div>
                    `;
                    return;
                }
                
                renderSongs(currentSongs);
                showMessage(`找到 ${currentSongs.length} 首相关歌曲`, 'success');
                
                // 如果有更多结果，显示加载更多按钮
                if (currentSongs.length >= 50) {
                    document.getElementById('load-more-btn').style.display = 'flex';
                }
                
            } catch (error) {
                console.error('搜索失败:', error);
                songsContainer.innerHTML = `
                    <div class="error">
                        <div class="error-icon">❌</div>
                        <div>搜索失败</div>
                        <div class="empty-playlist-submessage">请检查网络连接</div>
                    </div>
                `;
            }
        }

        // ==================== 工具函数 ====================
        function showMessage(message, type = 'info') {
            // 创建消息元素
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.className = 'message-notification';
            
            // 设置样式
            const styles = {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 25px',
                borderRadius: '10px',
                zIndex: '5000',
                transition: 'all 0.3s',
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(255, 255, 255, 0.2)',
                maxWidth: '400px',
                wordBreak: 'break-word',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                opacity: '0',
                transform: 'translateY(-20px)'
            };
            
            // 根据类型设置颜色
            switch(type) {
                case 'success':
                    styles.background = 'linear-gradient(135deg, rgba(46, 204, 113, 0.9), rgba(39, 174, 96, 0.9))';
                    break;
                case 'error':
                    styles.background = 'linear-gradient(135deg, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9))';
                    break;
                case 'warning':
                    styles.background = 'linear-gradient(135deg, rgba(241, 196, 15, 0.9), rgba(243, 156, 18, 0.9))';
                    break;
                default:
                    styles.background = 'linear-gradient(135deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9))';
            }
            
            Object.assign(messageEl.style, styles);
            
            // 添加图标
            let icon = 'ℹ️';
            switch(type) {
                case 'success': icon = '✅'; break;
                case 'error': icon = '❌'; break;
                case 'warning': icon = '⚠️'; break;
            }
            messageEl.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span> <span>${message}</span>`;
            
            document.body.appendChild(messageEl);
            
            // 动画进入
            setTimeout(() => {
                messageEl.style.transform = 'translateY(0)';
                messageEl.style.opacity = '1';
            }, 10);
            
            // 3秒后消失
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (document.body.contains(messageEl)) {
                        document.body.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }
        
        function showLoading(message = '加载中...') {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'loading';
            loadingEl.innerHTML = `
                <div class="loading-spinner"></div>
                <div>${message}</div>
            `;
            return loadingEl;
        }

        // ==================== 页面卸载清理 ====================
        window.addEventListener('beforeunload', function() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        });
    </script>
</body>
</html>
