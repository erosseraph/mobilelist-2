<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.4.0 - ç»ˆæä¿®å¤ç‰ˆ</title>
    
    <link rel="icon" href="/favicon.ico">
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç©ºé—´çœç•¥é‡å¤çš„CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: white; min-height: 100vh; padding-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin-bottom: 20px; }
        .logo { font-size: 1.8rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); }
        .nav-btn:hover, .nav-btn.active { background: rgba(255, 255, 255, 0.2); }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .login-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .login-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .user-info { display: none; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.1); padding: 8px 15px; border-radius: 25px; }
        .user-avatar { width: 32px; height: 32px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .logout-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; }
        .page-container { min-height: 600px; }
        #karaoke-page { display: flex; gap: 20px; }
        .songs-section { flex: 2; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; }
        .playlist-section { flex: 1; background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; max-height: 700px; overflow-y: auto; }
        .mobile-tabs { display: none; }
        .mobile-tab-header { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        .mobile-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .mobile-tab.active { background: rgba(255, 255, 255, 0.2); border-bottom-color: #fdbb2d; }
        .mobile-tab-content { display: none; }
        .mobile-tab-content.active { display: block; }
        .charts-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-category { background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .chart-category:hover, .chart-category.active { background: rgba(255, 255, 255, 0.2); }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 12px 15px; border: none; border-radius: 25px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 1rem; }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .search-btn, .clear-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 12px 20px; border-radius: 25px; cursor: pointer; }
        .songs-container { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
        .song { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; transition: all 0.3s; }
        .song:hover { background: rgba(255, 255, 255, 0.1); }
        .song-info { flex: 1; }
        .song-title { font-weight: bold; margin-bottom: 4px; }
        .song-artist { font-size: 0.9rem; opacity: 0.8; }
        .song-controls { display: flex; gap: 8px; }
        .preview-btn, .add-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; padding: 15px; }
        .load-more-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 12px 25px; border-radius: 25px; cursor: pointer; }
        .load-more-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.9rem; opacity: 0.8; }
        .artist-search-view { display: none; }
        .artist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .back-to-charts { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .artist-name { font-size: 1.5rem; font-weight: bold; }
        .song-count { font-size: 1rem; opacity: 0.8; }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .playlist-count { font-size: 1.1rem; font-weight: bold; }
        .share-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .playlist-items { min-height: 200px; max-height: 500px; overflow-y: auto; }
        .playlist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; }
        .song-number { width: 25px; text-align: center; font-weight: bold; margin-right: 10px; }
        .remove-btn { background: rgba(255, 59, 48, 0.3); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .empty-playlist { text-align: center; padding: 40px 20px; opacity: 0.7; }
        #pricing-page { display: none; }
        .pricing-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .pricing-card { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; text-align: center; }
        .plan-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .price { font-size: 2rem; font-weight: bold; margin-bottom: 15px; }
        .song-range { color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; }
        .select-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 12px 30px; border-radius: 25px; cursor: pointer; width: 100%; }
        .shipping-info { background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; margin: 20px auto; max-width: 800px; }
        .shipping-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .shipping-option { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: linear-gradient(135deg, #1a2a6c, #b21f1f); border-radius: 15px; padding: 30px; width: 100%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 1.5rem; font-weight: bold; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .login-methods { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .login-method-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 15px; border-radius: 10px; cursor: pointer; font-size: 1rem; }
        .loading { text-align: center; padding: 40px 20px; opacity: 0.8; }
        .error { text-align: center; padding: 40px 20px; opacity: 0.8; color: #ff6b6b; }
        .redirect-status { display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 8px; z-index: 3000; font-size: 0.9rem; animation: fadeIn 0.3s ease; max-width: 300px; word-wrap: break-word; }
        .redirect-status.show { display: block; }
        .redirect-success { border-left: 4px solid #34A853; }
        .redirect-error { border-left: 4px solid #EA4335; }
        .redirect-warning { border-left: 4px solid #FBBC05; }
        .redirect-info { border-left: 4px solid #4285F4; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .container { padding: 0 10px; } .navbar { flex-direction: column; gap: 15px; padding: 10px 0; } .logo { font-size: 1.4rem; text-align: center; } .nav-buttons { width: 100%; justify-content: center; flex-wrap: wrap; } .nav-btn { padding: 8px 15px; font-size: 0.9rem; } .user-section { width: 100%; justify-content: center; } .mobile-tabs { display: block; } #karaoke-page { flex-direction: column; } #karaoke-page > .songs-section, #karaoke-page > .playlist-section { display: none; } .mobile-tabs .songs-section, .mobile-tabs .playlist-section { display: block !important; } .mobile-tab-content.active { display: block; } .search-container { flex-direction: column; } .search-input { margin-bottom: 10px; } .songs-container { max-height: 400px; } .song { padding: 10px 12px; } .song-title { font-size: 0.9rem; } .song-artist { font-size: 0.8rem; } .pagination { flex-direction: column; gap: 10px; } .load-more-btn { width: 100%; } .pricing-container { grid-template-columns: 1fr; gap: 15px; } .shipping-options { grid-template-columns: 1fr; } .redirect-status { left: 10px; right: 10px; max-width: none; } }
        @media (max-width: 480px) { .charts-container { gap: 5px; } .chart-category { padding: 8px 12px; font-size: 0.8rem; flex: 1 0 calc(50% - 10px); } .mobile-tab { padding: 12px 8px; font-size: 0.9rem; } .playlist-header { flex-direction: column; gap: 10px; align-items: flex-start; } .playlist-count { font-size: 1rem; } }
        button, .song, .chart-category, .mobile-tab { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .song, .playlist-item, .chart-category { user-select: none; }
        .songs-container, .playlist-items { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>
    <!-- é‡å®šå‘çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="redirect-status" class="redirect-status"></div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç™»å½• / æ³¨å†Œ</h2>
                <button class="close-btn" id="close-login">&times;</button>
            </div>
            <div class="login-methods">
                <button class="login-method-btn" id="email-login-btn">ğŸ“§ é‚®ç®±ç™»å½•/æ³¨å†Œ</button>
                <button class="login-method-btn" id="google-login-btn">ğŸ”µ Google ç™»å½• (ç»ˆæä¿®å¤ç‰ˆ)</button>
            </div>
            <div style="margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.7); text-align: center;">
                <p>Googleç™»å½•ä½¿ç”¨å¢å¼ºçš„é‡å®šå‘æµç¨‹</p>
                <p>ç‰ˆæœ¬: 2.4.0 (ç»ˆæä¿®å¤)</p>
            </div>
        </div>
    </div>

    <div class="container">
        <nav class="navbar">
            <div class="logo">ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå… v2.4.0</div>
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ğŸµ ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ğŸ’° ä»·æ ¼é…å¥—</button>
                <div class="admin-section" id="admin-section" style="display: none;">
                    <a href="admin.html" class="nav-btn">ğŸ‘‘ ç®¡ç†é¢æ¿</a>
                </div>
            </div>
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-email" id="user-email">ç”¨æˆ·</span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
            </div>
        </nav>
        
        <!-- é¡µé¢å†…å®¹ï¼ˆä¸ºäº†èŠ‚çœç©ºé—´çœç•¥é‡å¤çš„HTMLï¼‰ -->
        <!-- æ­Œæ›²æµè§ˆé¡µé¢ -->
        <div class="page-container">
            <div id="karaoke-page">
                <!-- æ¡Œé¢ç«¯å¸ƒå±€ -->
                <div class="songs-section">
                    <div id="charts-view">
                        <div class="charts-container">
                            <div class="chart-category active" data-category="chinese-pop">åè¯­æµè¡Œ</div>
                            <div class="chart-category" data-category="western-pop">æ¬§ç¾æµè¡Œ</div>
                            <div class="chart-category" data-category="chinese-artists">åè¯­æ­Œæ‰‹</div>
                            <div class="chart-category" data-category="western-artists">æ¬§ç¾æ­Œæ‰‹</div>
                        </div>
                        <div class="search-container">
                            <input type="text" class="search-input" id="search-input" placeholder="æœç´¢æ­Œæ›²åç§°ã€æ­Œæ‰‹...">
                            <button class="search-btn" id="search-btn">æœç´¢</button>
                            <button class="clear-btn" id="clear-btn">æ¸…ç©º</button>
                        </div>
                        <div class="songs-container" id="songs-container">
                            <div class="loading">æ­£åœ¨åŠ è½½æ­Œæ›²...</div>
                        </div>
                        <div class="pagination" id="charts-pagination">
                            <button class="load-more-btn" id="load-more-charts">åŠ è½½æ›´å¤š</button>
                            <div class="page-info" id="charts-page-info">ç¬¬ 1 é¡µ</div>
                        </div>
                    </div>
                    <!-- å…¶ä»–HTMLå†…å®¹... -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // ğŸ”¥ ç»ˆæä¿®å¤ç‰ˆæœ¬ - Googleç™»å½•é‡å®šå‘å®Œå…¨è§£å†³æ–¹æ¡ˆ
        // =============================================

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAMn7EOOUDpIGXzA8EhPBtLWw7BwyU2Rdc",
            authDomain: "karaoke-customizer.firebaseapp.com",
            projectId: "karaoke-customizer",
            storageBucket: "karaoke-customizer.firebasestorage.app",
            messagingSenderId: "593643512892",
            appId: "1:593643512892:web:c21ec4ce7c2d286fed4f39",
            measurementId: "G-D791D33Y6R"
        };

        // åº”ç”¨çŠ¶æ€
        let currentUser = null;
        let firebaseApp, auth, firestore;
        let isMobileView = window.innerWidth <= 768;
        let loginInProgress = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åˆå§‹åŒ–æ­Œå…å®šåˆ¶åº”ç”¨ v2.4.0 - ç»ˆæä¿®å¤ç‰ˆ');
            
            // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°ï¼ˆå¯èƒ½åœ¨é¡µé¢åŠ è½½æ—¶å°±æœ‰ï¼‰
            checkUrlForAuthParams();
            
            // ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–Firebase
            initializeFirebase();
            
            // ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®é¡µé¢äº‹ä»¶
            setupEventListeners();
            
            // ç¬¬å››æ­¥ï¼šè®¾ç½®ä¸“é—¨çš„OAuthé‡å®šå‘ç›‘å¬å™¨
            setupOAuthRedirectListener();
            
            // ç¬¬äº”æ­¥ï¼šå»¶è¿Ÿæ£€æŸ¥è®¤è¯çŠ¶æ€
            setTimeout(() => {
                if (auth) {
                    auth.onAuthStateChanged(handleAuthStateChange);
                }
            }, 1000);
        });

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°
         */
        function checkUrlForAuthParams() {
            console.log('ğŸ” æ£€æŸ¥URLä¸­çš„è®¤è¯å‚æ•°...');
            
            // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„OAuthå‚æ•°ä½ç½®
            const searchParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„è®¤è¯å‚æ•°
            const authParams = {
                // ä»searchä¸­è·å–
                code: searchParams.get('code'),
                state: searchParams.get('state'),
                error: searchParams.get('error'),
                error_description: searchParams.get('error_description'),
                
                // ä»hashä¸­è·å–
                hash_code: hashParams.get('code'),
                hash_state: hashParams.get('state'),
                hash_error: hashParams.get('error'),
                hash_error_description: hashParams.get('error_description'),
                
                // è‡ªå®šä¹‰å‚æ•°
                auth_status: searchParams.get('auth_status') || hashParams.get('auth_status')
            };
            
            console.log('ğŸ“‹ å‘ç°çš„è®¤è¯å‚æ•°:', authParams);
            
            // å¦‚æœæœ‰è®¤è¯å‚æ•°ï¼Œè¯´æ˜å¯èƒ½æ˜¯ä»OAuthé‡å®šå‘å›æ¥çš„
            if (authParams.code || authParams.hash_code || authParams.auth_status) {
                console.log('ğŸ¯ æ£€æµ‹åˆ°OAuthé‡å®šå‘è¿”å›');
                showRedirectStatus('æ£€æµ‹åˆ°ç™»å½•è¿”å›ï¼Œæ­£åœ¨å¤„ç†...', 'info');
                
                // æ ‡è®°ç™»å½•æ­£åœ¨è¿›è¡Œä¸­
                loginInProgress = true;
                
                // å¦‚æœå·²ç»æœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯
                if (authParams.error || authParams.hash_error) {
                    const error = authParams.error || authParams.hash_error;
                    const errorDesc = authParams.error_description || authParams.hash_error_description;
                    console.error('âŒ OAuthé”™è¯¯:', error, errorDesc);
                    showRedirectStatus(`ç™»å½•é”™è¯¯: ${error}`, 'error');
                    clearAuthParams();
                }
            }
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¸…é™¤URLä¸­çš„è®¤è¯å‚æ•°
         */
        function clearAuthParams() {
            if (window.history.replaceState) {
                try {
                    // æ¸…é™¤searchå’Œhashä¸­çš„è®¤è¯å‚æ•°
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    console.log('ğŸ§¹ å·²æ¸…é™¤URLä¸­çš„è®¤è¯å‚æ•°');
                } catch (e) {
                    console.error('æ¸…é™¤URLå‚æ•°å¤±è´¥:', e);
                }
            }
        }

        /**
         * åˆå§‹åŒ–Firebase
         */
        function initializeFirebase() {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.apps[0];
                }
                
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                
                console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®æŒä¹…åŒ–
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => {
                        console.log('âœ… è®¤è¯æŒä¹…åŒ–è®¾ç½®æˆåŠŸ');
                    })
                    .catch((error) => {
                        console.error('è®¤è¯æŒä¹…åŒ–è®¾ç½®å¤±è´¥:', error);
                    });
                    
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
                showMessage('Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šè®¾ç½®ä¸“é—¨çš„OAuthé‡å®šå‘ç›‘å¬å™¨
         */
        function setupOAuthRedirectListener() {
            console.log('ğŸ”„ è®¾ç½®OAuthé‡å®šå‘ç›‘å¬å™¨...');
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && loginInProgress) {
                    console.log('ğŸ‘ï¸ é¡µé¢é‡æ–°å¯è§ï¼Œç™»å½•å¯èƒ½å·²å®Œæˆ');
                    setTimeout(handleOAuthRedirectReturn, 1000);
                }
            });
            
            // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (loginInProgress) {
                        console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€');
                        handleOAuthRedirectReturn();
                    }
                }, 1500);
            });
            
            // ç›‘å¬hashå˜åŒ–ï¼ˆæŸäº›OAuthæµç¨‹ä½¿ç”¨hashï¼‰
            window.addEventListener('hashchange', function() {
                if (loginInProgress) {
                    console.log('ğŸ”— Hashå˜åŒ–ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€');
                    setTimeout(handleOAuthRedirectReturn, 500);
                }
            });
            
            console.log('âœ… OAuthé‡å®šå‘ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        /**
         * ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¤„ç†OAuthé‡å®šå‘è¿”å›
         */
        function handleOAuthRedirectReturn() {
            console.log('ğŸ”„ å¤„ç†OAuthé‡å®šå‘è¿”å›...');
            
            if (!auth) {
                console.log('âš ï¸ Authæœªåˆå§‹åŒ–ï¼Œç­‰å¾…...');
                setTimeout(handleOAuthRedirectReturn, 500);
                return;
            }
            
            // æ£€æŸ¥Firebaseé‡å®šå‘ç»“æœ
            auth.getRedirectResult()
                .then((result) => {
                    console.log('ğŸ¯ getRedirectResultè¿”å›:', {
                        hasUser: !!result.user,
                        hasCredential: !!result.credential,
                        operationType: result.operationType,
                        hasAdditionalUserInfo: !!result.additionalUserInfo
                    });
                    
                    if (result.user) {
                        // ğŸ”¥ æˆåŠŸï¼ç”¨æˆ·é€šè¿‡é‡å®šå‘ç™»å½•æˆåŠŸ
                        console.log('ğŸ‰ OAuthé‡å®šå‘ç™»å½•æˆåŠŸ:', result.user.email);
                        showMessage('âœ… Googleç™»å½•æˆåŠŸï¼');
                        showRedirectStatus('Googleç™»å½•æˆåŠŸï¼æ¬¢è¿ ' + result.user.email, 'success');
                        
                        // æ¸…é™¤URLå‚æ•°
                        clearAuthParams();
                        
                        // é‡ç½®ç™»å½•çŠ¶æ€
                        loginInProgress = false;
                        
                        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) {
                            loginModal.style.display = 'none';
                        }
                        
                        // æ›´æ–°ç”¨æˆ·ç•Œé¢
                        if (auth.currentUser) {
                            handleAuthStateChange(auth.currentUser);
                        }
                        
                    } else if (result.credential) {
                        console.log('ğŸ”‘ è·å–åˆ°å‡­è¯ä½†æ²¡æœ‰ç”¨æˆ·å¯¹è±¡ï¼Œéœ€è¦è¿›ä¸€æ­¥å¤„ç†');
                        showRedirectStatus('å¤„ç†ç™»å½•å‡­è¯ä¸­...', 'info');
                        
                    } else {
                        console.log('â„¹ï¸ æ²¡æœ‰ä»é‡å®šå‘è¿”å›çš„ç”¨æˆ·æˆ–å‡­è¯');
                        // è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š
                        // 1. ç”¨æˆ·å–æ¶ˆäº†ç™»å½•
                        // 2. ç™»å½•æµç¨‹è¿˜æœªå®Œæˆ
                        // 3. å…¶ä»–åŸå› 
                        
                        // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æœ‰ç”¨æˆ·ç™»å½•
                        if (auth.currentUser) {
                            console.log('âœ… å·²ç»æœ‰ç”¨æˆ·ç™»å½•:', auth.currentUser.email);
                            loginInProgress = false;
                            clearAuthParams();
                        } else {
                            // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œå¯èƒ½æ˜¯ç™»å½•å¤±è´¥æˆ–å–æ¶ˆ
                            console.log('âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°ç™»å½•ç”¨æˆ·');
                            
                            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰é”™è¯¯
                            const searchParams = new URLSearchParams(window.location.search);
                            const hashParams = new URLSearchParams(window.location.hash.substring(1));
                            
                            if (searchParams.get('error') || hashParams.get('error')) {
                                const error = searchParams.get('error') || hashParams.get('error');
                                console.error('âŒ URLä¸­æ£€æµ‹åˆ°é”™è¯¯:', error);
                                showRedirectStatus('ç™»å½•å¤±è´¥: ' + error, 'error');
                                clearAuthParams();
                                loginInProgress = false;
                            } else {
                                // å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç™»å½•è¿˜åœ¨è¿›è¡Œä¸­
                                console.log('â³ ç™»å½•å¯èƒ½è¿˜åœ¨è¿›è¡Œä¸­ï¼Œç»§ç»­ç­‰å¾…...');
                                setTimeout(handleOAuthRedirectReturn, 2000);
                            }
                        }
                    }
                })
                .catch((error) => {
                    console.log('âš ï¸ getRedirectResulté”™è¯¯:', error.code, error.message);
                    
                    // å¤„ç†å¸¸è§é”™è¯¯
                    switch(error.code) {
                        case 'auth/redirect-cancelled-by-user':
                            console.log('ğŸš« ç”¨æˆ·å–æ¶ˆäº†é‡å®šå‘ç™»å½•');
                            showRedirectStatus('ç™»å½•å·²å–æ¶ˆ', 'warning');
                            loginInProgress = false;
                            clearAuthParams();
                            break;
                            
                        case 'auth/redirect-operation-pending':
                            console.log('â³ é‡å®šå‘æ“ä½œæ­£åœ¨è¿›è¡Œä¸­');
                            // ç»§ç»­ç­‰å¾…
                            setTimeout(handleOAuthRedirectReturn, 2000);
                            break;
                            
                        case 'auth/no-auth-event':
                            console.log('â„¹ï¸ æ²¡æœ‰è®¤è¯äº‹ä»¶ - å¯èƒ½æ˜¯é¦–æ¬¡è®¿é—®æˆ–å·²ç»æ¸…é™¤');
                            loginInProgress = false;
                            break;
                            
                        case 'auth/unauthorized-domain':
                            console.error('âŒ æœªæˆæƒçš„åŸŸå');
                            showRedirectStatus('åŸŸåæœªæˆæƒï¼Œè¯·æ£€æŸ¥Firebaseé…ç½®', 'error');
                            loginInProgress = false;
                            break;
                            
                        default:
                            if (!error.code) {
                                console.log('â„¹ï¸ æ— é”™è¯¯ä»£ç ï¼Œå¯èƒ½æ˜¯æ­£å¸¸çŠ¶æ€');
                            } else {
                                console.error('âŒ æœªçŸ¥é”™è¯¯:', error);
                                showRedirectStatus('ç™»å½•é”™è¯¯: ' + error.message, 'error');
                            }
                            loginInProgress = false;
                    }
                });
        }

        /**
         * ğŸ”¥ ç»ˆæä¿®å¤ï¼šå¢å¼ºçš„Googleç™»å½•å‡½æ•°
         */
        function initLoginEvents() {
            const googleLoginBtn = document.getElementById('google-login-btn');
            
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', function() {
                    console.log('ğŸ‘† ç‚¹å‡»Googleç™»å½•æŒ‰é’® - ç»ˆæä¿®å¤ç‰ˆ');
                    
                    if (!auth) {
                        console.error('âŒ è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–');
                        showMessage('è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
                        return;
                    }
                    
                    // é˜²æ­¢é‡å¤ç‚¹å‡»
                    if (loginInProgress) {
                        console.log('âš ï¸ ç™»å½•å·²åœ¨å¤„ç†ä¸­');
                        showRedirectStatus('ç™»å½•å·²åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'warning');
                        return;
                    }
                    
                    // è®¾ç½®ç™»å½•çŠ¶æ€
                    loginInProgress = true;
                    
                    const provider = new firebase.auth.GoogleAuthProvider();
                    
                    // ğŸ”¥ ç»ˆæä¿®å¤ï¼šå®Œæ•´çš„OAuthé…ç½®
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.addScope('openid');
                    
                    // ğŸ”¥ å…³é”®è®¾ç½®ï¼šç¡®ä¿æ­£ç¡®çš„é‡å®šå‘è¡Œä¸º
                    provider.setCustomParameters({
                        prompt: 'select_account',
                        include_granted_scopes: 'true',
                        response_type: 'code',
                        access_type: 'offline',
                        hd: '*',
                        auth_type: 'reauthenticate'
                    });
                    
                    console.log('ğŸ”§ Googleç™»å½•é…ç½®è¯¦æƒ…:', {
                        scopes: provider.scopes,
                        customParameters: provider.customParameters,
                        providerId: provider.providerId
                    });
                    
                    // æ˜¾ç¤ºçŠ¶æ€
                    showRedirectStatus('æ­£åœ¨å¯åŠ¨Googleç™»å½•...', 'info');
                    
                    // æ¸…é™¤æ—§çš„URLå‚æ•°
                    clearAuthParams();
                    
                    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ä¸“é—¨çš„OAuthé‡å®šå‘å¤„ç†å™¨
                    setTimeout(() => {
                        handleGoogleLoginWithRedirect(provider);
                    }, 500);
                });
            }
            
            // å…¶ä»–ç™»å½•æŒ‰é’®äº‹ä»¶...
            const loginBtn = document.getElementById('login-btn');
            const closeLoginBtn = document.getElementById('close-login');
            const emailLoginBtn = document.getElementById('email-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginModal = document.getElementById('login-modal');
            
            if (loginBtn) loginBtn.addEventListener('click', () => loginModal.style.display = 'flex');
            if (closeLoginBtn) closeLoginBtn.addEventListener('click', () => loginModal.style.display = 'none');
            if (emailLoginBtn) emailLoginBtn.addEventListener('click', handleEmailLogin);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) loginModal.style.display = 'none';
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && loginModal.style.display === 'flex') {
                    loginModal.style.display = 'none';
                }
            });
        }

        /**
         * ğŸ”¥ ç»ˆæä¿®å¤ï¼šå¤„ç†Googleç™»å½•é‡å®šå‘
         */
        function handleGoogleLoginWithRedirect(provider) {
            console.log('ğŸ”„ æ‰§è¡ŒGoogleç™»å½•é‡å®šå‘...');
            
            // æ˜¾ç¤ºç­‰å¾…æ¶ˆæ¯
            showRedirectStatus('æ­£åœ¨è·³è½¬åˆ°Googleç™»å½•é¡µé¢...', 'info');
            
            // è®°å½•å¼€å§‹æ—¶é—´
            const startTime = Date.now();
            
            // æ‰§è¡Œé‡å®šå‘ç™»å½•
            auth.signInWithRedirect(provider)
                .then(() => {
                    console.log('âœ… signInWithRedirectè°ƒç”¨æˆåŠŸ');
                    
                    // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                    const checkTimeout = setTimeout(() => {
                        if (loginInProgress && !auth.currentUser) {
                            console.log('â° ç™»å½•è¶…æ—¶ï¼Œæ£€æŸ¥çŠ¶æ€');
                            showRedirectStatus('ç™»å½•å¤„ç†ä¸­ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæˆ...', 'warning');
                            handleOAuthRedirectReturn();
                        }
                    }, 10000); // 10ç§’è¶…æ—¶
                    
                    // å­˜å‚¨è¶…æ—¶IDä»¥ä¾¿æ¸…ç†
                    window.loginCheckTimeout = checkTimeout;
                })
                .catch((error) => {
                    console.error('âŒ signInWithRedirectè°ƒç”¨å¤±è´¥:', error);
                    
                    // æ¸…é™¤ç™»å½•çŠ¶æ€
                    loginInProgress = false;
                    
                    // æ¸…é™¤è¶…æ—¶æ£€æŸ¥
                    if (window.loginCheckTimeout) {
                        clearTimeout(window.loginCheckTimeout);
                    }
                    
                    showRedirectStatus('é‡å®šå‘å¤±è´¥: ' + error.message, 'error');
                    
                    // å°è¯•å¼¹çª—ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                    if (error.code === 'auth/operation-not-supported-in-this-environment' || 
                        error.code === 'auth/unauthorized-domain') {
                        console.log('ğŸªŸ å°è¯•å¼¹çª—ç™»å½•ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ...');
                        handleGoogleLoginWithPopup(provider);
                    } else {
                        showMessage('âŒ ç™»å½•å¤±è´¥: ' + error.message);
                    }
                });
        }

        /**
         * å¤‡é€‰æ–¹æ¡ˆï¼šå¼¹çª—ç™»å½•
         */
        function handleGoogleLoginWithPopup(provider) {
            console.log('ğŸªŸ å°è¯•å¼¹çª—ç™»å½•...');
            showRedirectStatus('å°è¯•å¼¹çª—ç™»å½•...', 'info');
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('âœ… å¼¹çª—ç™»å½•æˆåŠŸ:', result.user.email);
                    showMessage('âœ… Googleç™»å½•æˆåŠŸï¼');
                    showRedirectStatus('Googleç™»å½•æˆåŠŸï¼', 'success');
                    loginInProgress = false;
                    
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('âŒ å¼¹çª—ç™»å½•å¤±è´¥:', error);
                    showRedirectStatus('ç™»å½•å¤±è´¥: ' + error.message, 'error');
                    showMessage('âŒ ç™»å½•å¤±è´¥: ' + error.message);
                    loginInProgress = false;
                });
        }

        /**
         * å¤„ç†é‚®ç®±ç™»å½•
         */
        function handleEmailLogin() {
            const email = prompt('è¯·è¾“å…¥é‚®ç®±åœ°å€:');
            if (!email) return;
            
            const password = prompt('è¯·è¾“å…¥å¯†ç :');
            if (!password) return;
            
            // å…ˆå°è¯•åˆ›å»ºç”¨æˆ·ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•ç™»å½•
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼');
                    document.getElementById('login-modal').style.display = 'none';
                    showRedirectStatus('é‚®ç®±æ³¨å†ŒæˆåŠŸï¼', 'success');
                })
                .catch((error) => {
                    if (error.code === 'auth/email-already-in-use') {
                        auth.signInWithEmailAndPassword(email, password)
                            .then(() => {
                                showMessage('âœ… ç™»å½•æˆåŠŸï¼');
                                document.getElementById('login-modal').style.display = 'none';
                                showRedirectStatus('é‚®ç®±ç™»å½•æˆåŠŸï¼', 'success');
                            })
                            .catch(loginError => {
                                showMessage('âŒ ç™»å½•å¤±è´¥: ' + loginError.message);
                                showRedirectStatus('ç™»å½•å¤±è´¥: ' + loginError.message, 'error');
                            });
                    } else {
                        showMessage('âŒ é”™è¯¯: ' + error.message);
                        showRedirectStatus('é”™è¯¯: ' + error.message, 'error');
                    }
                });
        }

        /**
         * å¤„ç†é€€å‡ºç™»å½•
         */
        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                auth.signOut().then(() => {
                    showMessage('å·²é€€å‡ºç™»å½•');
                    showRedirectStatus('å·²é€€å‡ºç™»å½•', 'info');
                }).catch((error) => {
                    showMessage('é€€å‡ºå¤±è´¥: ' + error.message);
                    showRedirectStatus('é€€å‡ºå¤±è´¥', 'error');
                });
            }
        }

        /**
         * å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
         */
        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.email);
                updateUserUI();
            } else {
                currentUser = null;
                console.log('ğŸ‘‹ ç”¨æˆ·å·²ç™»å‡º');
                updateUserUI();
            }
        }

        /**
         * æ›´æ–°ç”¨æˆ·ç•Œé¢
         */
        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const loginBtn = document.getElementById('login-btn');
            const userAvatar = document.getElementById('user-avatar');
            const userEmail = document.getElementById('user-email');
            const adminSection = document.getElementById('admin-section');
            
            if (currentUser) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                userAvatar.textContent = initial;
                userEmail.textContent = displayName;
                
                if (adminSection) {
                    adminSection.style.display = 'block';
                }
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
            }
        }

        /**
         * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
         */
        function setupEventListeners() {
            initLoginEvents();
            
            // é¡µé¢å¯¼èˆª
            document.getElementById('karaoke-nav').addEventListener('click', function() {
                showPage('karaoke');
                setActiveNav(this);
            });
            
            document.getElementById('pricing-nav').addEventListener('click', function() {
                showPage('pricing');
                setActiveNav(this);
            });
            
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯å¸ƒå±€
            initializeViewport();
        }

        /**
         * æ˜¾ç¤ºé‡å®šå‘çŠ¶æ€
         */
        function showRedirectStatus(message, type = 'info') {
            const statusEl = document.getElementById('redirect-status');
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.className = `redirect-status show redirect-${type}`;
            
            console.log(`ğŸ“¢ çŠ¶æ€: ${type.toUpperCase()} - ${message}`);
            
            // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é—´
            const hideDelay = type === 'success' ? 3000 : 
                             type === 'error' ? 5000 : 
                             type === 'warning' ? 4000 : 3000;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, hideDelay);
        }

        /**
         * æ˜¾ç¤ºæ¶ˆæ¯
         */
        function showMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 5px; z-index: 1000; font-size: 14px; max-width: 300px; word-wrap: break-word; animation: fadeIn 0.3s ease;';
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        /**
         * åˆå§‹åŒ–è§†å£
         */
        function initializeViewport() {
            isMobileView = window.innerWidth <= 768;
            
            if (isMobileView) {
                document.getElementById('karaoke-page').style.display = 'block';
                document.querySelector('.mobile-tabs').style.display = 'block';
            } else {
                document.getElementById('karaoke-page').style.display = 'flex';
                document.querySelector('.mobile-tabs').style.display = 'none';
            }
            
            window.addEventListener('resize', function() {
                const newIsMobile = window.innerWidth <= 768;
                if (newIsMobile !== isMobileView) {
                    isMobileView = newIsMobile;
                    showPage('karaoke');
                    initializeViewport();
                }
            });
        }

        function showPage(page) {
            document.getElementById('karaoke-page').style.display = 'none';
            document.getElementById('pricing-page').style.display = 'none';
            
            if (page === 'karaoke') {
                if (isMobileView) {
                    document.getElementById('karaoke-page').style.display = 'block';
                } else {
                    document.getElementById('karaoke-page').style.display = 'flex';
                }
            } else if (page === 'pricing') {
                document.getElementById('pricing-page').style.display = 'block';
            }
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            activeButton.classList.add('active');
        }

        // å…¶ä»–åº”ç”¨åŠŸèƒ½å‡½æ•°ï¼ˆä¸ºäº†èŠ‚çœç©ºé—´çœç•¥ï¼‰
        // ... æ­Œæ›²æœç´¢ã€æ­Œå•ç®¡ç†ç­‰åŸæœ‰åŠŸèƒ½ ...
        
    </script>
</body>
</html>
