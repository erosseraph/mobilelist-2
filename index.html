<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…</title>
    
    <!-- PWA é…ç½® -->
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ­Œå…å®šåˆ¶">
    
    <!-- å†…è” PWA Manifest é…ç½® -->
    <script type="application/manifest+json">
    {
      "name": "å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…",
      "short_name": "æ­Œå…å®šåˆ¶",
      "description": "ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#1a2a6c",
      "theme_color": "#1a2a6c",
      "orientation": "portrait",
      "scope": "/",
      "lang": "zh-CN",
      "categories": ["music", "entertainment", "shopping"],
      
      "icons": [
        {
          "src": "/icons/icon-72.png",
          "sizes": "72x72",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-96.png",
          "sizes": "96x96",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-128.png",
          "sizes": "128x128",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-144.png",
          "sizes": "144x144",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-152.png",
          "sizes": "152x152",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-192.png",
          "sizes": "192x192",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-384.png",
          "sizes": "384x384",
          "type": "image/png",
          "purpose": "any maskable"
        },
        {
          "src": "/icons/icon-512.png",
          "sizes": "512x512",
          "type": "image/png",
          "purpose": "any maskable"
        }
      ]
    }
    </script>

    <!-- å›¾æ ‡åŠ è½½å¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
    // åŠ¨æ€åŠ è½½å›¾æ ‡ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
    document.addEventListener('DOMContentLoaded', function() {
        const icons = [
            '/icons/icon-72.png',
            '/icons/icon-96.png', 
            '/icons/icon-128.png',
            '/icons/icon-144.png',
            '/icons/icon-152.png',
            '/icons/icon-192.png',
            '/icons/icon-384.png',
            '/icons/icon-512.png'
        ];
        
        // é¢„åŠ è½½å›¾æ ‡å¹¶æ£€æµ‹æ˜¯å¦å¯ç”¨
        icons.forEach(iconPath => {
            const img = new Image();
            img.onerror = function() {
                console.warn('å›¾æ ‡åŠ è½½å¤±è´¥:', iconPath);
            };
            img.src = iconPath;
        });
    });
    </script>
    
    <!-- è‹¹æœ Touch å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- é…ç½®åŠ è½½ -->
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .login-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .user-info {
            display: none;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* é¡µé¢å®¹å™¨ */
        .page-container {
            display: flex;
            gap: 20px;
            min-height: 600px;
        }
        
        /* ç‚¹æ­Œç³»ç»Ÿé¡µé¢ */
        #karaoke-page {
            display: flex;
            flex: 1;
            gap: 20px;
        }
        
        .songs-section {
            flex: 2;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .playlist-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* æ’è¡Œæ¦œæ ·å¼ */
        .charts-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-category {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .chart-category:hover, .chart-category.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-btn, .clear-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover, .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* æ­Œæ›²åˆ—è¡¨æ ·å¼ */
        .songs-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .song {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .song:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .song-info {
            flex: 1;
        }
        
        .song-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .song-artist {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .song-controls {
            display: flex;
            gap: 8px;
        }
        
        .preview-btn, .add-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .preview-btn:hover, .add-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* æ­Œå•æ ·å¼ */
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .playlist-count {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .share-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .playlist-items {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s;
            cursor: move;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .playlist-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .song-number {
            width: 25px;
            text-align: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .remove-btn {
            background: rgba(255, 59, 48, 0.3);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .remove-btn:hover {
            background: rgba(255, 59, 48, 0.5);
        }
        
        .empty-playlist {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        
        .playlist-pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .playlist-pagination button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .playlist-pagination button.active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ä»·æ ¼é¡µé¢æ ·å¼ */
        #pricing-page {
            display: none;
            flex: 1;
        }
        
        .pricing-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
        }
        
        .pricing-card.popular {
            border: 2px solid #ffd700;
            transform: scale(1.05);
        }
        
        .popular-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .pricing-card.custom {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .plan-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .song-range {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }
        
        .select-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
        }
        
        .select-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .select-btn.popular-btn {
            background: #ffd700;
            color: #333;
            font-weight: bold;
        }
        
        .select-btn.custom-btn {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* é…é€ä¿¡æ¯æ ·å¼ */
        .shipping-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px auto;
            max-width: 800px;
        }
        
        .shipping-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .shipping-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }
        
        .shipping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .shipping-region {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .shipping-price {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        .shipping-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .shipping-note {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
            font-style: italic;
            margin-top: 15px;
        }
        
        /* è®¢å•é¡µé¢æ ·å¼ */
        #order-page {
            display: none;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .order-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-input, .form-select {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .order-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .price-summary {
            margin-top: 15px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .total-price {
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .order-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .cancel-btn, .submit-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .submit-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .submit-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        /* ç§»åŠ¨ç«¯æ ·å¼ */
        .mobile-playlist-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .mobile-playlist-fab:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .mobile-playlist-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 42, 108, 0.9);
            display: none;
            justify-content: space-around;
            padding: 10px 0;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        
        .mobile-bottom-btn {
            background: none;
            border: none;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 15px;
            transition: all 0.3s;
            opacity: 0.7;
        }
        
        .mobile-bottom-btn.active, .mobile-bottom-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .mobile-bottom-btn span:last-child {
            font-size: 0.8rem;
        }
        
        /* éŸ³é¢‘æ’­æ”¾å™¨ */
        .audio-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            z-index: 1001;
            transition: all 0.3s;
        }
        
        .audio-player.hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(100px);
            pointer-events: none;
        }
        
        .audio-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
        }
        
        .audio-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .audio-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .login-methods {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .login-method-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-method-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .login-form {
            display: none;
        }
        
        .form-input-group {
            margin-bottom: 15px;
        }
        
        .form-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .login-submit {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .register-submit {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .form-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .back-to-methods {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            margin-top: 15px;
            text-decoration: underline;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
            }
            
            #karaoke-page {
                flex-direction: column;
            }
            
            .order-form {
                grid-template-columns: 1fr;
            }
            
            .mobile-playlist-fab {
                display: flex;
            }
            
            .mobile-bottom-bar {
                display: flex;
            }
            
            .navbar .nav-buttons {
                display: none;
            }
            
            .playlist-section {
                max-height: 300px;
            }
            
            .pricing-container {
                grid-template-columns: 1fr;
            }
            
            .pricing-card.popular {
                transform: scale(1.02);
            }
            
            .shipping-options {
                grid-template-columns: 1fr;
            }
        }
        
        /* å·¥å…·ç±» */
        .hidden {
            display: none !important;
        }
        
        .loading, .error {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.8;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-section {
            display: none;
            margin-left: 15px;
        }
        
        .admin-link {
            background: rgba(255, 215, 0, 0.2);
            border: none;
            color: gold;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .playlist-preview-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç™»å½• / æ³¨å†Œ</h2>
                <button class="close-btn" id="close-login">&times;</button>
            </div>
            
            <div class="login-methods">
                <button class="login-method-btn" id="email-login-btn">
                    ğŸ“§ é‚®ç®±ç™»å½•/æ³¨å†Œ
                </button>
                <button class="login-method-btn" id="google-login-btn">
                    ğŸ”µ Google ç™»å½•
                </button>
            </div>
            
            <div class="login-form" id="email-login-form">
                <div class="form-input-group">
                    <input type="email" id="email-input" placeholder="é‚®ç®±åœ°å€" required>
                    <input type="password" id="password-input" placeholder="å¯†ç " required>
                </div>
                <div class="form-actions">
                    <button class="form-btn login-submit" id="email-login-submit">ç™»å½•</button>
                    <button class="form-btn register-submit" id="email-register-submit">æ³¨å†Œ</button>
                </div>
                <button class="back-to-methods">â† è¿”å›ç™»å½•æ–¹å¼</button>
            </div>
            
            <div id="login-loading" style="display: none; text-align: center; padding: 20px;">
                å¤„ç†ä¸­...
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="logo">
                ğŸ¤ å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" id="karaoke-nav">ğŸµ ç‚¹æ­Œç³»ç»Ÿ</button>
                <button class="nav-btn" id="pricing-nav">ğŸ’° ä»·æ ¼é…å¥—</button>
                <div class="admin-section" id="admin-section">
                    <a href="admin.html" class="admin-link">ğŸ‘‘ ç®¡ç†é¢æ¿</a>
                </div>
            </div>
            
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-email" id="user-email">ç”¨æˆ·</span>
                    <button class="logout-btn" id="logout-btn">é€€å‡º</button>
                </div>
                <button class="login-btn" id="login-btn">ç™»å½•/æ³¨å†Œ</button>
            </div>
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- ç‚¹æ­Œç³»ç»Ÿé¡µé¢ -->
            <div id="karaoke-page">
                <div class="songs-section">
                    <div class="charts-container">
                        <div class="chart-category active" data-category="chinese-pop">åè¯­æµè¡Œ</div>
                        <div class="chart-category" data-category="western-pop">æ¬§ç¾æµè¡Œ</div>
                        <div class="chart-category" data-category="chinese-dj">ä¸­æ–‡DJ</div>
                        <div class="chart-category" data-category="chinese-artists">åè¯­æ­Œæ‰‹</div>
                        <div class="chart-category" data-category="western-artists">æ¬§ç¾æ­Œæ‰‹</div>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" class="search-input" id="search-input" placeholder="æœç´¢æ­Œæ›²åç§°ã€æ­Œæ‰‹...">
                        <button class="search-btn" id="search-btn">æœç´¢</button>
                        <button class="clear-btn" id="clear-btn">æ¸…ç©º</button>
                    </div>
                    
                    <div class="songs-container" id="songs-container">
                        <div class="loading">æ­£åœ¨åŠ è½½æ­Œæ›²...</div>
                    </div>
                </div>
                
                <div class="playlist-section">
                    <div class="playlist-header">
                        <div class="playlist-count">æˆ‘çš„æ­Œå• <span id="playlist-count">(0)</span></div>
                        <button class="share-btn" id="share-btn">åˆ†äº«æ­Œå•</button>
                    </div>
                    
                    <div class="playlist-items" id="playlist-items">
                        <div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>
                    </div>
                    
                    <div class="playlist-pagination" id="playlist-pagination"></div>
                </div>
            </div>
            
            <!-- ä»·æ ¼é…å¥—é¡µé¢ -->
            <div id="pricing-page">
                <div class="pricing-container">
                    <div class="pricing-card">
                        <div class="plan-name">åŸºç¡€ç‰ˆ</div>
                        <div class="price">RM 29</div>
                        <div class="song-range">1 - 20 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">æ ‡å‡†ç‰ˆ</div>
                        <div class="price">RM 49</div>
                        <div class="song-range">21 - 50 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card popular">
                        <div class="popular-badge">æœ€å—æ¬¢è¿</div>
                        <div class="plan-name">è¿›é˜¶ç‰ˆ</div>
                        <div class="price">RM 69</div>
                        <div class="song-range">51 - 100 é¦–æ­Œæ›²</div>
                        <button class="select-btn popular-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">è±ªåç‰ˆ</div>
                        <div class="price">RM 89</div>
                        <div class="song-range">101 - 200 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">ä¸“ä¸šç‰ˆ</div>
                        <div class="price">RM 109</div>
                        <div class="song-range">201 - 300 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">æ——èˆ°ç‰ˆ</div>
                        <div class="price">RM 129</div>
                        <div class="song-range">301 - 400 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card">
                        <div class="plan-name">è‡³å°Šç‰ˆ</div>
                        <div class="price">RM 159</div>
                        <div class="song-range">401 - 500 é¦–æ­Œæ›²</div>
                        <button class="select-btn">é€‰æ‹©æ­¤é…å¥—</button>
                    </div>
                    
                    <div class="pricing-card custom">
                        <div class="plan-name">è‡ªå®šä¹‰ç‰ˆ</div>
                        <div class="price">RM 0.30/æ¯é¦–</div>
                        <div class="song-range">501+ é¦–æ­Œæ›²</div>
                        <button class="select-btn custom-btn">è”ç³»å®šåˆ¶</button>
                    </div>
                </div>
                
                <!-- é…é€ä¿¡æ¯ -->
                <div class="shipping-info">
                    <h3 style="text-align: center; margin: 30px 0 20px 0; color: white;">é…é€ä¿¡æ¯</h3>
                    <div class="shipping-options">
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">è¥¿é©¬</span>
                                <span class="shipping-price">å…è´¹é…é€</span>
                            </div>
                            <div class="shipping-desc">é¢„è®¡ 5-7 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                        <div class="shipping-option">
                            <div class="shipping-header">
                                <span class="shipping-region">ä¸œé©¬</span>
                                <span class="shipping-price">RM 8.00</span>
                            </div>
                            <div class="shipping-desc">é¢„è®¡ 7-10 ä¸ªå·¥ä½œæ—¥å†…é€è¾¾</div>
                        </div>
                    </div>
                    <div class="shipping-note">
                        * æ‰€æœ‰é…å¥—å‡åŒ…å«å®Œæ•´çš„æŠ€æœ¯æ”¯æŒå’Œå”®åæœåŠ¡
                    </div>
                </div>
            </div>
            
            <!-- è®¢å•é¡µé¢ -->
            <div id="order-page">
                <h2 style="margin-bottom: 20px;">æäº¤è®¢å•</h2>
                
                <div class="order-form">
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" class="form-input" id="customer-name" placeholder="è¯·è¾“å…¥å§“å" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç”µè¯ *</label>
                        <input type="tel" class="form-input" id="customer-phone" placeholder="+60xxxxxxxx" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é‚®ç®± *</label>
                        <input type="email" class="form-input" id="customer-email" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ‰€åœ¨å·å± *</label>
                        <select class="form-select" id="customer-state" required>
                            <option value="">è¯·é€‰æ‹©å·å±</option>
                            <option value="west">è¥¿é©¬</option>
                            <option value="east">ä¸œé©¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">è¯¦ç»†åœ°å€ *</label>
                        <input type="text" class="form-input" id="customer-address" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€" required>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h3 style="margin-bottom: 15px;">è®¢å•æ‘˜è¦</h3>
                    <div id="order-playlist-preview">
                        <!-- æ­Œå•é¢„è§ˆå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="price-summary" id="price-summary">
                        <!-- ä»·æ ¼æ‘˜è¦å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="order-actions">
                    <button class="cancel-btn" id="cancel-order">å–æ¶ˆ</button>
                    <button class="submit-btn" id="submit-order">æäº¤è®¢å•</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯æµ®åŠ¨æ­Œå•æŒ‰é’® -->
    <button class="mobile-playlist-fab" id="mobile-playlist-fab">
        ğŸµ
        <div class="mobile-playlist-badge" id="mobile-playlist-badge">0</div>
    </button>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-bottom-bar">
        <button class="mobile-bottom-btn active" data-page="karaoke">
            <span style="font-size: 1.2rem;">ğŸ¤</span>
            <span>ç‚¹æ­Œ</span>
        </button>
        <button class="mobile-bottom-btn" data-page="pricing">
            <span style="font-size: 1.2rem;">ğŸ’°</span>
            <span>ä»·æ ¼</span>
        </button>
        <button class="mobile-bottom-btn" onclick="showOrderPage()">
            <span style="font-size: 1.2rem;">ğŸ›’</span>
            <span>è®¢å•</span>
        </button>
    </div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player hidden" id="audio-player">
        <div class="audio-info" id="audio-info">è¯•å¬ä¸­...</div>
        <div class="audio-controls">
            <button id="play-pause-btn">â¸ï¸</button>
            <button id="stop-btn">â¹ï¸</button>
        </div>
    </div>

    <script>
        // ==================== Firebase åˆå§‹åŒ– ====================
        let firebaseApp, auth, firestore;
        
        function initializeFirebase() {
            try {
                // ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®
                const firebaseConfig = getFirebaseConfig();
                console.log('ğŸ”§ Firebase é…ç½®:', firebaseConfig);
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬
                auth.onAuthStateChanged(handleAuthStateChange);
            } catch (error) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ==================== ç§»åŠ¨ç«¯åŠŸèƒ½åˆå§‹åŒ– ====================
        function initMobileFeatures() {
            const fab = document.getElementById('mobile-playlist-fab');
            const badge = document.getElementById('mobile-playlist-badge');
            
            if (fab) {
                fab.addEventListener('click', () => {
                    document.querySelector('.playlist-section').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                });
            }
            
            // æ›´æ–°æ­Œå•å¾½ç« 
            function updatePlaylistBadge() {
                const count = playlist.length;
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                }
            }
            
            // ç›‘å¬æ­Œå•å˜åŒ–
            const originalUpdatePlaylistCount = updatePlaylistCount;
            updatePlaylistCount = function() {
                originalUpdatePlaylistCount();
                updatePlaylistBadge();
            };
            
            // åº•éƒ¨å¯¼èˆªåŠŸèƒ½
            document.querySelectorAll('.mobile-bottom-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    
                    // æ›´æ–°æ´»è·ƒçŠ¶æ€
                    document.querySelectorAll('.mobile-bottom-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // åˆ‡æ¢é¡µé¢
                    if (page === 'karaoke') {
                        showPage('karaoke');
                        setActiveNav(document.getElementById('karaoke-nav'));
                    } else if (page === 'pricing') {
                        showPage('pricing');
                        setActiveNav(document.getElementById('pricing-nav'));
                    }
                });
            });
            
            // åˆå§‹åŒ–å¾½ç« 
            updatePlaylistBadge();
        }

        // ==================== PWA Service Worker æ³¨å†Œ ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('âœ… ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('âŒ ServiceWorker æ³¨å†Œå¤±è´¥: ', error);
                    });
            });
        }

        // ==================== è®¤è¯çŠ¶æ€ç®¡ç† ====================
        function handleAuthStateChange(user) {
            if (user) {
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.email);
                currentUser = user;
                updateUserUI();
                loadUserPlaylistFromFirestore();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†é¢æ¿é“¾æ¥
                checkAdminAccess(user);
            } else {
                console.log('âŒ ç”¨æˆ·å·²é€€å‡º');
                currentUser = null;
                updateUserUI();
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                
                // éšè—ç®¡ç†é¢æ¿é“¾æ¥
                const adminSection = document.getElementById('admin-section');
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
            }
        }

        // ==================== ç®¡ç†å‘˜æƒé™æ£€æŸ¥ ====================
        function checkAdminAccess(user) {
            // è¿™é‡Œå¯ä»¥è®¾ç½®ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨
            const adminEmails = [
                'admin@karaoke.com',
                'erosseraph@gmail.com'
            ];
            
            const adminSection = document.getElementById('admin-section');
            if (adminSection && adminEmails.includes(user.email)) {
                adminSection.style.display = 'block';
                console.log('ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²æˆäºˆ');
            } else if (adminSection) {
                adminSection.style.display = 'none';
            }
        }

        // ==================== ç”¨æˆ·è®¤è¯åŠŸèƒ½ ====================
        let currentUser = null;
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn');
        const closeLoginBtn = document.getElementById('close-login');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const userAvatar = document.getElementById('user-avatar');
        const logoutBtn = document.getElementById('logout-btn');

        // ç™»å½•æ–¹å¼æŒ‰é’®
        const emailLoginBtn = document.getElementById('email-login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');

        // ç™»å½•è¡¨å•
        const emailLoginForm = document.getElementById('email-login-form');
        const emailLoginSubmit = document.getElementById('email-login-submit');
        const emailRegisterSubmit = document.getElementById('email-register-submit');

        function updateUserUI() {
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                
                if (userAvatar) userAvatar.textContent = initial;
                if (userEmail) userEmail.textContent = displayName;
                if (userInfo) userInfo.style.display = 'flex';
                if (loginBtn) loginBtn.style.display = 'none';
            } else {
                if (userInfo) userInfo.style.display = 'none';
                if (loginBtn) loginBtn.style.display = 'block';
            }
        }

        async function handleEmailLogin() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                showMessage(`æ¬¢è¿å›æ¥ï¼Œ${result.user.email}`);
                if (loginModal) loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±ç™»å½•å¤±è´¥:', error);
                showMessage(`ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleEmailRegister() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                return;
            }

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                showMessage(`æ³¨å†ŒæˆåŠŸï¼Œæ¬¢è¿ ${result.user.email}`);
                if (loginModal) loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±æ³¨å†Œå¤±è´¥:', error);
                showMessage(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            }
        }

        async function handleGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showMessage(`æ¬¢è¿ï¼Œ${result.user.displayName}`);
                if (loginModal) loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('Googleç™»å½•å¤±è´¥:', error);
                showMessage(`Googleç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                showMessage('å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMessage('é€€å‡ºç™»å½•å¤±è´¥');
            }
        }

        function resetLoginForms() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (emailLoginForm) emailLoginForm.style.display = 'none';
            
            const loginMethods = document.querySelector('.login-methods');
            if (loginMethods) loginMethods.style.display = 'flex';
            
            const loginLoading = document.getElementById('login-loading');
            if (loginLoading) loginLoading.style.display = 'none';
        }

        function showLoginMethod(method) {
            const loginMethods = document.querySelector('.login-methods');
            if (loginMethods) loginMethods.style.display = 'none';
            
            if (method === 'email' && emailLoginForm) {
                emailLoginForm.style.display = 'block';
            }
        }

        // ==================== Firestore æ•°æ®ç®¡ç† ====================
        async function saveUserPlaylistToFirestore() {
            if (!currentUser) return;

            try {
                await firestore.collection('playlists').doc(currentUser.uid).set({
                    songs: playlist,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    songCount: playlist.length,
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                console.log('âœ… æ­Œå•å·²ä¿å­˜åˆ° Firestore');
            } catch (error) {
                console.error('ä¿å­˜æ­Œå•åˆ° Firestore å¤±è´¥:', error);
                saveUserPlaylistToLocal();
            }
        }

        async function loadUserPlaylistFromFirestore() {
            if (!currentUser) return;

            try {
                const doc = await firestore.collection('playlists').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    playlist = data.songs || [];
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage('å·²ä»äº‘ç«¯åŠ è½½æ‚¨çš„æ­Œå•');
                }
            } catch (error) {
                console.error('ä» Firestore åŠ è½½æ­Œå•å¤±è´¥:', error);
                loadUserPlaylistFromLocal();
            }
        }

        function saveUserPlaylistToLocal() {
            if (!currentUser) return;
            try {
                localStorage.setItem(`playlist_${currentUser.uid}`, JSON.stringify(playlist));
            } catch (e) {
                console.error('ä¿å­˜æ­Œå•åˆ°æœ¬åœ°å¤±è´¥:', e);
            }
        }

        function loadUserPlaylistFromLocal() {
            if (!currentUser) return;
            const savedPlaylist = localStorage.getItem(`playlist_${currentUser.uid}`);
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                    renderPlaylist();
                    updatePlaylistCount();
                } catch (e) {
                    console.error('ä»æœ¬åœ°åŠ è½½æ­Œå•å¤±è´¥:', e);
                }
            }
        }

        // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
        function initPageNavigation() {
            const karaokeNav = document.getElementById('karaoke-nav');
            const pricingNav = document.getElementById('pricing-nav');
            
            if (karaokeNav) {
                karaokeNav.addEventListener('click', function() {
                    showPage('karaoke');
                    setActiveNav(this);
                });
            }
            
            if (pricingNav) {
                pricingNav.addEventListener('click', function() {
                    showPage('pricing');
                    setActiveNav(this);
                });
            }
        }
        
        function showPage(page) {
            const karaokePage = document.getElementById('karaoke-page');
            const pricingPage = document.getElementById('pricing-page');
            const orderPage = document.getElementById('order-page');
            
            if (karaokePage) karaokePage.style.display = page === 'karaoke' ? 'flex' : 'none';
            if (pricingPage) pricingPage.style.display = page === 'pricing' ? 'block' : 'none';
            if (orderPage) orderPage.style.display = page === 'order' ? 'block' : 'none';
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // ==================== ä»·æ ¼é…å¥—åŠŸèƒ½ ====================
        function initPricingButtons() {
            document.querySelectorAll('.select-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const pricingCard = this.closest('.pricing-card');
                    if (pricingCard) {
                        const planName = pricingCard.querySelector('.plan-name').textContent;
                        const price = pricingCard.querySelector('.price').textContent;
                        const songRange = pricingCard.querySelector('.song-range').textContent;
                        
                        if (planName === 'è‡ªå®šä¹‰ç‰ˆ') {
                            alert(`ğŸ“ è¯·è”ç³»æˆ‘ä»¬å®šåˆ¶ ${songRange} çš„ä¸“å±æ–¹æ¡ˆ\nä»·æ ¼: ${price}\n\nè¯·ç‚¹å‡»"åˆ†äº«æ­Œå•"åè”ç³»å®¢æœã€‚`);
                        } else {
                            alert(`âœ… æ‚¨é€‰æ‹©äº† ${planName}\næ­Œæ›²èŒƒå›´: ${songRange}\nä»·æ ¼: ${price}\n\nè¯·ç‚¹å‡»"åˆ†äº«æ­Œå•"æäº¤è®¢å•ã€‚`);
                        }
                    }
                });
            });
        }
        
        // ==================== ç‚¹æ­Œç³»ç»ŸåŠŸèƒ½ ====================
        let currentSongs = [];
        let playlist = [];
        let currentAudio = null;
        let isPlaying = false;
        let isSearchResultsView = false;
        let currentPlaylistPage = 1;
        const SONGS_PER_PAGE = 10;
        
        const chartsContainer = document.getElementById('charts-container');
        const songsContainer = document.getElementById('songs-container');
        const playlistContainer = document.getElementById('playlist-items');
        const playlistPagination = document.getElementById('playlist-pagination');
        const playlistCount = document.getElementById('playlist-count');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const shareBtn = document.getElementById('share-btn');
        const audioPlayer = document.getElementById('audio-player');
        const audioInfo = document.getElementById('audio-info');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        function initKaraoke() {
            setupEventListeners();
            initPageNavigation();
            initPricingButtons();
            initOrderFunctions();
            updatePlaylistCount();
            loadChart('chinese-pop');
            initMobileFeatures();
        }
        
        // ==================== æ”¹è¿›çš„éŸ³ä¹æœç´¢åŠŸèƒ½ ====================
        async function searchMusic(term, category = 'musicTrack', limit = 50) {
            try {
                showLoading('æ­£åœ¨æœç´¢...');
                
                // å¤‡ç”¨æœç´¢è¯ç­–ç•¥
                let searchTerms = [term];
                
                // å¦‚æœæ˜¯ä¸­æ–‡æœç´¢ï¼Œæ·»åŠ è‹±æ–‡å¤‡ç”¨è¯
                if (/[\u4e00-\u9fa5]/.test(term)) {
                    // å¸¸è§æ­Œæ‰‹è‹±æ–‡åæ˜ å°„
                    const artistMap = {
                        'å‘¨æ°ä¼¦': 'Jay Chou',
                        'æ—ä¿Šæ°': 'JJ Lin', 
                        'é‚“ç´«æ£‹': 'G.E.M.',
                        'è–›ä¹‹è°¦': 'Joker Xue',
                        'ç‹åŠ›å®': 'Leehom Wang',
                        'é™ˆå¥•è¿…': 'Eason Chan',
                        'å¼ æƒ å¦¹': 'A-Mei',
                        'è”¡ä¾æ—': 'Jolin Tsai'
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šæ­Œæ‰‹
                    for (const [chinese, english] of Object.entries(artistMap)) {
                        if (term.includes(chinese)) {
                            searchTerms.push(english);
                            break;
                        }
                    }
                    
                    // æ·»åŠ é€šç”¨è‹±æ–‡å…³é”®è¯
                    if (term.includes('åè¯­') || term.includes('ä¸­æ–‡')) {
                        searchTerms.push('chinese pop');
                        searchTerms.push('mandopop');
                    }
                }
                
                let allResults = [];
                
                // å°è¯•å¤šä¸ªæœç´¢è¯
                for (const searchTerm of searchTerms) {
                    if (allResults.length >= limit) break;
                    
                    const encodedTerm = encodeURIComponent(searchTerm);
                    const url = `https://itunes.apple.com/search?term=${encodedTerm}&entity=${category}&limit=${limit}&country=CN&lang=zh_cn`;
                    
                    console.log(`ğŸ” æœç´¢: ${searchTerm}, URL: ${url}`);
                    
                    try {
                        const response = await fetch(url);
                        if (!response.ok) continue;
                        
                        const data = await response.json();
                        console.log(`ğŸ“Š æœç´¢ç»“æœ: ${data.resultCount} æ¡`);
                        
                        if (data.resultCount === 0) continue;
                        
                        const filteredResults = data.results.map(track => ({
                            id: track.trackId || Math.random().toString(36).substr(2, 9),
                            title: track.trackName || 'æœªçŸ¥æ­Œæ›²',
                            artist: track.artistName || 'æœªçŸ¥æ­Œæ‰‹',
                            album: track.collectionName || 'æœªçŸ¥ä¸“è¾‘',
                            duration: track.trackTimeMillis,
                            previewUrl: track.previewUrl,
                            artwork: track.artworkUrl100
                        })).filter(track => {
                            // æ›´å®½æ¾çš„è¿‡æ»¤æ¡ä»¶
                            return track.previewUrl && 
                                   track.title && 
                                   track.artist &&
                                   !track.title.toLowerCase().includes('karaoke') &&
                                   !track.artist.toLowerCase().includes('karaoke');
                        });
                        
                        // å»é‡å¹¶åˆå¹¶ç»“æœ
                        const existingIds = new Set(allResults.map(song => song.id));
                        filteredResults.forEach(song => {
                            if (!existingIds.has(song.id)) {
                                allResults.push(song);
                            }
                        });
                        
                    } catch (error) {
                        console.warn(`æœç´¢è¯ "${searchTerm}" å¤±è´¥:`, error);
                        continue;
                    }
                }
                
                console.log(`ğŸµ æ€»è¿‡æ»¤åç»“æœ: ${allResults.length} é¦–æ­Œæ›²`);
                
                if (allResults.length === 0) {
                    showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œè¯·å°è¯•å…¶ä»–æœç´¢è¯');
                    return [];
                }
                
                return allResults.slice(0, limit);
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
                return [];
            }
        }
        
        // ==================== æ”¹è¿›çš„æ’è¡Œæ¦œåŠ è½½ ====================
        async function loadChart(category) {
            isSearchResultsView = false;
            let searchTerms = [];
            let entityType = 'musicTrack';
            let limit = 50;
            
            // å¤šå…³é”®è¯æœç´¢ç­–ç•¥
            switch(category) {
                case 'chinese-pop':
                    searchTerms = [
                        'å‘¨æ°ä¼¦',
                        'æ—ä¿Šæ°', 
                        'é‚“ç´«æ£‹',
                        'è–›ä¹‹è°¦',
                        'åè¯­æµè¡Œ',
                        'mandopop',
                        'chinese pop'
                    ];
                    break;
                case 'western-pop':
                    searchTerms = [
                        'Taylor Swift',
                        'Ed Sheeran',
                        'Ariana Grande',
                        'Justin Bieber',
                        'Billie Eilish',
                        'pop music',
                        'top 40'
                    ];
                    break;
                case 'chinese-dj':
                    searchTerms = [
                        'ä¸­æ–‡DJ',
                        'ç”µéŸ³',
                        'EDM',
                        'remix',
                        'ç”µå­éŸ³ä¹'
                    ];
                    entityType = 'musicTrack';
                    limit = 40;
                    break;
                case 'chinese-artists':
                    renderArtistsList([
                        'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 
                        'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿',
                        'äº”æœˆå¤©', 'å¼ å­¦å‹', 'åˆ˜å¾·å', 'ç‹è²', 'å¼ æ°'
                    ]);
                    return;
                case 'western-artists':
                    renderArtistsList([
                        'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish',
                        'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars'
                    ]);
                    return;
            }
            
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœç´¢è¯è¿›è¡Œåˆå§‹æœç´¢
            currentSongs = await searchMusic(searchTerms[0], entityType, limit);
            
            // å¦‚æœç»“æœä¸å¤Ÿï¼Œå°è¯•å…¶ä»–æœç´¢è¯
            if (currentSongs.length < 15 && searchTerms.length > 1) {
                console.log('ğŸ” ç»“æœè¾ƒå°‘ï¼Œå°è¯•å…¶ä»–æœç´¢è¯...');
                for (let i = 1; i < searchTerms.length; i++) {
                    if (currentSongs.length >= 30) break;
                    
                    const backupResults = await searchMusic(searchTerms[i], entityType, 20);
                    const existingIds = new Set(currentSongs.map(song => song.id));
                    backupResults.forEach(song => {
                        if (!existingIds.has(song.id)) {
                            currentSongs.push(song);
                        }
                    });
                }
            }
            
            renderSongs(currentSongs);
            
            document.querySelectorAll('.chart-category').forEach(chart => {
                chart.classList.remove('active');
            });
            const activeChart = document.querySelector(`[data-category="${category}"]`);
            if (activeChart) activeChart.classList.add('active');
        }
        
        function renderArtistsList(artists) {
            if (!songsContainer) return;
            
            songsContainer.innerHTML = '';
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">æ­Œæ‰‹</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
        }
        
        function renderSongs(songs) {
            if (!songsContainer) return;
            
            songsContainer.innerHTML = '';
            
            if (songs.length === 0) {
                songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                return;
            }
            
            if (isSearchResultsView) {
                const backButton = document.createElement('button');
                backButton.className = 'back-btn';
                backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
                backButton.addEventListener('click', () => {
                    isSearchResultsView = false;
                    loadChart('chinese-pop');
                });
                songsContainer.appendChild(backButton);
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}">â–¶ï¸</button>` : ''}
                        <button class="add-btn" data-id="${song.id}">+</button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
        }
        
        function renderPlaylist() {
            if (!playlistContainer) return;
            
            playlistContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
                renderPlaylistPagination();
                return;
            }
            
            const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
            const currentSongs = playlist.slice(startIndex, endIndex);
            
            currentSongs.forEach((song, index) => {
                const globalIndex = startIndex + index;
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.draggable = true;
                playlistItem.dataset.index = globalIndex;
                playlistItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="song-number">${globalIndex + 1}</div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            renderPlaylistPagination();
            setupDragAndDrop();
        }
        
        function renderPlaylistPagination() {
            if (!playlistPagination) return;
            
            playlistPagination.innerHTML = '';
            
            if (playlist.length <= SONGS_PER_PAGE) return;
            
            const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
            
            if (currentPlaylistPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                prevButton.addEventListener('click', () => {
                    currentPlaylistPage--;
                    renderPlaylist();
                });
                playlistPagination.appendChild(prevButton);
            }
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPlaylistPage);
                pageButton.addEventListener('click', () => {
                    currentPlaylistPage = i;
                    renderPlaylist();
                });
                playlistPagination.appendChild(pageButton);
            }
            
            if (currentPlaylistPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                nextButton.addEventListener('click', () => {
                    currentPlaylistPage++;
                    renderPlaylist();
                });
                playlistPagination.appendChild(nextButton);
            }
        }
        
        function setupEventListeners() {
            if (chartsContainer) {
                chartsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('chart-category')) {
                        const category = e.target.dataset.category;
                        loadChart(category);
                    }
                });
            }
            
            if (songsContainer) {
                songsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-btn')) {
                        const songId = e.target.dataset.id;
                        const artist = e.target.dataset.artist;
                        
                        if (artist) {
                            performSearch(artist);
                        } else if (songId) {
                            addSongToPlaylist(songId);
                        }
                    } else if (e.target.classList.contains('preview-btn')) {
                        const songId = e.target.dataset.id;
                        previewSong(songId);
                    }
                });
            }
            
            if (playlistContainer) {
                playlistContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-btn')) {
                        const index = parseInt(e.target.dataset.index);
                        removeSongFromPlaylist(index);
                    }
                });
            }
            
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', () => {
                    const query = searchInput.value.trim();
                    if (query) performSearch(query);
                });
            }
            
            if (searchInput) {
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        const query = searchInput.value.trim();
                        if (query) performSearch(query);
                    }
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', clearPlaylist);
            }
            
            if (shareBtn) {
                shareBtn.addEventListener('click', sharePlaylist);
            }
            
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', togglePlayPause);
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', stopAudio);
            }
            
            // è®¤è¯ç›¸å…³äº‹ä»¶
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    if (loginModal) loginModal.style.display = 'flex';
                });
            }
            
            if (closeLoginBtn) {
                closeLoginBtn.addEventListener('click', () => {
                    if (loginModal) loginModal.style.display = 'none';
                    resetLoginForms();
                });
            }
            
            if (emailLoginBtn) {
                emailLoginBtn.addEventListener('click', () => showLoginMethod('email'));
            }
            
            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', handleGoogleLogin);
            }
            
            if (emailLoginSubmit) {
                emailLoginSubmit.addEventListener('click', handleEmailLogin);
            }
            
            if (emailRegisterSubmit) {
                emailRegisterSubmit.addEventListener('click', handleEmailRegister);
            }
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            document.querySelectorAll('.back-to-methods').forEach(btn => {
                btn.addEventListener('click', resetLoginForms);
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    if (loginModal) loginModal.style.display = 'none';
                    resetLoginForms();
                }
            });
        }
        
        async function performSearch(query) {
            isSearchResultsView = true;
            currentSongs = await searchMusic(query, 'musicTrack', 50);
            renderSongs(currentSongs);
        }
        
        function addSongToPlaylist(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song) {
                if (!playlist.some(s => s.id == songId)) {
                    playlist.push({...song});
                    currentPlaylistPage = 1;
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                    
                    if (currentUser) saveUserPlaylistToFirestore();
                    else saveUserPlaylistToLocal();
                } else {
                    showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
                }
            } else {
                showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
            }
        }
        
        function removeSongFromPlaylist(index) {
            if (index >= 0 && index < playlist.length) {
                const songTitle = playlist[index].title;
                playlist.splice(index, 1);
                
                const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
                if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                    currentPlaylistPage--;
                }
                
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }
        
        function previewSong(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song && song.previewUrl) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                currentAudio = new Audio(song.previewUrl);
                currentAudio.play();
                isPlaying = true;
                if (playPauseBtn) playPauseBtn.textContent = "â¸ï¸";
                
                if (audioPlayer) audioPlayer.classList.remove('hidden');
                if (audioInfo) audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
                showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
                
                currentAudio.addEventListener('ended', () => {
                    stopAudio();
                });
            } else {
                showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
            }
        }
        
        function togglePlayPause() {
            if (currentAudio) {
                if (isPlaying) {
                    currentAudio.pause();
                    if (playPauseBtn) playPauseBtn.textContent = "â–¶ï¸";
                } else {
                    currentAudio.play();
                    if (playPauseBtn) playPauseBtn.textContent = "â¸ï¸";
                }
                isPlaying = !isPlaying;
            }
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isPlaying = false;
                if (playPauseBtn) playPauseBtn.textContent = "â–¶ï¸";
                if (audioPlayer) audioPlayer.classList.add('hidden');
            }
        }
        
        function clearPlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
                playlist = [];
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage('æ­Œå•å·²æ¸…ç©º');
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }
        
        function sharePlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«');
                return;
            }
            
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œåˆ†äº«æ­Œå•');
                if (loginModal) loginModal.style.display = 'flex';
                return;
            }
            
            showOrderPage();
        }
        
        function showOrderPage() {
            showPage('order');
            setActiveNav(null);
            
            // è‡ªåŠ¨å¡«å……ç”¨æˆ·ä¿¡æ¯
            if (currentUser) {
                const customerEmail = document.getElementById('customer-email');
                const customerName = document.getElementById('customer-name');
                
                if (customerEmail) customerEmail.value = currentUser.email || '';
                if (customerName && currentUser.displayName) {
                    customerName.value = currentUser.displayName;
                }
            }
            
            renderOrderPlaylistPreview();
            calculateAndDisplayPrice();
        }
        
        function renderOrderPlaylistPreview() {
            const previewContainer = document.getElementById('order-playlist-preview');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
                return;
            }
            
            const displaySongs = playlist.slice(0, 10);
            
            displaySongs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'playlist-preview-item';
                songElement.textContent = `${index + 1}. ${song.title} - ${song.artist}`;
                previewContainer.appendChild(songElement);
            });
            
            if (playlist.length > 10) {
                const moreElement = document.createElement('div');
                moreElement.className = 'playlist-preview-item';
                moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 10} é¦–æ­Œæ›²`;
                moreElement.style.fontStyle = 'italic';
                previewContainer.appendChild(moreElement);
            }
            
            const countElement = document.createElement('div');
            countElement.className = 'playlist-preview-item';
            countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
            countElement.style.fontWeight = 'bold';
            countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
            countElement.style.paddingTop = '10px';
            countElement.style.marginTop = '10px';
            previewContainer.appendChild(countElement);
        }
        
        function calculateAndDisplayPrice() {
            const songCount = playlist.length;
            const stateSelect = document.getElementById('customer-state');
            const state = stateSelect ? stateSelect.value : 'west';
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const priceSummary = document.getElementById('price-summary');
            if (priceSummary) {
                priceSummary.innerHTML = `
                    <div class="price-row">
                        <span>æ¨èé…å¥—ï¼š</span>
                        <span>${packageName} (${songCount}é¦–)</span>
                    </div>
                    <div class="price-row">
                        <span>é…å¥—ä»·æ ¼ï¼š</span>
                        <span>${packageName === 'è‡ªå®šä¹‰ç‰ˆ' ? `RM${packagePrice.toFixed(2)}` : `RM${packagePrice.toFixed(2)}`}</span>
                    </div>
                    <div class="price-row">
                        <span>é‚®è´¹ï¼š</span>
                        <span>${shippingFee === 0 ? 'å…è´¹' : `RM${shippingFee.toFixed(2)}`}</span>
                    </div>
                    <div class="price-row total-price">
                        <span>æ€»è´¹ç”¨ï¼š</span>
                        <span>RM${totalPrice.toFixed(2)}</span>
                    </div>
                    ${packageName === 'è‡ªå®šä¹‰ç‰ˆ' ? `
                    <div class="price-row" style="color: #ffd700; font-size: 0.9rem;">
                        <span>å¤‡æ³¨ï¼š</span>
                        <span>è‡ªå®šä¹‰é…å¥—è¯·è”ç³»å®¢æœç¡®è®¤æœ€ç»ˆä»·æ ¼</span>
                    </div>
                    ` : ''}
                `;
            }
        }
        
        function setupDragAndDrop() {
            const items = playlistContainer ? playlistContainer.querySelectorAll('.playlist-item') : [];
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
            
            if (playlistContainer) {
                playlistContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(playlistContainer, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (draggable && afterElement) {
                        playlistContainer.insertBefore(draggable, afterElement);
                    } else if (draggable) {
                        playlistContainer.appendChild(draggable);
                    }
                });
                
                playlistContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const items = Array.from(playlistContainer.querySelectorAll('.playlist-item'));
                    const toIndex = items.findIndex(item => item.classList.contains('dragging'));
                    
                    if (fromIndex !== toIndex && toIndex !== -1) {
                        const [movedItem] = playlist.splice(fromIndex, 1);
                        playlist.splice(toIndex, 0, movedItem);
                        
                        renderPlaylist();
                        showMessage('æ­Œå•é¡ºåºå·²æ›´æ–°');
                        
                        if (currentUser) saveUserPlaylistToFirestore();
                        else saveUserPlaylistToLocal();
                    }
                });
            }
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updatePlaylistCount() {
            if (playlistCount) {
                playlistCount.textContent = `(${playlist.length})`;
            }
        }
        
        function showMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                z-index: 1000;
                transition: all 0.3s;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }
        
        function showLoading(message) {
            if (songsContainer) {
                songsContainer.innerHTML = `<div class="loading">${message}</div>`;
            }
        }
        
        function showError(message) {
            if (songsContainer) {
                songsContainer.innerHTML = `<div class="error">${message}</div>`;
            }
        }
        
        // ==================== è®¢å•åŠŸèƒ½ ====================
        function initOrderFunctions() {
            const customerState = document.getElementById('customer-state');
            const cancelOrderBtn = document.getElementById('cancel-order');
            const submitOrderBtn = document.getElementById('submit-order');
            
            if (customerState) {
                customerState.addEventListener('change', calculateAndDisplayPrice);
            }
            
            if (cancelOrderBtn) {
                cancelOrderBtn.addEventListener('click', function() {
                    showPage('karaoke');
                    setActiveNav(document.getElementById('karaoke-nav'));
                });
            }
            
            if (submitOrderBtn) {
                submitOrderBtn.addEventListener('click', async function() {
                    const nameInput = document.getElementById('customer-name');
                    const phoneInput = document.getElementById('customer-phone');
                    const emailInput = document.getElementById('customer-email');
                    const addressInput = document.getElementById('customer-address');
                    const stateSelect = document.getElementById('customer-state');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    const phone = phoneInput ? phoneInput.value.trim() : '';
                    const email = emailInput ? emailInput.value.trim() : '';
                    const address = addressInput ? addressInput.value.trim() : '';
                    const state = stateSelect ? stateSelect.value : '';
                    
                    if (!name || !phone || !email || !address || !state) {
                        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                        return;
                    }
                    
                    const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
                    if (!malaysiaPhoneRegex.test(phone)) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
                        return;
                    }
                    
                    await createOrder(name, phone, email, address, state);
                });
            }
        }
        
        async function createOrder(name, phone, email, address, state) {
            const songCount = playlist.length;
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const orderId = 'KTV' + new Date().getTime();
            
            // ä¿®å¤ï¼šç¡®ä¿ pricing å¯¹è±¡å®Œæ•´
            const pricing = {
                package: packageName || 'æœªçŸ¥é…å¥—',
                songCount: songCount || 0,
                packagePrice: packagePrice || 0,
                shippingFee: shippingFee || 0,
                totalPrice: totalPrice || 0  // ç¡®ä¿è¿™ä¸ªå­—æ®µä¸€å®šå­˜åœ¨ä¸”æœ‰å€¼
            };

            // ä¿®å¤ï¼šç¡®ä¿è®¢å•æ•°æ®å®Œæ•´
            const order = {
                orderId: orderId,
                customerInfo: {
                    name: name || 'æœªçŸ¥å®¢æˆ·',
                    phone: phone || 'æœªæä¾›',
                    email: email || '',
                    address: address || 'æœªæä¾›',
                    state: state || 'west'
                },
                playlist: [...playlist],
                pricing: pricing,  // ä½¿ç”¨å®Œæ•´çš„ pricing å¯¹è±¡
                orderDate: new Date().toISOString(),
                status: 'pending',
                userId: currentUser ? currentUser.uid : null
            };

            try {
                // ä¿å­˜åˆ° Firestore
                await firestore.collection('orders').doc(orderId).set(order);
                console.log('âœ… è®¢å•å·²ä¿å­˜åˆ° Firestore');
                
                alert(`âœ… è®¢å•æäº¤æˆåŠŸï¼\nè®¢å•ç¼–å·: ${order.orderId}\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
                
                // æ¸…ç©ºæ­Œå•
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                if (currentUser) saveUserPlaylistToFirestore();
                
                showPage('karaoke');
                setActiveNav(document.getElementById('karaoke-nav'));
                
            } catch (error) {
                console.error('è®¢å•æäº¤å¤±è´¥:', error);
                alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
            }
        }

        // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            initKaraoke();
        });
    </script>
</body>
</html>
