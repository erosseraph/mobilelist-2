<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šåˆ¶ä½ çš„ä¸“å±æ­Œå…</title>
    
    <!-- PWA é…ç½® -->
    <meta name="theme-color" content="#1a2a6c">
    <meta name="description" content="ä¸“ä¸šæ­Œå…å®šåˆ¶æœåŠ¡ï¼Œæ‰“é€ æ‚¨çš„ä¸“å±éŸ³ä¹ç©ºé—´">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ­Œå…å®šåˆ¶">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- è‹¹æœ Touch å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <!-- é…ç½®åŠ è½½ -->
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>
    
    <style>
        /* ä¿æŒæ‰€æœ‰åŸæœ‰æ ·å¼ä¸å˜ */
        /* ... ä½ çš„å®Œæ•´CSSæ ·å¼ ... */
    </style>
</head>
<body>
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <!-- ... ç™»å½•æ¨¡æ€æ¡†å†…å®¹ä¿æŒä¸å˜ ... -->
    </div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <!-- ... å¯¼èˆªæ å†…å®¹ä¿æŒä¸å˜ ... -->
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- ç‚¹æ­Œç³»ç»Ÿé¡µé¢ -->
            <div id="karaoke-page">
                <!-- ... ç‚¹æ­Œé¡µé¢å†…å®¹ä¿æŒä¸å˜ ... -->
            </div>
            
            <!-- ä»·æ ¼é…å¥—é¡µé¢ -->
            <div id="pricing-page">
                <!-- ... ä»·æ ¼é¡µé¢å†…å®¹ä¿æŒä¸å˜ ... -->
            </div>
            
            <!-- è®¢å•é¡µé¢ -->
            <div id="order-page">
                <!-- ... è®¢å•é¡µé¢å†…å®¹ä¿æŒä¸å˜ ... -->
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯æµ®åŠ¨æ­Œå•æŒ‰é’® -->
    <button class="mobile-playlist-fab" id="mobile-playlist-fab">
        ğŸµ
        <div class="mobile-playlist-badge" id="mobile-playlist-badge">0</div>
    </button>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-bottom-bar">
        <button class="mobile-bottom-btn active" data-page="karaoke">
            <span style="font-size: 1.2rem;">ğŸ¤</span>
            <span>ç‚¹æ­Œ</span>
        </button>
        <button class="mobile-bottom-btn" data-page="pricing">
            <span style="font-size: 1.2rem;">ğŸ’°</span>
            <span>ä»·æ ¼</span>
        </button>
        <button class="mobile-bottom-btn" onclick="showOrderPage()">
            <span style="font-size: 1.2rem;">ğŸ›’</span>
            <span>è®¢å•</span>
        </button>
    </div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player hidden" id="audio-player">
        <div class="audio-info" id="audio-info">è¯•å¬ä¸­...</div>
        <div class="audio-controls">
            <button id="play-pause-btn">â¸ï¸</button>
            <button id="stop-btn">â¹ï¸</button>
        </div>
    </div>

    <script>
        // ==================== Firebase åˆå§‹åŒ– ====================
        let firebaseApp, auth, firestore;
        
        function initializeFirebase() {
            try {
                // ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®
                const firebaseConfig = getFirebaseConfig();
                console.log('ğŸ”§ Firebase é…ç½®:', firebaseConfig);
                
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebaseApp.auth();
                firestore = firebaseApp.firestore();
                console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬
                auth.onAuthStateChanged(handleAuthStateChange);
            } catch (error) {
                console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ==================== ç§»åŠ¨ç«¯åŠŸèƒ½åˆå§‹åŒ– ====================
        function initMobileFeatures() {
            const fab = document.getElementById('mobile-playlist-fab');
            const badge = document.getElementById('mobile-playlist-badge');
            
            // ç‚¹å‡»æµ®åŠ¨æŒ‰é’®æ˜¾ç¤ºæ­Œå•
            fab.addEventListener('click', () => {
                document.querySelector('.playlist-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            });
            
            // æ›´æ–°æ­Œå•å¾½ç« 
            function updatePlaylistBadge() {
                const count = playlist.length;
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
            
            // ç›‘å¬æ­Œå•å˜åŒ–
            const originalUpdatePlaylistCount = updatePlaylistCount;
            updatePlaylistCount = function() {
                originalUpdatePlaylistCount();
                updatePlaylistBadge();
            };
            
            // åº•éƒ¨å¯¼èˆªåŠŸèƒ½
            document.querySelectorAll('.mobile-bottom-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    
                    // æ›´æ–°æ´»è·ƒçŠ¶æ€
                    document.querySelectorAll('.mobile-bottom-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // åˆ‡æ¢é¡µé¢
                    if (page === 'karaoke') {
                        showPage('karaoke');
                        setActiveNav(document.getElementById('karaoke-nav'));
                    } else if (page === 'pricing') {
                        showPage('pricing');
                        setActiveNav(document.getElementById('pricing-nav'));
                    }
                });
            });
            
            // åˆå§‹åŒ–å¾½ç« 
            updatePlaylistBadge();
        }

        // ==================== PWA Service Worker æ³¨å†Œ ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('âœ… ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('âŒ ServiceWorker æ³¨å†Œå¤±è´¥: ', error);
                    });
            });
        }

        // ==================== è®¤è¯çŠ¶æ€ç®¡ç† ====================
        function handleAuthStateChange(user) {
            if (user) {
                console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', user.email);
                currentUser = user;
                updateUserUI();
                loadUserPlaylistFromFirestore();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†é¢æ¿é“¾æ¥
                checkAdminAccess(user);
            } else {
                console.log('âŒ ç”¨æˆ·å·²é€€å‡º');
                currentUser = null;
                updateUserUI();
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                
                // éšè—ç®¡ç†é¢æ¿é“¾æ¥
                document.getElementById('admin-section').style.display = 'none';
            }
        }

        // ==================== ç®¡ç†å‘˜æƒé™æ£€æŸ¥ ====================
        function checkAdminAccess(user) {
            // è¿™é‡Œå¯ä»¥è®¾ç½®ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨
            const adminEmails = [
                'admin@karaoke.com',
                'erosseraph@gmail.com'
            ];
            
            if (adminEmails.includes(user.email)) {
                document.getElementById('admin-section').style.display = 'block';
                console.log('ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²æˆäºˆ');
            } else {
                document.getElementById('admin-section').style.display = 'none';
            }
        }

        // ==================== ç”¨æˆ·è®¤è¯åŠŸèƒ½ ====================
        let currentUser = null;
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn');
        const closeLoginBtn = document.getElementById('close-login');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const userAvatar = document.getElementById('user-avatar');
        const logoutBtn = document.getElementById('logout-btn');

        // ç™»å½•æ–¹å¼æŒ‰é’®
        const emailLoginBtn = document.getElementById('email-login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');

        // ç™»å½•è¡¨å•
        const emailLoginForm = document.getElementById('email-login-form');
        const emailLoginSubmit = document.getElementById('email-login-submit');
        const emailRegisterSubmit = document.getElementById('email-register-submit');

        function updateUserUI() {
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                
                userAvatar.textContent = initial;
                userEmail.textContent = displayName;
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
            }
        }

        async function handleEmailLogin() {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                showMessage(`æ¬¢è¿å›æ¥ï¼Œ${result.user.email}`);
                loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±ç™»å½•å¤±è´¥:', error);
                showMessage(`ç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleEmailRegister() {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }

            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                return;
            }

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                showMessage(`æ³¨å†ŒæˆåŠŸï¼Œæ¬¢è¿ ${result.user.email}`);
                loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('é‚®ç®±æ³¨å†Œå¤±è´¥:', error);
                showMessage(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            }
        }

        async function handleGoogleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showMessage(`æ¬¢è¿ï¼Œ${result.user.displayName}`);
                loginModal.style.display = 'none';
                resetLoginForms();
            } catch (error) {
                console.error('Googleç™»å½•å¤±è´¥:', error);
                showMessage(`Googleç™»å½•å¤±è´¥: ${error.message}`);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                showMessage('å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMessage('é€€å‡ºç™»å½•å¤±è´¥');
            }
        }

        function resetLoginForms() {
            document.getElementById('email-input').value = '';
            document.getElementById('password-input').value = '';
            emailLoginForm.style.display = 'none';
            document.querySelector('.login-methods').style.display = 'flex';
            document.getElementById('login-loading').style.display = 'none';
        }

        function showLoginMethod(method) {
            document.querySelector('.login-methods').style.display = 'none';
            if (method === 'email') {
                emailLoginForm.style.display = 'block';
            }
        }

        // ==================== Firestore æ•°æ®ç®¡ç† ====================
        async function saveUserPlaylistToFirestore() {
            if (!currentUser) return;

            try {
                await firestore.collection('playlists').doc(currentUser.uid).set({
                    songs: playlist,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    songCount: playlist.length,
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                console.log('âœ… æ­Œå•å·²ä¿å­˜åˆ° Firestore');
            } catch (error) {
                console.error('ä¿å­˜æ­Œå•åˆ° Firestore å¤±è´¥:', error);
                saveUserPlaylistToLocal();
            }
        }

        async function loadUserPlaylistFromFirestore() {
            if (!currentUser) return;

            try {
                const doc = await firestore.collection('playlists').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    playlist = data.songs || [];
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage('å·²ä»äº‘ç«¯åŠ è½½æ‚¨çš„æ­Œå•');
                }
            } catch (error) {
                console.error('ä» Firestore åŠ è½½æ­Œå•å¤±è´¥:', error);
                loadUserPlaylistFromLocal();
            }
        }

        function saveUserPlaylistToLocal() {
            if (!currentUser) return;
            try {
                localStorage.setItem(`playlist_${currentUser.uid}`, JSON.stringify(playlist));
            } catch (e) {
                console.error('ä¿å­˜æ­Œå•åˆ°æœ¬åœ°å¤±è´¥:', e);
            }
        }

        function loadUserPlaylistFromLocal() {
            if (!currentUser) return;
            const savedPlaylist = localStorage.getItem(`playlist_${currentUser.uid}`);
            if (savedPlaylist) {
                try {
                    playlist = JSON.parse(savedPlaylist);
                    renderPlaylist();
                    updatePlaylistCount();
                } catch (e) {
                    console.error('ä»æœ¬åœ°åŠ è½½æ­Œå•å¤±è´¥:', e);
                }
            }
        }

        // ==================== é¡µé¢åˆ‡æ¢åŠŸèƒ½ ====================
        document.getElementById('karaoke-nav').addEventListener('click', function() {
            showPage('karaoke');
            setActiveNav(this);
        });
        
        document.getElementById('pricing-nav').addEventListener('click', function() {
            showPage('pricing');
            setActiveNav(this);
        });
        
        function showPage(page) {
            document.getElementById('karaoke-page').style.display = page === 'karaoke' ? 'flex' : 'none';
            document.getElementById('pricing-page').style.display = page === 'pricing' ? 'block' : 'none';
            document.getElementById('order-page').style.display = page === 'order' ? 'block' : 'none';
        }
        
        function setActiveNav(activeButton) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
        
        // ==================== ä»·æ ¼é…å¥—åŠŸèƒ½ ====================
        document.querySelectorAll('.select-btn').forEach(button => {
            button.addEventListener('click', function() {
                const planName = this.closest('.pricing-card').querySelector('.plan-name').textContent;
                const price = this.closest('.pricing-card').querySelector('.price').textContent;
                alert(`æ‚¨é€‰æ‹©äº† ${planName} é…å¥—\nä»·æ ¼: ${price}\n\nè¯·ç‚¹å‡»"åˆ†äº«æ­Œå•"æäº¤è®¢å•ã€‚`);
            });
        });
        
        // ==================== ç‚¹æ­Œç³»ç»ŸåŠŸèƒ½ ====================
        let currentSongs = [];
        let playlist = [];
        let currentAudio = null;
        let isPlaying = false;
        let isSearchResultsView = false;
        let currentPlaylistPage = 1;
        const SONGS_PER_PAGE = 10;
        
        const chartsContainer = document.getElementById('charts-container');
        const songsContainer = document.getElementById('songs-container');
        const playlistContainer = document.getElementById('playlist-items');
        const playlistPagination = document.getElementById('playlist-pagination');
        const playlistCount = document.getElementById('playlist-count');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearBtn = document.getElementById('clear-btn');
        const shareBtn = document.getElementById('share-btn');
        const audioPlayer = document.getElementById('audio-player');
        const audioInfo = document.getElementById('audio-info');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        function initKaraoke() {
            setupEventListeners();
            updatePlaylistCount();
            loadChart('chinese-pop');
            initMobileFeatures(); // åˆå§‹åŒ–ç§»åŠ¨ç«¯åŠŸèƒ½
        }
        
        // ==================== æ”¹è¿›çš„éŸ³ä¹æœç´¢åŠŸèƒ½ ====================
        async function searchMusic(term, category = 'musicTrack', limit = 50) {
            try {
                showLoading('æ­£åœ¨æœç´¢...');
                
                // æ”¹è¿›æœç´¢URLï¼Œä½¿ç”¨ä¸­æ–‡å…³é”®è¯å’Œæ›´ç²¾ç¡®çš„å‚æ•°
                const encodedTerm = encodeURIComponent(term);
                const url = `https://itunes.apple.com/search?term=${encodedTerm}&entity=${category}&limit=${limit}&country=CN&lang=zh_cn`;
                
                console.log(`ğŸ” æœç´¢: ${term}, URL: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                console.log(`ğŸ“Š æœç´¢ç»“æœ: ${data.resultCount} æ¡`);
                
                if (data.resultCount === 0) {
                    showError('æœªæ‰¾åˆ°ç›¸å…³ç»“æœ');
                    return [];
                }
                
                // æ”¹è¿›ç»“æœè¿‡æ»¤
                const filteredResults = data.results.map(track => ({
                    id: track.trackId || Math.random().toString(36).substr(2, 9),
                    title: track.trackName || 'æœªçŸ¥æ­Œæ›²',
                    artist: track.artistName || 'æœªçŸ¥æ­Œæ‰‹',
                    album: track.collectionName || 'æœªçŸ¥ä¸“è¾‘',
                    duration: track.trackTimeMillis,
                    previewUrl: track.previewUrl,
                    artwork: track.artworkUrl100
                })).filter(track => {
                    // è¿‡æ»¤æ‰æ²¡æœ‰é¢„è§ˆçš„æ­Œæ›²å’Œæ˜æ˜¾ä¸ç›¸å…³çš„å†…å®¹
                    return track.previewUrl && 
                           !track.title.toLowerCase().includes('instrumental') &&
                           !track.title.toLowerCase().includes('karaoke') &&
                           !track.artist.toLowerCase().includes('instrumental');
                });
                
                console.log(`ğŸµ è¿‡æ»¤åç»“æœ: ${filteredResults.length} é¦–æ­Œæ›²`);
                return filteredResults;
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
                return [];
            }
        }
        
        // ==================== æ”¹è¿›çš„æ’è¡Œæ¦œåŠ è½½ ====================
        async function loadChart(category) {
            isSearchResultsView = false;
            let searchTerm = '';
            let entityType = 'musicTrack';
            let limit = 50;
            
            // æ”¹è¿›æœç´¢ç­–ç•¥ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„ä¸­æ–‡å…³é”®è¯
            switch(category) {
                case 'chinese-pop':
                    searchTerm = 'åè¯­æµè¡Œ å‘¨æ°ä¼¦ æ—ä¿Šæ° é‚“ç´«æ£‹ è–›ä¹‹è°¦ ç‹åŠ›å® åè¯­é‡‘æ›²';
                    break;
                case 'western-pop':
                    searchTerm = 'pop Taylor+Swift Ed+Sheeran Ariana+Grande Justin+Bieber Billie+Eilish';
                    break;
                case 'chinese-dj':
                    searchTerm = 'ä¸­æ–‡DJ æ··éŸ³ Remix æŠ–éŸ³çƒ­æ­Œ ç”µéŸ³ å¤œåº—';
                    entityType = 'musicTrack';
                    limit = 40;
                    break;
                case 'chinese-artists':
                    renderArtistsList([
                        'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'è–›ä¹‹è°¦', 'æè£æµ©', 
                        'ç‹åŠ›å®', 'é™ˆå¥•è¿…', 'å¼ æƒ å¦¹', 'è”¡ä¾æ—', 'å­™ç‡•å§¿',
                        'äº”æœˆå¤©', 'å¼ å­¦å‹', 'åˆ˜å¾·å', 'ç‹è²', 'å¼ æ°'
                    ]);
                    return;
                case 'western-artists':
                    renderArtistsList([
                        'Taylor Swift', 'Ed Sheeran', 'Ariana Grande', 'Justin Bieber', 'Billie Eilish',
                        'Drake', 'The Weeknd', 'Dua Lipa', 'Post Malone', 'Bruno Mars'
                    ]);
                    return;
            }
            
            currentSongs = await searchMusic(searchTerm, entityType, limit);
            
            // å¦‚æœç»“æœå¤ªå°‘ï¼Œå°è¯•å¤‡ç”¨æœç´¢è¯
            if (currentSongs.length < 10) {
                console.log('ğŸ” ç»“æœè¾ƒå°‘ï¼Œå°è¯•å¤‡ç”¨æœç´¢è¯...');
                let backupSearchTerm = '';
                
                switch(category) {
                    case 'chinese-pop':
                        backupSearchTerm = 'ä¸­æ–‡æ­Œæ›² åè¯­éŸ³ä¹ æµè¡Œæ­Œæ›²';
                        break;
                    case 'chinese-dj':
                        backupSearchTerm = 'ä¸­æ–‡èˆæ›² ç”µå­éŸ³ä¹ æ´¾å¯¹æ­Œæ›²';
                        break;
                }
                
                if (backupSearchTerm) {
                    const backupResults = await searchMusic(backupSearchTerm, entityType, 20);
                    // åˆå¹¶ç»“æœï¼Œå»é‡
                    const existingIds = new Set(currentSongs.map(song => song.id));
                    backupResults.forEach(song => {
                        if (!existingIds.has(song.id)) {
                            currentSongs.push(song);
                        }
                    });
                }
            }
            
            renderSongs(currentSongs);
            
            document.querySelectorAll('.chart-category').forEach(chart => {
                chart.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
        }
        
        function renderArtistsList(artists) {
            songsContainer.innerHTML = '';
            artists.forEach(artist => {
                const artistElement = document.createElement('div');
                artistElement.className = 'song';
                artistElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${artist}</div>
                        <div class="song-artist">æ­Œæ‰‹</div>
                    </div>
                    <div class="song-controls">
                        <button class="add-btn" data-artist="${artist}">æœç´¢</button>
                    </div>
                `;
                songsContainer.appendChild(artistElement);
            });
        }
        
        function renderSongs(songs) {
            songsContainer.innerHTML = '';
            
            if (songs.length === 0) {
                songsContainer.innerHTML = '<div class="empty-playlist">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                return;
            }
            
            if (isSearchResultsView) {
                const backButton = document.createElement('button');
                backButton.className = 'back-btn';
                backButton.textContent = 'â† è¿”å›æ’è¡Œæ¦œ';
                backButton.addEventListener('click', () => {
                    isSearchResultsView = false;
                    loadChart('chinese-pop');
                });
                songsContainer.appendChild(backButton);
            }
            
            songs.forEach(song => {
                const songElement = document.createElement('div');
                songElement.className = 'song';
                songElement.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-album">${song.album}</div>
                    </div>
                    <div class="song-controls">
                        ${song.previewUrl ? `<button class="preview-btn" data-id="${song.id}">â–¶ï¸</button>` : ''}
                        <button class="add-btn" data-id="${song.id}">+</button>
                    </div>
                `;
                songsContainer.appendChild(songElement);
            });
        }
        
        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                playlistContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©ºï¼Œè¯·ä»å·¦ä¾§æ·»åŠ æ­Œæ›²</div>';
                renderPlaylistPagination();
                return;
            }
            
            const startIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
            const endIndex = Math.min(startIndex + SONGS_PER_PAGE, playlist.length);
            const currentSongs = playlist.slice(startIndex, endIndex);
            
            currentSongs.forEach((song, index) => {
                const globalIndex = startIndex + index;
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.draggable = true;
                playlistItem.dataset.index = globalIndex;
                playlistItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="song-number">${globalIndex + 1}</div>
                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${globalIndex}">Ã—</button>
                `;
                playlistContainer.appendChild(playlistItem);
            });
            
            renderPlaylistPagination();
            setupDragAndDrop();
        }
        
        function renderPlaylistPagination() {
            playlistPagination.innerHTML = '';
            
            if (playlist.length <= SONGS_PER_PAGE) return;
            
            const totalPages = Math.ceil(playlist.length / SONGS_PER_PAGE);
            
            if (currentPlaylistPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                prevButton.addEventListener('click', () => {
                    currentPlaylistPage--;
                    renderPlaylist();
                });
                playlistPagination.appendChild(prevButton);
            }
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPlaylistPage);
                pageButton.addEventListener('click', () => {
                    currentPlaylistPage = i;
                    renderPlaylist();
                });
                playlistPagination.appendChild(pageButton);
            }
            
            if (currentPlaylistPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                nextButton.addEventListener('click', () => {
                    currentPlaylistPage++;
                    renderPlaylist();
                });
                playlistPagination.appendChild(nextButton);
            }
        }
        
        function setupEventListeners() {
            chartsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('chart-category')) {
                    const category = e.target.dataset.category;
                    loadChart(category);
                }
            });
            
            songsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-btn')) {
                    const songId = e.target.dataset.id;
                    const artist = e.target.dataset.artist;
                    
                    if (artist) {
                        performSearch(artist);
                    } else if (songId) {
                        addSongToPlaylist(songId);
                    }
                } else if (e.target.classList.contains('preview-btn')) {
                    const songId = e.target.dataset.id;
                    previewSong(songId);
                }
            });
            
            playlistContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    removeSongFromPlaylist(index);
                }
            });
            
            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) performSearch(query);
            });
            
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value.trim();
                    if (query) performSearch(query);
                }
            });
            
            clearBtn.addEventListener('click', clearPlaylist);
            shareBtn.addEventListener('click', sharePlaylist);
            playPauseBtn.addEventListener('click', togglePlayPause);
            stopBtn.addEventListener('click', stopAudio);
            
            // è®¤è¯ç›¸å…³äº‹ä»¶
            loginBtn.addEventListener('click', () => loginModal.style.display = 'flex');
            closeLoginBtn.addEventListener('click', () => {
                loginModal.style.display = 'none';
                resetLoginForms();
            });
            emailLoginBtn.addEventListener('click', () => showLoginMethod('email'));
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            emailLoginSubmit.addEventListener('click', handleEmailLogin);
            emailRegisterSubmit.addEventListener('click', handleEmailRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            document.querySelectorAll('.back-to-methods').forEach(btn => {
                btn.addEventListener('click', resetLoginForms);
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    loginModal.style.display = 'none';
                    resetLoginForms();
                }
            });
        }
        
        async function performSearch(query) {
            isSearchResultsView = true;
            currentSongs = await searchMusic(query, 'musicTrack', 50);
            renderSongs(currentSongs);
        }
        
        function addSongToPlaylist(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song) {
                if (!playlist.some(s => s.id == songId)) {
                    playlist.push({...song});
                    currentPlaylistPage = 1;
                    renderPlaylist();
                    updatePlaylistCount();
                    showMessage(`å·²æ·»åŠ  "${song.title}" åˆ°æ­Œå•`);
                    
                    if (currentUser) saveUserPlaylistToFirestore();
                    else saveUserPlaylistToLocal();
                } else {
                    showMessage(`"${song.title}" å·²åœ¨æ­Œå•ä¸­`);
                }
            } else {
                showMessage('æ‰¾ä¸åˆ°è¯¥æ­Œæ›²ï¼Œè¯·é‡è¯•');
            }
        }
        
        function removeSongFromPlaylist(index) {
            if (index >= 0 && index < playlist.length) {
                const songTitle = playlist[index].title;
                playlist.splice(index, 1);
                
                const currentPageStartIndex = (currentPlaylistPage - 1) * SONGS_PER_PAGE;
                if (playlist.length <= currentPageStartIndex && currentPlaylistPage > 1) {
                    currentPlaylistPage--;
                }
                
                renderPlaylist();
                updatePlaylistCount();
                showMessage(`å·²ä»æ­Œå•ç§»é™¤ "${songTitle}"`);
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }
        
        function previewSong(songId) {
            const song = currentSongs.find(s => s.id == songId);
            
            if (song && song.previewUrl) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                currentAudio = new Audio(song.previewUrl);
                currentAudio.play();
                isPlaying = true;
                playPauseBtn.textContent = "â¸ï¸";
                
                audioPlayer.classList.remove('hidden');
                audioInfo.textContent = `è¯•å¬: ${song.title} - ${song.artist}`;
                showMessage(`å¼€å§‹è¯•å¬ "${song.title}"`);
                
                currentAudio.addEventListener('ended', () => {
                    stopAudio();
                });
            } else {
                showMessage('è¯¥æ­Œæ›²æš‚æ— è¯•å¬åŠŸèƒ½');
            }
        }
        
        function togglePlayPause() {
            if (currentAudio) {
                if (isPlaying) {
                    currentAudio.pause();
                    playPauseBtn.textContent = "â–¶ï¸";
                } else {
                    currentAudio.play();
                    playPauseBtn.textContent = "â¸ï¸";
                }
                isPlaying = !isPlaying;
            }
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                isPlaying = false;
                playPauseBtn.textContent = "â–¶ï¸";
                audioPlayer.classList.add('hidden');
            }
        }
        
        function clearPlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•å·²ç»æ˜¯ç©ºçš„');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ­Œå•å—ï¼Ÿ')) {
                playlist = [];
                currentPlaylistPage = 1;
                renderPlaylist();
                updatePlaylistCount();
                showMessage('æ­Œå•å·²æ¸…ç©º');
                
                if (currentUser) saveUserPlaylistToFirestore();
                else saveUserPlaylistToLocal();
            }
        }
        
        function sharePlaylist() {
            if (playlist.length === 0) {
                showMessage('æ­Œå•ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«');
                return;
            }
            
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ä»¥ä¿å­˜å’Œåˆ†äº«æ­Œå•');
                loginModal.style.display = 'flex';
                return;
            }
            
            showOrderPage();
        }
        
        function showOrderPage() {
            showPage('order');
            setActiveNav(null);
            
            // è‡ªåŠ¨å¡«å……ç”¨æˆ·ä¿¡æ¯
            if (currentUser) {
                document.getElementById('customer-email').value = currentUser.email || '';
                if (currentUser.displayName) {
                    document.getElementById('customer-name').value = currentUser.displayName;
                }
            }
            
            renderOrderPlaylistPreview();
            calculateAndDisplayPrice();
        }
        
        function renderOrderPlaylistPreview() {
            const previewContainer = document.getElementById('order-playlist-preview');
            previewContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                previewContainer.innerHTML = '<div class="empty-playlist">æ­Œå•ä¸ºç©º</div>';
                return;
            }
            
            const displaySongs = playlist.slice(0, 10);
            
            displaySongs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'playlist-preview-item';
                songElement.textContent = `${index + 1}. ${song.title} - ${song.artist}`;
                previewContainer.appendChild(songElement);
            });
            
            if (playlist.length > 10) {
                const moreElement = document.createElement('div');
                moreElement.className = 'playlist-preview-item';
                moreElement.textContent = `... è¿˜æœ‰ ${playlist.length - 10} é¦–æ­Œæ›²`;
                moreElement.style.fontStyle = 'italic';
                previewContainer.appendChild(moreElement);
            }
            
            const countElement = document.createElement('div');
            countElement.className = 'playlist-preview-item';
            countElement.textContent = `å…±è®¡ ${playlist.length} é¦–æ­Œæ›²`;
            countElement.style.fontWeight = 'bold';
            countElement.style.borderTop = '1px solid rgba(255,255,255,0.2)';
            countElement.style.paddingTop = '10px';
            countElement.style.marginTop = '10px';
            previewContainer.appendChild(countElement);
        }
        
        function calculateAndDisplayPrice() {
            const songCount = playlist.length;
            const state = document.getElementById('customer-state').value;
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const priceSummary = document.getElementById('price-summary');
            priceSummary.innerHTML = `
                <div class="price-row">
                    <span>æ¨èé…å¥—ï¼š</span>
                    <span>${packageName} (${songCount}é¦–)</span>
                </div>
                <div class="price-row">
                    <span>é…å¥—ä»·æ ¼ï¼š</span>
                    <span>RM${packagePrice.toFixed(2)}</span>
                </div>
                <div class="price-row">
                    <span>é‚®è´¹ï¼š</span>
                    <span>${shippingFee === 0 ? 'å…è´¹' : `RM${shippingFee.toFixed(2)}`}</span>
                </div>
                <div class="price-row total-price">
                    <span>æ€»è´¹ç”¨ï¼š</span>
                    <span>RM${totalPrice.toFixed(2)}</span>
                </div>
            `;
        }
        
        function setupDragAndDrop() {
            const items = playlistContainer.querySelectorAll('.playlist-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    setTimeout(() => item.classList.add('dragging'), 0);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
            });
            
            playlistContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(playlistContainer, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable && afterElement) {
                    playlistContainer.insertBefore(draggable, afterElement);
                } else if (draggable) {
                    playlistContainer.appendChild(draggable);
                }
            });
            
            playlistContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const items = Array.from(playlistContainer.querySelectorAll('.playlist-item'));
                const toIndex = items.findIndex(item => item.classList.contains('dragging'));
                
                if (fromIndex !== toIndex && toIndex !== -1) {
                    const [movedItem] = playlist.splice(fromIndex, 1);
                    playlist.splice(toIndex, 0, movedItem);
                    
                    renderPlaylist();
                    showMessage('æ­Œå•é¡ºåºå·²æ›´æ–°');
                    
                    if (currentUser) saveUserPlaylistToFirestore();
                    else saveUserPlaylistToLocal();
                }
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.playlist-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updatePlaylistCount() {
            playlistCount.textContent = `(${playlist.length})`;
        }
        
        function showMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                z-index: 1000;
                transition: all 0.3s;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }
        
        function showLoading(message) {
            songsContainer.innerHTML = `<div class="loading">${message}</div>`;
        }
        
        function showError(message) {
            songsContainer.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // ==================== è®¢å•åŠŸèƒ½ ====================
        document.getElementById('customer-state').addEventListener('change', calculateAndDisplayPrice);
        
        document.getElementById('cancel-order').addEventListener('click', function() {
            showPage('karaoke');
            setActiveNav(document.getElementById('karaoke-nav'));
        });
        
        document.getElementById('submit-order').addEventListener('click', async function() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const email = document.getElementById('customer-email').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            const state = document.getElementById('customer-state').value;
            
            if (!name || !phone || !email || !address || !state) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            const malaysiaPhoneRegex = /^\+60[0-9]{8,10}$/;
            if (!malaysiaPhoneRegex.test(phone)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é©¬æ¥è¥¿äºšç”µè¯å·ç ï¼ˆæ ¼å¼ï¼š+60xxxxxxxxï¼‰');
                return;
            }
            
            await createOrder(name, phone, email, address, state);
        });
        
        async function createOrder(name, phone, email, address, state) {
            const songCount = playlist.length;
            
            let packageName, packagePrice;
            if (songCount <= 20) {
                packageName = "åŸºç¡€ç‰ˆ"; packagePrice = 29;
            } else if (songCount <= 50) {
                packageName = "æ ‡å‡†ç‰ˆ"; packagePrice = 49;
            } else if (songCount <= 100) {
                packageName = "è¿›é˜¶ç‰ˆ"; packagePrice = 69;
            } else if (songCount <= 200) {
                packageName = "è±ªåç‰ˆ"; packagePrice = 89;
            } else if (songCount <= 300) {
                packageName = "ä¸“ä¸šç‰ˆ"; packagePrice = 109;
            } else if (songCount <= 400) {
                packageName = "æ——èˆ°ç‰ˆ"; packagePrice = 129;
            } else if (songCount <= 500) {
                packageName = "è‡³å°Šç‰ˆ"; packagePrice = 159;
            } else {
                packageName = "è‡ªå®šä¹‰ç‰ˆ"; packagePrice = songCount * 0.3;
            }
            
            let shippingFee = state === 'east' ? 8 : 0;
            const totalPrice = packagePrice + shippingFee;
            
            const orderId = 'KTV' + new Date().getTime();
            
            // ä¿®å¤ï¼šç¡®ä¿ pricing å¯¹è±¡å®Œæ•´
            const pricing = {
                package: packageName || 'æœªçŸ¥é…å¥—',
                songCount: songCount || 0,
                packagePrice: packagePrice || 0,
                shippingFee: shippingFee || 0,
                totalPrice: totalPrice || 0  // ç¡®ä¿è¿™ä¸ªå­—æ®µä¸€å®šå­˜åœ¨ä¸”æœ‰å€¼
            };

            // ä¿®å¤ï¼šç¡®ä¿è®¢å•æ•°æ®å®Œæ•´
            const order = {
                orderId: orderId,
                customerInfo: {
                    name: name || 'æœªçŸ¥å®¢æˆ·',
                    phone: phone || 'æœªæä¾›',
                    email: email || '',
                    address: address || 'æœªæä¾›',
                    state: state || 'west'
                },
                playlist: [...playlist],
                pricing: pricing,  // ä½¿ç”¨å®Œæ•´çš„ pricing å¯¹è±¡
                orderDate: new Date().toISOString(),
                status: 'pending',
                userId: currentUser ? currentUser.uid : null
            };

            try {
                // ä¿å­˜åˆ° Firestore
                await firestore.collection('orders').doc(orderId).set(order);
                console.log('âœ… è®¢å•å·²ä¿å­˜åˆ° Firestore');
                
                alert(`âœ… è®¢å•æäº¤æˆåŠŸï¼\nè®¢å•ç¼–å·: ${order.orderId}\næ€»è´¹ç”¨: RM${totalPrice.toFixed(2)}\n\næˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…ã€‚`);
                
                // æ¸…ç©ºæ­Œå•
                playlist = [];
                renderPlaylist();
                updatePlaylistCount();
                if (currentUser) saveUserPlaylistToFirestore();
                
                showPage('karaoke');
                setActiveNav(document.getElementById('karaoke-nav'));
                
            } catch (error) {
                console.error('è®¢å•æäº¤å¤±è´¥:', error);
                alert('è®¢å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ');
            }
        }

        // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            initKaraoke();
        });
    </script>
</body>
</html>